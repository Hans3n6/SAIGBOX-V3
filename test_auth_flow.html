<!DOCTYPE html>
<html>
<head>
    <title>Test OAuth Flow</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
        }
        .test-section {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .success {
            color: green;
            font-weight: bold;
        }
        .error {
            color: red;
            font-weight: bold;
        }
        button {
            padding: 10px 20px;
            margin: 10px;
            cursor: pointer;
        }
        pre {
            background: #f4f4f4;
            padding: 10px;
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <h1>OAuth Flow Test</h1>
    
    <div class="test-section">
        <h2>1. Test Server Connection</h2>
        <button onclick="testServer()">Test Server</button>
        <div id="server-result"></div>
    </div>
    
    <div class="test-section">
        <h2>2. Test OAuth URL Generation</h2>
        <button onclick="testOAuthURL()">Get OAuth URL</button>
        <div id="oauth-url-result"></div>
    </div>
    
    <div class="test-section">
        <h2>3. Test Google OAuth Flow</h2>
        <button onclick="startOAuth()">Start OAuth Flow</button>
        <p>This will open Google OAuth in a new window</p>
        <div id="oauth-result"></div>
    </div>
    
    <div class="test-section">
        <h2>4. Check Current Auth Status</h2>
        <button onclick="checkAuth()">Check Auth Status</button>
        <div id="auth-status"></div>
    </div>
    
    <div class="test-section">
        <h2>Console Output</h2>
        <pre id="console-output"></pre>
    </div>
    
    <script>
        function log(message, isError = false) {
            const output = document.getElementById('console-output');
            const timestamp = new Date().toLocaleTimeString();
            const className = isError ? 'error' : '';
            output.innerHTML += `<span class="${className}">[${timestamp}] ${message}</span>\n`;
            console.log(message);
        }
        
        async function testServer() {
            const resultDiv = document.getElementById('server-result');
            try {
                log('Testing server connection...');
                const response = await fetch('http://localhost:8000/api/auth/check');
                const data = await response.json();
                resultDiv.innerHTML = `<span class="success">✓ Server is running</span><pre>${JSON.stringify(data, null, 2)}</pre>`;
                log('Server test successful');
            } catch (error) {
                resultDiv.innerHTML = `<span class="error">✗ Server connection failed: ${error.message}</span>`;
                log(`Server test failed: ${error.message}`, true);
            }
        }
        
        async function testOAuthURL() {
            const resultDiv = document.getElementById('oauth-url-result');
            try {
                log('Fetching OAuth URL...');
                const response = await fetch('http://localhost:8000/api/auth/google/url');
                const data = await response.json();
                
                if (data.url) {
                    // Parse and display URL components
                    const url = new URL(data.url);
                    const params = new URLSearchParams(url.search);
                    
                    resultDiv.innerHTML = `
                        <span class="success">✓ OAuth URL generated</span>
                        <h4>URL Components:</h4>
                        <pre>
Client ID: ${params.get('client_id')}
Redirect URI: ${params.get('redirect_uri')}
Scopes: ${params.get('scope')?.split(' ').join('\n       ')}
State: ${params.get('state')}
                        </pre>
                        <h4>Full URL:</h4>
                        <pre style="word-wrap: break-word">${data.url}</pre>
                    `;
                    log('OAuth URL generated successfully');
                } else {
                    resultDiv.innerHTML = `<span class="error">✗ No URL returned</span>`;
                    log('No OAuth URL returned', true);
                }
            } catch (error) {
                resultDiv.innerHTML = `<span class="error">✗ Failed to get OAuth URL: ${error.message}</span>`;
                log(`OAuth URL test failed: ${error.message}`, true);
            }
        }
        
        async function startOAuth() {
            const resultDiv = document.getElementById('oauth-result');
            try {
                log('Starting OAuth flow...');
                const response = await fetch('http://localhost:8000/api/auth/google/url');
                const data = await response.json();
                
                if (data.url) {
                    resultDiv.innerHTML = `<span class="success">Opening Google OAuth...</span>`;
                    log('Opening OAuth window...');
                    
                    // Open OAuth in new window
                    const authWindow = window.open(data.url, 'oauth', 'width=600,height=700');
                    
                    // Check if window was blocked
                    if (!authWindow) {
                        resultDiv.innerHTML += `<br><span class="error">Pop-up blocked! Please allow pop-ups for this site.</span>`;
                        log('Pop-up was blocked', true);
                    } else {
                        resultDiv.innerHTML += `<br>OAuth window opened. Complete authentication in the new window.`;
                        
                        // Poll to check when authentication is complete
                        const checkInterval = setInterval(async () => {
                            if (authWindow.closed) {
                                clearInterval(checkInterval);
                                log('OAuth window closed, checking auth status...');
                                await checkAuth();
                            }
                        }, 1000);
                    }
                } else {
                    resultDiv.innerHTML = `<span class="error">✗ Failed to get OAuth URL</span>`;
                    log('Failed to get OAuth URL', true);
                }
            } catch (error) {
                resultDiv.innerHTML = `<span class="error">✗ Error: ${error.message}</span>`;
                log(`OAuth flow error: ${error.message}`, true);
            }
        }
        
        async function checkAuth() {
            const resultDiv = document.getElementById('auth-status');
            try {
                log('Checking authentication status...');
                const response = await fetch('http://localhost:8000/api/auth/check', {
                    credentials: 'include'
                });
                const data = await response.json();
                
                if (data.authenticated) {
                    resultDiv.innerHTML = `
                        <span class="success">✓ Authenticated</span>
                        <pre>User: ${data.email}
Name: ${data.name}</pre>
                    `;
                    log(`Authenticated as ${data.email}`);
                } else {
                    resultDiv.innerHTML = `<span class="error">✗ Not authenticated</span>`;
                    log('Not authenticated');
                }
            } catch (error) {
                resultDiv.innerHTML = `<span class="error">✗ Error: ${error.message}</span>`;
                log(`Auth check error: ${error.message}`, true);
            }
        }
        
        // Test server on page load
        window.onload = () => {
            log('Page loaded, testing server...');
            testServer();
        };
    </script>
</body>
</html>