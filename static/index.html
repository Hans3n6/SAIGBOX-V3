<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SAIGBOX V3 - Email Management Platform</title>
    <link rel="icon" type="image/svg+xml" href="/static/saigbox-favicon.svg">
    <link rel="icon" type="image/x-icon" href="/static/favicon.ico">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="/static/saig-colors.css">
    <style>
        .gradient-bg {
            background: linear-gradient(135deg, #7fc97f 0%, #6db56d 100%);
        }
        .chat-container {
            transition: all 0.3s ease;
        }
        .loader {
            border: 3px solid #f3f4f6;
            border-top: 3px solid #7fc97f;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .fade-in {
            animation: fadeIn 0.3s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .email-item:hover {
            background-color: #f9fafb;
            transition: background-color 0.2s;
        }
        .rotate-180 {
            transform: rotate(180deg);
        }
        .transition-transform {
            transition: transform 0.2s ease;
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Main Container -->
    <div class="flex h-screen">
        <!-- Sidebar -->
        <div class="w-64 text-white" style="background-color: #7fc97f;">
            <div class="p-6">
                <div class="flex flex-col items-center">
                    <i class="fas fa-leaf text-5xl text-white mb-3"></i>
                    <h1 class="text-2xl font-bold text-white">SAIGBOX</h1>
                </div>
            </div>
            
            <nav class="mt-6">
                <a href="#" onclick="switchView('saig')" class="nav-item flex items-center px-6 py-3 transition-colors" style="hover:background-color: #6db56d;" onmouseover="this.style.backgroundColor='#6db56d'" onmouseout="this.style.backgroundColor='transparent'">
                    <i class="fas fa-leaf w-5"></i>
                    <span class="ml-3">SAIG</span>
                    <span class="ml-auto text-xs rounded-full px-2 py-1 text-white" style="background-color: #7fc97f;">AI</span>
                </a>
                <a href="#" onclick="switchView('inbox')" class="nav-item flex items-center px-6 py-3 transition-colors" onmouseover="this.style.backgroundColor='#6db56d'" onmouseout="this.style.backgroundColor='transparent'">
                    <i class="fas fa-inbox w-5"></i>
                    <span class="ml-3">Inbox</span>
                </a>
                <a href="#" onclick="switchView('actions')" class="nav-item flex items-center px-6 py-3 transition-colors" onmouseover="this.style.backgroundColor='#6db56d'" onmouseout="this.style.backgroundColor='transparent'">
                    <i class="fas fa-tasks w-5"></i>
                    <span class="ml-3">Action Items</span>
                    <span id="action-count" class="ml-auto bg-blue-500 text-xs rounded-full px-2 py-1">0</span>
                </a>
                <a href="#" onclick="switchView('huddles')" class="nav-item flex items-center px-6 py-3 transition-colors" onmouseover="this.style.backgroundColor='#6db56d'" onmouseout="this.style.backgroundColor='transparent'">
                    <i class="fas fa-users w-5"></i>
                    <span class="ml-3">Huddles</span>
                </a>
                <a href="#" onclick="switchView('trash')" class="nav-item flex items-center px-6 py-3 transition-colors" onmouseover="this.style.backgroundColor='#6db56d'" onmouseout="this.style.backgroundColor='transparent'">
                    <i class="fas fa-trash w-5"></i>
                    <span class="ml-3">Trash</span>
                </a>
            </nav>
            
            <div class="absolute bottom-0 w-64 p-6">
                <button onclick="logout()" class="w-full text-white py-2 px-4 rounded transition-colors" style="background-color: #6db56d;" onmouseover="this.style.backgroundColor='#5fa65f'" onmouseout="this.style.backgroundColor='#6db56d'">
                    <i class="fas fa-sign-out-alt mr-2"></i>Logout
                </button>
            </div>
        </div>
        
        <!-- Main Content Area -->
        <div class="flex-1 flex flex-col">
            <!-- Top Bar -->
            <div class="bg-white shadow-sm border-b">
                <div class="flex items-center justify-between px-6 py-4">
                    <div class="flex items-center space-x-4">
                        <h2 id="view-title" class="text-xl font-semibold text-gray-900">Inbox</h2>
                        <button onclick="syncEmails()" class="text-gray-500 hover:text-gray-700" title="Sync emails">
                            <i id="sync-icon" class="fas fa-sync-alt"></i>
                        </button>
                        <span id="sync-status" class="text-sm text-gray-500"></span>
                        <span id="email-count" class="text-sm text-gray-600 font-medium"></span>
                    </div>
                    
                    <div id="inbox-controls" class="flex items-center space-x-4">
                        <div class="relative">
                            <input type="text" id="search-input" placeholder="Search emails..." 
                                   class="pl-10 pr-10 py-2 border rounded-lg focus:outline-none" style="border-color: #e5e7eb;" onfocus="this.style.borderColor='#7fc97f'" onblur="this.style.borderColor='#e5e7eb'">
                            <i class="fas fa-search absolute left-3 top-3 text-gray-400"></i>
                            <button id="clear-search" onclick="clearSearch()" class="absolute right-3 top-3 text-gray-400 hover:text-gray-600 hidden">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <button onclick="showComposeModal()" class="gradient-bg text-white px-4 py-2 rounded-lg hover:opacity-90 transition">
                            <i class="fas fa-pen mr-2"></i>Compose
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Content Views -->
            <div class="flex-1 overflow-hidden">
                <!-- Inbox View -->
                <div id="inbox-view" class="h-full flex">
                    <!-- Email List -->
                    <div class="w-1/3 border-r overflow-y-auto">
                        <div id="email-list" class="divide-y">
                            <!-- Emails will be loaded here -->
                        </div>
                        <div id="email-loader" class="hidden p-4 text-center">
                            <div class="loader mx-auto"></div>
                        </div>
                    </div>
                    
                    <!-- Email Detail -->
                    <div class="flex-1 overflow-y-auto">
                        <div id="email-detail" class="p-6">
                            <div class="text-center text-gray-500 mt-20">
                                <i class="fas fa-envelope-open text-6xl mb-4 text-gray-300"></i>
                                <p>Select an email to view</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Action Items View -->
                <div id="actions-view" class="hidden h-full p-6 overflow-y-auto">
                    <div class="max-w-4xl mx-auto">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="text-lg font-semibold">Action Items</h3>
                            <button onclick="showCreateActionModal()" class="gradient-bg text-white px-4 py-2 rounded-lg hover:opacity-90">
                                <i class="fas fa-plus mr-2"></i>New Action
                            </button>
                        </div>
                        
                        <div id="action-list" class="space-y-4">
                            <!-- Action items will be loaded here -->
                        </div>
                    </div>
                </div>
                
                <!-- Huddles View -->
                <div id="huddles-view" class="hidden h-full p-6 overflow-y-auto">
                    <div class="max-w-4xl mx-auto">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="text-lg font-semibold">Huddles</h3>
                            <button onclick="showCreateHuddleModal()" class="gradient-bg text-white px-4 py-2 rounded-lg hover:opacity-90">
                                <i class="fas fa-plus mr-2"></i>New Huddle
                            </button>
                        </div>
                        
                        <div id="huddle-list" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <!-- Huddles will be loaded here -->
                        </div>
                    </div>
                </div>
                
                <!-- Trash View -->
                <div id="trash-view" class="hidden h-full p-6 overflow-y-auto">
                    <div class="max-w-4xl mx-auto">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="text-lg font-semibold">Trash</h3>
                            <button onclick="emptyTrash()" class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600">
                                <i class="fas fa-trash-alt mr-2"></i>Empty Trash
                            </button>
                        </div>
                        
                        <div id="trash-list" class="space-y-2">
                            <!-- Trashed emails will be loaded here -->
                        </div>
                    </div>
                </div>
                
                <!-- SAIG Full View -->
                <div id="saig-view" class="hidden h-full overflow-y-auto">
                    <div class="h-full flex flex-col">
                        <!-- SAIG Header -->
                        <div class="gradient-bg text-white p-6">
                            <div class="flex items-center space-x-3">
                                <div class="w-12 h-12 bg-white bg-opacity-30 rounded-full flex items-center justify-center">
                                    <i class="fas fa-leaf text-2xl"></i>
                                </div>
                                <div>
                                    <h2 class="text-2xl font-bold">SAIG</h2>
                                    <p class="text-sm opacity-90">Your AI-powered email intelligence assistant</p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- SAIG Chat Area -->
                        <div class="flex-1 overflow-y-auto p-6 bg-gray-50" id="saig-main-messages">
                            <div class="max-w-3xl mx-auto space-y-4">
                                <div class="bg-white rounded-lg p-4 shadow">
                                    <p class="text-gray-700">Hello! I'm SAIG, your email assistant. I can help you with:</p>
                                    <ul class="mt-3 space-y-2 text-sm text-gray-600">
                                        <li class="flex items-start"><i class="fas fa-check-circle mt-0.5 mr-2" style="color: #7fc97f;"></i>Summarizing long email threads</li>
                                        <li class="flex items-start"><i class="fas fa-check-circle mt-0.5 mr-2" style="color: #7fc97f;"></i>Drafting professional responses</li>
                                        <li class="flex items-start"><i class="fas fa-check-circle mt-0.5 mr-2" style="color: #7fc97f;"></i>Finding important information in your inbox</li>
                                        <li class="flex items-start"><i class="fas fa-check-circle mt-0.5 mr-2" style="color: #7fc97f;"></i>Managing action items and priorities</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                        
                        <!-- SAIG Input Area -->
                        <div class="border-t p-6 bg-white">
                            <div class="max-w-3xl mx-auto">
                                <div class="flex space-x-3">
                                    <input type="text" id="saig-main-input" 
                                           placeholder="Ask me anything about your emails..." 
                                           class="flex-1 px-4 py-3 border rounded-lg focus:outline-none" style="border-color: #e5e7eb;" onfocus="this.style.borderColor='#7fc97f'" onblur="this.style.borderColor='#e5e7eb'"
                                           onkeypress="if(event.key==='Enter') sendSaigMessage()">
                                    <button onclick="sendSaigMessage()" class="gradient-bg text-white px-6 py-3 rounded-lg hover:opacity-90 transition">
                                        <i class="fas fa-paper-plane mr-2"></i>Send
                                    </button>
                                </div>
                                <div class="mt-3 flex space-x-2">
                                    <button onclick="askSaig('Summarize unread emails')" class="text-xs bg-gray-100 hover:bg-gray-200 px-3 py-1.5 rounded-full transition">Summarize unread</button>
                                    <button onclick="askSaig('What needs my attention?')" class="text-xs bg-gray-100 hover:bg-gray-200 px-3 py-1.5 rounded-full transition">What's urgent?</button>
                                    <button onclick="askSaig('Show action items')" class="text-xs bg-gray-100 hover:bg-gray-200 px-3 py-1.5 rounded-full transition">Action items</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- SAIG Chat -->
    <div id="saig-chat" class="fixed bottom-4 right-4 z-50">
        <!-- Chat Toggle Button -->
        <button id="chat-toggle" onclick="toggleChat()" 
                class="text-white rounded-full w-14 h-14 flex items-center justify-center shadow-lg hover:opacity-90 transition"
                style="background-color: #7fc97f;">
            <i class="fas fa-leaf text-xl" style="color: white;"></i>
        </button>
        
        <!-- Chat Container -->
        <div id="chat-container" class="hidden absolute bottom-16 right-0 w-96 bg-white rounded-lg shadow-2xl chat-container">
            <div class="text-white p-4 rounded-t-lg flex justify-between items-center" style="background: linear-gradient(135deg, #7fc97f 0%, #6db56d 100%);">
                <div class="flex items-center space-x-2">
                    <div class="w-8 h-8 rounded-full flex items-center justify-center" style="background-color: rgba(255,255,255,0.3);">
                        <i class="fas fa-leaf text-sm"></i>
                    </div>
                    <div>
                        <h3 class="font-semibold">SAIG</h3>
                    </div>
                </div>
                <button onclick="toggleChat()" class="text-white hover:opacity-80">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div id="chat-messages" class="h-96 overflow-y-auto p-4 space-y-3">
                <div class="bg-gray-100 rounded-lg p-3 max-w-[80%]">
                    <p class="text-sm">Hi! I'm SAIG, your email assistant. How can I help you today?</p>
                </div>
            </div>
            
            <div class="p-4 border-t">
                <div class="flex space-x-2">
                    <input type="text" id="chat-input" placeholder="Type your message..." 
                           class="flex-1 px-3 py-2 border rounded-lg focus:outline-none"
                           style="border-color: #e5e7eb;"
                           onfocus="this.style.borderColor='#7fc97f'"
                           onblur="this.style.borderColor='#e5e7eb'"
                           onkeypress="if(event.key==='Enter') sendMessage()">
                    <button onclick="sendMessage()" class="text-white px-4 py-2 rounded-lg hover:opacity-90" style="background-color: #7fc97f;">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modals -->
    <!-- Create Action Modal -->
    <div id="action-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md p-6">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold">Create Action Item</h3>
                <button onclick="closeActionModal()" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Title *</label>
                    <input type="text" id="action-title" required 
                           class="w-full px-3 py-2 border rounded-lg focus:outline-none" 
                           style="border-color: #e5e7eb;" 
                           onfocus="this.style.borderColor='#7fc97f'" 
                           onblur="this.style.borderColor='#e5e7eb'"
                           placeholder="Enter action item title">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Description</label>
                    <textarea id="action-description" rows="3" 
                              class="w-full px-3 py-2 border rounded-lg focus:outline-none" 
                              style="border-color: #e5e7eb;" 
                              onfocus="this.style.borderColor='#7fc97f'" 
                              onblur="this.style.borderColor='#e5e7eb'"
                              placeholder="Add a description..."></textarea>
                </div>
                
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Priority</label>
                        <select id="action-priority" 
                                class="w-full px-3 py-2 border rounded-lg focus:outline-none" 
                                style="border-color: #e5e7eb;" 
                                onfocus="this.style.borderColor='#7fc97f'" 
                                onblur="this.style.borderColor='#e5e7eb'">
                            <option value="1">High</option>
                            <option value="2" selected>Medium</option>
                            <option value="3">Low</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Due Date</label>
                        <input type="date" id="action-due-date" 
                               class="w-full px-3 py-2 border rounded-lg focus:outline-none" 
                               style="border-color: #e5e7eb;" 
                               onfocus="this.style.borderColor='#7fc97f'" 
                               onblur="this.style.borderColor='#e5e7eb'">
                    </div>
                </div>
                
                <div id="action-email-link" class="hidden bg-gray-50 p-3 rounded-lg">
                    <p class="text-sm text-gray-600">
                        <i class="fas fa-link mr-1"></i>
                        Linked to email: <span id="linked-email-subject" class="font-medium"></span>
                    </p>
                </div>
            </div>
            
            <div class="flex justify-end space-x-3 mt-6">
                <button onclick="closeActionModal()" class="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50">
                    Cancel
                </button>
                <button onclick="saveActionItem()" class="gradient-bg text-white px-4 py-2 rounded-lg hover:opacity-90">
                    <i class="fas fa-plus mr-2"></i>Create Action
                </button>
            </div>
        </div>
    </div>
    
    <!-- Create Huddle Modal -->
    <div id="huddle-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md p-6">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold">Create New Huddle</h3>
                <button onclick="closeHuddleModal()" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Huddle Name *</label>
                    <input type="text" id="huddle-name" required 
                           class="w-full px-3 py-2 border rounded-lg focus:outline-none" 
                           style="border-color: #e5e7eb;" 
                           onfocus="this.style.borderColor='#7fc97f'" 
                           onblur="this.style.borderColor='#e5e7eb'"
                           placeholder="Enter huddle name">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Description</label>
                    <textarea id="huddle-description" rows="3" 
                              class="w-full px-3 py-2 border rounded-lg focus:outline-none" 
                              style="border-color: #e5e7eb;" 
                              onfocus="this.style.borderColor='#7fc97f'" 
                              onblur="this.style.borderColor='#e5e7eb'"
                              placeholder="What is this huddle about?"></textarea>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Add Members (email addresses)</label>
                    <div class="space-y-2">
                        <div class="flex space-x-2">
                            <input type="email" id="huddle-member-input" 
                                   class="flex-1 px-3 py-2 border rounded-lg focus:outline-none" 
                                   style="border-color: #e5e7eb;" 
                                   onfocus="this.style.borderColor='#7fc97f'" 
                                   onblur="this.style.borderColor='#e5e7eb'"
                                   placeholder="Enter email address"
                                   onkeypress="if(event.key==='Enter') { event.preventDefault(); addHuddleMember(); }">
                            <button onclick="addHuddleMember()" 
                                    class="px-3 py-2 rounded-lg" 
                                    style="background-color: #7fc97f; color: white;" 
                                    onmouseover="this.style.opacity='0.9'" 
                                    onmouseout="this.style.opacity='1'">
                                <i class="fas fa-plus"></i>
                            </button>
                        </div>
                        <div id="huddle-members-list" class="space-y-1 max-h-32 overflow-y-auto">
                            <!-- Members will be listed here -->
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="flex justify-end space-x-3 mt-6">
                <button onclick="closeHuddleModal()" class="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50">
                    Cancel
                </button>
                <button onclick="saveHuddle()" class="gradient-bg text-white px-4 py-2 rounded-lg hover:opacity-90">
                    <i class="fas fa-users mr-2"></i>Create Huddle
                </button>
            </div>
        </div>
    </div>
    
    <!-- Compose Email Modal will be dynamically created -->
    
    <script>
        // Global variables
        let authToken = '';
        let currentView = 'inbox';
        let selectedEmailId = null;
        let emails = [];
        let currentPage = 1;
        let isLoading = false;
        let hasMoreEmails = true;
        let totalEmailsLoaded = 0;
        let syncQueue = [];
        let isSyncing = false;
        
        // Global navigation function
        function switchView(view) {
            currentView = view;
            
            // Hide all views
            document.querySelectorAll('[id$="-view"]').forEach(el => el.classList.add('hidden'));
            
            // Show selected view
            const viewElement = document.getElementById(`${view}-view`);
            if (viewElement) {
                viewElement.classList.remove('hidden');
            }
            
            // Show/hide inbox controls (search and compose)
            const inboxControls = document.getElementById('inbox-controls');
            if (inboxControls) {
                if (view === 'inbox') {
                    inboxControls.style.display = 'flex';
                } else {
                    inboxControls.style.display = 'none';
                }
            }
            
            // Update nav links
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('bg-green-50', 'border-l-4', 'border-green-600', 'text-green-800', 'font-semibold');
                link.classList.add('text-gray-700', 'hover:bg-gray-100');
            });
            
            const activeLink = document.querySelector(`[onclick*="switchView('${view}')"]`);
            if (activeLink) {
                activeLink.classList.remove('text-gray-700', 'hover:bg-gray-100');
                activeLink.classList.add('bg-green-50', 'border-l-4', 'border-green-600', 'text-green-800', 'font-semibold');
            }
            
            // Load view-specific data
            if (view === 'actions' && typeof loadActionItems === 'function') {
                loadActionItems();
            } else if (view === 'huddles' && typeof loadHuddles === 'function') {
                loadHuddles();
            }
        }
        
        // Notification System
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            const bgColor = type === 'success' ? '#7fc97f' : type === 'error' ? '#ef4444' : '#3b82f6';
            
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background-color: ${bgColor};
                color: white;
                padding: 12px 24px;
                border-radius: 8px;
                box-shadow: 0 4px 6px rgba(0,0,0,0.1);
                z-index: 9999;
                animation: slideIn 0.3s ease-out;
            `;
            
            notification.innerHTML = `
                <div style="display: flex; align-items: center;">
                    <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'}" style="margin-right: 8px;"></i>
                    <span>${message}</span>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease-in';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }
        
        // Add animation styles
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideIn {
                from { transform: translateX(100%); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
            @keyframes slideOut {
                from { transform: translateX(0); opacity: 1; }
                to { transform: translateX(100%); opacity: 0; }
            }
        `;
        document.head.appendChild(style);
        
        // Initialize
        document.addEventListener('DOMContentLoaded', async function() {
            // First check if user is authenticated via session cookie
            try {
                const authCheckResponse = await fetch('/api/auth/check', {
                    credentials: 'include'
                });
                
                if (authCheckResponse.ok) {
                    const authData = await authCheckResponse.json();
                    if (authData.authenticated) {
                        // User is authenticated via session
                        authToken = localStorage.getItem('authToken') || 'session';
                        init();
                        return;
                    }
                }
            } catch (error) {
                console.error('Auth check failed:', error);
            }
            
            // Check for token in URL (for backward compatibility)
            const urlParams = new URLSearchParams(window.location.search);
            const token = urlParams.get('token');
            
            if (token) {
                authToken = token;
                localStorage.setItem('authToken', token);
                window.history.replaceState({}, document.title, '/');
                init();
            } else {
                // Check localStorage token
                authToken = localStorage.getItem('authToken');
                if (authToken) {
                    // Verify token is still valid
                    try {
                        const response = await fetch('/api/user/me', {
                            headers: {
                                'Authorization': `Bearer ${authToken}`
                            }
                        });
                        if (response.ok) {
                            init();
                        } else {
                            // Token is invalid, redirect to login
                            localStorage.removeItem('authToken');
                            window.location.href = '/login';
                        }
                    } catch (error) {
                        console.error('Token validation failed:', error);
                        window.location.href = '/login';
                    }
                } else {
                    // No authentication found, redirect to login
                    window.location.href = '/login';
                }
            }
        });
        
        function init() {
            loadEmails();
            setupEventListeners();
            setupInfiniteScroll();
            startAutoSync();
        }
        
        function setupEventListeners() {
            const searchInput = document.getElementById('search-input');
            const clearBtn = document.getElementById('clear-search');
            
            searchInput.addEventListener('input', function(e) {
                // Show/hide clear button
                if (e.target.value.trim()) {
                    clearBtn.classList.remove('hidden');
                } else {
                    clearBtn.classList.add('hidden');
                }
                // Debounced search
                debounce(searchEmails, 500)();
            });
        }
        
        function clearSearch() {
            const searchInput = document.getElementById('search-input');
            const clearBtn = document.getElementById('clear-search');
            
            searchInput.value = '';
            clearBtn.classList.add('hidden');
            loadEmails();
        }
        
        function setupInfiniteScroll() {
            const emailList = document.getElementById('email-list');
            if (!emailList) return;
            
            const container = emailList.parentElement;
            container.addEventListener('scroll', () => {
                const scrollTop = container.scrollTop;
                const scrollHeight = container.scrollHeight;
                const clientHeight = container.clientHeight;
                
                // Check if we're near the bottom (within 200px)
                if (scrollHeight - scrollTop <= clientHeight + 200) {
                    // Count visible emails
                    const visibleEmails = Math.floor((scrollTop + clientHeight) / 80); // Assuming ~80px per email
                    
                    // Check if we need to load more emails
                    if (visibleEmails > emails.length - 10 && !isLoading && hasMoreEmails) {
                        checkAndLoadMoreEmails();
                    }
                }
            });
        }
        
        async function checkAndLoadMoreEmails() {
            // Check current email count in database
            const dbEmailCount = emails.length;
            const neededEmails = dbEmailCount + 50;
            
            // If we have less than needed emails in DB, sync more from Gmail
            if (totalEmailsLoaded < neededEmails) {
                queueEmailSync(50);
            } else {
                // Load next page from database
                loadMoreEmailsFromDB();
            }
        }
        
        function queueEmailSync(count) {
            syncQueue.push(count);
            processeSyncQueue();
        }
        
        async function processeSyncQueue() {
            if (isSyncing || syncQueue.length === 0) return;
            
            isSyncing = true;
            const batchSize = syncQueue.shift();
            
            try {
                const response = await fetch(`/api/emails/sync?max_results=${batchSize}`, {
                    method: 'POST',
                    headers: authToken !== 'session' ? {
                        'Authorization': `Bearer ${authToken}`
                    } : {},
                    credentials: 'include'
                });
                
                if (response.ok) {
                    const result = await response.json();
                    totalEmailsLoaded += result.emails_synced;
                    
                    // Load the newly synced emails
                    await loadMoreEmailsFromDB();
                }
            } catch (error) {
                console.error('Sync error:', error);
            } finally {
                isSyncing = false;
                // Process next item in queue if any
                if (syncQueue.length > 0) {
                    setTimeout(() => processeSyncQueue(), 1000);
                }
            }
        }
        
        async function loadMoreEmailsFromDB() {
            if (isLoading) return;
            
            isLoading = true;
            showLoader('email-loader');
            
            try {
                currentPage++;
                const response = await fetch(`/api/emails?page=${currentPage}&limit=50`, {
                    headers: authToken !== 'session' ? {
                        'Authorization': `Bearer ${authToken}`
                    } : {},
                    credentials: 'include'
                });
                
                if (response.ok) {
                    const data = await response.json();
                    
                    if (data.emails.length > 0) {
                        emails = [...emails, ...data.emails];
                        appendEmailsToList(data.emails);
                    } else {
                        hasMoreEmails = false;
                    }
                    
                    if (!data.has_next) {
                        hasMoreEmails = false;
                    }
                }
            } catch (error) {
                console.error('Error loading more emails:', error);
            } finally {
                isLoading = false;
                hideLoader('email-loader');
            }
        }
        
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }
        
        async function loadEmails(page = 1) {
            try {
                showLoader('email-loader');
                const response = await fetch(`/api/emails?page=${page}&limit=50`, {
                    headers: authToken !== 'session' ? {
                        'Authorization': `Bearer ${authToken}`
                    } : {},
                    credentials: 'include'
                });
                
                if (!response.ok) throw new Error('Failed to load emails');
                
                const data = await response.json();
                emails = data.emails;
                currentPage = page;
                totalEmailsLoaded = data.total || emails.length;
                hasMoreEmails = data.has_next;
                
                renderEmailList(emails);
                updateUnreadCount();
                hideLoader('email-loader');
            } catch (error) {
                console.error('Error loading emails:', error);
                hideLoader('email-loader');
            }
        }
        
        function appendEmailsToList(newEmails) {
            const listEl = document.getElementById('email-list');
            
            newEmails.forEach(email => {
                const emailEl = document.createElement('div');
                emailEl.onclick = () => selectEmail(email.id);
                emailEl.className = `email-item p-4 cursor-pointer ${!email.is_read ? 'bg-blue-50' : ''}`;
                emailEl.innerHTML = `
                    <div class="flex justify-between items-start mb-1">
                        <span class="font-medium text-sm ${!email.is_read ? 'font-semibold' : ''}">${email.sender_name || email.sender}</span>
                        <span class="text-xs text-gray-500">${formatDate(email.received_at)}</span>
                    </div>
                    <div class="text-sm font-medium mb-1">${email.subject || '(No subject)'}</div>
                    <div class="text-xs text-gray-600 truncate">${email.snippet || ''}</div>
                    <div class="flex items-center mt-2 space-x-2">
                        ${email.is_starred ? '<i class="fas fa-star text-yellow-500 text-xs"></i>' : ''}
                        ${email.has_attachments ? '<i class="fas fa-paperclip text-gray-400 text-xs"></i>' : ''}
                    </div>
                `;
                listEl.appendChild(emailEl);
            });
        }
        
        function renderEmailList(emailList) {
            const listEl = document.getElementById('email-list');
            
            if (emailList.length === 0) {
                listEl.innerHTML = '<div class="p-4 text-center text-gray-500">No emails found</div>';
                return;
            }
            
            listEl.innerHTML = emailList.map(email => `
                <div onclick="selectEmail('${email.id}')" class="email-item p-4 cursor-pointer ${!email.is_read ? 'bg-blue-50' : ''}">
                    <div class="flex justify-between items-start mb-1">
                        <span class="font-medium text-sm ${!email.is_read ? 'font-semibold' : ''}">${email.sender_name || email.sender}</span>
                        <span class="text-xs text-gray-500">${formatDate(email.received_at)}</span>
                    </div>
                    <div class="text-sm font-medium mb-1">${email.subject || '(No subject)'}</div>
                    <div class="text-xs text-gray-600 truncate">${email.snippet || ''}</div>
                    <div class="flex items-center mt-2 space-x-2">
                        ${email.is_starred ? '<i class="fas fa-star text-yellow-500 text-xs"></i>' : ''}
                        ${email.has_attachments ? '<i class="fas fa-paperclip text-gray-400 text-xs"></i>' : ''}
                    </div>
                </div>
            `).join('');
        }
        
        async function selectEmail(emailId) {
            selectedEmailId = emailId;
            const email = emails.find(e => e.id === emailId);
            
            if (!email) return;
            
            // Mark as read if unread
            if (!email.is_read) {
                await markAsRead(emailId);
                email.is_read = true;
                renderEmailList(emails);
                updateUnreadCount();
            }
            
            // Display email detail
            const detailEl = document.getElementById('email-detail');
            detailEl.innerHTML = `
                <div class="fade-in">
                    <div class="mb-6">
                        <div class="flex justify-between items-start mb-4">
                            <h2 class="text-xl font-semibold">${email.subject || '(No subject)'}</h2>
                            <div class="flex space-x-2">
                                <button onclick="toggleStar('${emailId}')" class="text-gray-500 hover:text-yellow-500">
                                    <i class="fas fa-star ${email.is_starred ? 'text-yellow-500' : ''}"></i>
                                </button>
                                <button onclick="deleteEmail('${emailId}')" class="text-gray-500 hover:text-red-500">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                        <div class="text-sm text-gray-600 mb-4">
                            <div class="mb-1"><strong>From:</strong> ${email.sender}</div>
                            <div class="mb-1"><strong>Date:</strong> ${formatDate(email.received_at)}</div>
                            ${email.recipients ? `<div><strong>To:</strong> ${email.recipients.join(', ')}</div>` : ''}
                        </div>
                        
                        <!-- AI Summary Section -->
                        <div id="ai-summary-section-${emailId}" class="mb-4 border border-gray-200 rounded-lg overflow-hidden">
                            <button onclick="toggleAISummary('${emailId}')" class="w-full bg-gradient-to-r from-green-50 to-blue-50 hover:from-green-100 hover:to-blue-100 p-3 flex items-center justify-between transition-colors">
                                <div class="flex items-center">
                                    <i class="fas fa-brain text-green-600 mr-2"></i>
                                    <span class="font-semibold text-gray-700">AI Summary</span>
                                </div>
                                <i id="ai-summary-arrow-${emailId}" class="fas fa-chevron-down text-gray-500 transition-transform"></i>
                            </button>
                            <div id="ai-summary-content-${emailId}" class="hidden bg-white p-4 max-h-96 overflow-y-auto">
                                <div class="text-center text-gray-500">
                                    <span class="text-sm">Click above to generate AI summary</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="prose max-w-none">
                        ${email.body_html || `<p>${email.body_text || email.snippet}</p>`}
                    </div>
                    <div class="mt-6 flex flex-wrap gap-3">
                        <button onclick="replyToEmail('${emailId}')" class="gradient-bg text-white px-4 py-2 rounded-lg hover:opacity-90">
                            <i class="fas fa-reply mr-2"></i>Reply
                        </button>
                        <button onclick="replyAllToEmail('${emailId}')" class="px-4 py-2 rounded-lg hover:opacity-90" style="background-color: #6db56d; color: white;">
                            <i class="fas fa-reply-all mr-2"></i>Reply All
                        </button>
                        <button onclick="forwardEmail('${emailId}')" class="px-4 py-2 rounded-lg hover:opacity-90" style="background-color: #5fa55f; color: white;">
                            <i class="fas fa-share mr-2"></i>Forward
                        </button>
                        <button onclick="replySaig('${emailId}')" class="px-4 py-2 rounded-lg hover:opacity-90" style="background-color: #7fc97f; color: white;">
                            <i class="fas fa-leaf mr-2"></i>Reply with SAIG
                        </button>
                        <button onclick="createActionFromEmail('${emailId}')" class="px-4 py-2 rounded-lg hover:opacity-90" style="border: 1px solid #7fc97f; color: #7fc97f; background-color: rgba(127, 201, 127, 0.1);">
                            <i class="fas fa-tasks mr-2"></i>Create Action
                        </button>
                    </div>
                </div>
            `;
        }
        
        async function markAsRead(emailId) {
            try {
                await fetch(`/api/emails/${emailId}/read`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
            } catch (error) {
                console.error('Error marking as read:', error);
            }
        }
        
        async function toggleStar(emailId) {
            try {
                const response = await fetch(`/api/emails/${emailId}/star`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                
                if (response.ok) {
                    const result = await response.json();
                    const email = emails.find(e => e.id === emailId);
                    if (email) {
                        email.is_starred = result.is_starred;
                        renderEmailList(emails);
                        if (selectedEmailId === emailId) {
                            selectEmail(emailId);
                        }
                    }
                }
            } catch (error) {
                console.error('Error toggling star:', error);
            }
        }
        
        async function deleteEmail(emailId) {
            if (!confirm('Move this email to trash?')) return;
            
            try {
                const response = await fetch(`/api/emails/${emailId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                
                if (response.ok) {
                    emails = emails.filter(e => e.id !== emailId);
                    renderEmailList(emails);
                    document.getElementById('email-detail').innerHTML = `
                        <div class="text-center text-gray-500 mt-20">
                            <i class="fas fa-envelope-open text-6xl mb-4 text-gray-300"></i>
                            <p>Select an email to view</p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error deleting email:', error);
            }
        }
        
        async function syncEmails() {
            try {
                const syncBtn = document.querySelector('.fa-sync-alt');
                syncBtn.classList.add('fa-spin');
                
                const response = await fetch('/api/emails/sync', {
                    method: 'POST',
                    headers: authToken !== 'session' ? {
                        'Authorization': `Bearer ${authToken}`
                    } : {},
                    credentials: 'include'
                });
                
                if (response.ok) {
                    await loadEmails();
                }
                
                syncBtn.classList.remove('fa-spin');
            } catch (error) {
                console.error('Error syncing emails:', error);
                document.querySelector('.fa-sync-alt').classList.remove('fa-spin');
            }
        }
        
        async function searchEmails() {
            const query = document.getElementById('search-input').value.trim();
            const searchInput = document.getElementById('search-input');
            
            if (!query) {
                // If search is cleared, reload all emails
                await loadEmails();
                return;
            }
            
            // Show loading state
            searchInput.disabled = true;
            searchInput.classList.add('opacity-75');
            
            try {
                // Use the GET endpoint with search parameter
                const url = `/api/emails/?search=${encodeURIComponent(query)}&limit=50`;
                const response = await fetch(url, {
                    method: 'GET',
                    headers: authToken !== 'session' ? {
                        'Authorization': `Bearer ${authToken}`
                    } : {},
                    credentials: 'include'
                });
                
                if (response.ok) {
                    const data = await response.json();
                    const searchResults = data.emails || [];
                    
                    // Update the global emails array with search results
                    emails = searchResults;
                    
                    // Render the search results
                    renderEmailList(searchResults);
                    
                    // Update count display
                    updateUnreadCount();
                    
                    // Show info about search results
                    if (searchResults.length === 0) {
                        showNotification(`No emails found for "${query}"`, 'info');
                    } else {
                        showNotification(`Found ${searchResults.length} email${searchResults.length !== 1 ? 's' : ''} matching "${query}"`, 'success');
                    }
                } else {
                    console.error('Search failed:', response.status, response.statusText);
                    showNotification('Search failed. Please try again.', 'error');
                }
            } catch (error) {
                console.error('Error searching emails:', error);
                showNotification('Error searching emails', 'error');
            } finally {
                // Reset loading state
                searchInput.disabled = false;
                searchInput.classList.remove('opacity-75');
            }
        }
        
        function switchView(view) {
            currentView = view;
            
            // Hide all views
            document.querySelectorAll('[id$="-view"]').forEach(el => el.classList.add('hidden'));
            
            // Show selected view
            document.getElementById(`${view}-view`).classList.remove('hidden');
            
            // Show/hide inbox controls (search and compose)
            const inboxControls = document.getElementById('inbox-controls');
            if (view === 'inbox') {
                inboxControls.style.display = 'flex';
            } else {
                inboxControls.style.display = 'none';
            }
            
            // Update title
            const titles = {
                'inbox': 'Inbox',
                'actions': 'Action Items',
                'huddles': 'Huddles',
                'trash': 'Trash',
                'saig': 'SAIG'
            };
            document.getElementById('view-title').textContent = titles[view];
            
            // Load view data
            if (view === 'actions') loadActionItems();
            else if (view === 'huddles') loadHuddles();
            else if (view === 'trash') loadTrash();
            else if (view === 'saig') {
                // Focus on SAIG input when switching to view
                setTimeout(() => {
                    const input = document.getElementById('saig-main-input');
                    if (input) input.focus();
                }, 100);
            }
        }
        
        async function loadActionItems() {
            try {
                const response = await fetch('/api/actions', {
                    headers: authToken !== 'session' ? {
                        'Authorization': `Bearer ${authToken}`
                    } : {},
                    credentials: 'include'
                });
                
                if (response.ok) {
                    const data = await response.json();
                    renderActionItems(data.actions || data || []);
                }
            } catch (error) {
                console.error('Error loading action items:', error);
            }
        }
        
        function renderActionItems(actions) {
            const listEl = document.getElementById('action-list');
            
            if (!actions || actions.length === 0) {
                listEl.innerHTML = `
                    <div class="text-center py-12">
                        <i class="fas fa-tasks text-6xl text-gray-300 mb-4"></i>
                        <p class="text-gray-500 mb-4">No action items yet</p>
                        <button onclick="showCreateActionModal()" class="gradient-bg text-white px-4 py-2 rounded-lg hover:opacity-90">
                            <i class="fas fa-plus mr-2"></i>Create Your First Action
                        </button>
                    </div>
                `;
                return;
            }
            
            listEl.innerHTML = actions.map(action => `
                <div class="bg-white p-4 rounded-lg shadow">
                    <div class="flex justify-between items-start">
                        <div class="flex-1">
                            <h4 class="font-medium ${action.status === 'completed' ? 'line-through text-gray-500' : ''}">${action.title}</h4>
                            ${action.description ? `<p class="text-sm text-gray-600 mt-1">${action.description}</p>` : ''}
                            <div class="flex items-center space-x-4 mt-2 text-xs text-gray-500">
                                <span class="priority-${action.priority}">
                                    <i class="fas fa-flag mr-1"></i>${action.priority}
                                </span>
                                ${action.due_date ? `<span><i class="fas fa-clock mr-1"></i>${formatDate(action.due_date)}</span>` : ''}
                            </div>
                        </div>
                        <div class="flex space-x-2">
                            ${action.status !== 'completed' ? `
                                <button onclick="completeAction('${action.id}')" style="color: #7fc97f;" onmouseover="this.style.color='#6db56d'" onmouseout="this.style.color='#7fc97f'">
                                    <i class="fas fa-check"></i>
                                </button>
                            ` : ''}
                            <button onclick="deleteAction('${action.id}')" class="text-red-500 hover:text-red-600">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
            
            // Update count
            document.getElementById('action-count').textContent = actions.filter(a => a.status === 'pending').length;
        }
        
        async function loadHuddles() {
            try {
                const response = await fetch('/api/huddles', {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                
                if (response.ok) {
                    const huddles = await response.json();
                    renderHuddles(huddles);
                }
            } catch (error) {
                console.error('Error loading huddles:', error);
            }
        }
        
        function renderHuddles(huddles) {
            const listEl = document.getElementById('huddle-list');
            
            if (huddles.length === 0) {
                listEl.innerHTML = '<div class="col-span-2 text-center text-gray-500">No huddles yet</div>';
                return;
            }
            
            listEl.innerHTML = huddles.map(huddle => `
                <div class="bg-white p-4 rounded-lg shadow hover:shadow-md transition cursor-pointer" onclick="openHuddle('${huddle.id}')">
                    <h4 class="font-medium mb-2">${huddle.name}</h4>
                    ${huddle.description ? `<p class="text-sm text-gray-600 mb-3">${huddle.description}</p>` : ''}
                    <div class="flex items-center justify-between text-xs text-gray-500">
                        <span><i class="fas fa-users mr-1"></i>${huddle.members.length} members</span>
                        <span>${huddle.status}</span>
                    </div>
                </div>
            `).join('');
        }
        
        async function loadTrash() {
            try {
                const response = await fetch('/api/trash', {
                    headers: authToken !== 'session' ? {
                        'Authorization': `Bearer ${authToken}`
                    } : {},
                    credentials: 'include'
                });
                
                if (response.ok) {
                    const data = await response.json();
                    renderTrash(data.emails || data || []);
                }
            } catch (error) {
                console.error('Error loading trash:', error);
            }
        }
        
        function renderTrash(trashedEmails) {
            const listEl = document.getElementById('trash-list');
            
            if (trashedEmails.length === 0) {
                listEl.innerHTML = '<div class="text-center text-gray-500">Trash is empty</div>';
                return;
            }
            
            listEl.innerHTML = trashedEmails.map(email => `
                <div class="bg-white p-4 rounded-lg shadow flex justify-between items-center">
                    <div>
                        <div class="font-medium">${email.subject || '(No subject)'}</div>
                        <div class="text-sm text-gray-600">${email.sender} • ${formatDate(email.deleted_at)}</div>
                    </div>
                    <div class="flex space-x-2">
                        <button onclick="restoreEmail('${email.id}')" class="text-blue-500 hover:text-blue-600">
                            <i class="fas fa-undo"></i> Restore
                        </button>
                        <button onclick="permanentlyDelete('${email.id}')" class="text-red-500 hover:text-red-600">
                            <i class="fas fa-times"></i> Delete
                        </button>
                    </div>
                </div>
            `).join('');
        }
        
        // SAIG Chat Functions
        function toggleChat() {
            const container = document.getElementById('chat-container');
            container.classList.toggle('hidden');
        }
        
        async function sendMessage() {
            const input = document.getElementById('chat-input');
            const message = input.value.trim();
            
            if (!message) return;
            
            // Add user message
            addChatMessage(message, 'user');
            input.value = '';
            
            // Send to SAIG
            try {
                const response = await fetch('/api/saig/chat', {
                    method: 'POST',
                    headers: authToken !== 'session' ? {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    } : {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include',
                    body: JSON.stringify({
                        message: message,
                        context: selectedEmailId ? { email_id: selectedEmailId } : null
                    })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    addChatMessage(result.response, 'assistant');
                }
            } catch (error) {
                console.error('Error sending message:', error);
                addChatMessage('Sorry, I encountered an error. Please try again.', 'assistant');
            }
        }
        
        // SAIG Full View Functions
        async function sendSaigMessage() {
            const input = document.getElementById('saig-main-input');
            const message = input.value.trim();
            
            if (!message) return;
            
            // Add user message to chat
            const messagesEl = document.getElementById('saig-main-messages');
            const messageContainer = messagesEl.querySelector('.max-w-3xl');
            
            const userMsgEl = document.createElement('div');
            userMsgEl.className = 'text-white rounded-lg p-4 ml-auto max-w-lg mb-4';
            userMsgEl.style.backgroundColor = '#7fc97f';
            userMsgEl.textContent = message;
            messageContainer.appendChild(userMsgEl);
            
            input.value = '';
            
            // Show typing indicator
            const typingEl = document.createElement('div');
            typingEl.className = 'bg-gray-100 rounded-lg p-4 max-w-lg mb-4';
            typingEl.innerHTML = '<div class="flex space-x-2"><div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce"></div><div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 0.1s"></div><div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 0.2s"></div></div>';
            messageContainer.appendChild(typingEl);
            
            // Scroll to bottom
            messagesEl.scrollTop = messagesEl.scrollHeight;
            
            // Send to SAIG API
            try {
                const response = await fetch('/api/saig/chat', {
                    method: 'POST',
                    headers: authToken !== 'session' ? {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    } : {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include',
                    body: JSON.stringify({ message })
                });
                
                // Remove typing indicator
                typingEl.remove();
                
                if (response.ok) {
                    const data = await response.json();
                    const aiMsgEl = document.createElement('div');
                    aiMsgEl.className = 'bg-white rounded-lg p-4 shadow max-w-lg mb-4';
                    aiMsgEl.innerHTML = `<p class="text-gray-700">${data.response}</p>`;
                    messageContainer.appendChild(aiMsgEl);
                    
                    // Scroll to bottom
                    messagesEl.scrollTop = messagesEl.scrollHeight;
                }
            } catch (error) {
                console.error('Error sending message to SAIG:', error);
                typingEl.remove();
                const errorEl = document.createElement('div');
                errorEl.className = 'bg-red-50 border border-red-200 text-red-700 rounded-lg p-4 max-w-lg mb-4';
                errorEl.textContent = 'Sorry, I encountered an error. Please try again.';
                messageContainer.appendChild(errorEl);
            }
        }
        
        function askSaig(question) {
            document.getElementById('saig-main-input').value = question;
            sendSaigMessage();
        }
        
        function addChatMessage(message, role) {
            const messagesEl = document.getElementById('chat-messages');
            const messageEl = document.createElement('div');
            
            if (role === 'user') {
                messageEl.className = 'text-white rounded-lg p-3 max-w-[80%] ml-auto';
                messageEl.style.backgroundColor = '#7fc97f';
                messageEl.innerHTML = `<p class="text-sm">${message}</p>`;
            } else {
                messageEl.className = 'bg-gray-100 rounded-lg p-3 max-w-[80%]';
                // For assistant messages, allow HTML to support draft buttons and formatting
                const content = message.includes('<div') || message.includes('<button') ? message : `<p class="text-sm">${message}</p>`;
                messageEl.innerHTML = content;
            }
            
            messagesEl.appendChild(messageEl);
            messagesEl.scrollTop = messagesEl.scrollHeight;
        }
        
        // Enhanced Compose Modal Functions
        window.currentAttachments = [];
        window.currentDraftId = null;
        
        function showComposeModal(mode = 'compose', originalEmail = null) {
            const isReply = mode === 'reply';
            const isReplyAll = mode === 'reply_all';
            const isForward = mode === 'forward';
            
            // Prepare subject and content based on mode
            let defaultSubject = '';
            let defaultTo = '';
            let defaultCc = '';
            let defaultBody = '';
            
            if (originalEmail) {
                if (isReply || isReplyAll) {
                    defaultSubject = originalEmail.subject.startsWith('Re: ') ? originalEmail.subject : `Re: ${originalEmail.subject}`;
                    defaultTo = originalEmail.sender_email || originalEmail.sender;
                    
                    if (isReplyAll && originalEmail.recipients) {
                        const recipients = originalEmail.recipients.split(',').map(r => r.trim());
                        defaultCc = recipients.filter(r => r && !r.includes('me')).join(', ');
                    }
                    
                    defaultBody = `<br><br>------- Original Message -------<br>From: ${originalEmail.sender_name || originalEmail.sender_email || originalEmail.sender}<br>Date: ${new Date(originalEmail.received_at || originalEmail.date).toLocaleString()}<br>Subject: ${originalEmail.subject}<br><br>${originalEmail.body_text || originalEmail.snippet || ''}`;
                } else if (isForward) {
                    defaultSubject = originalEmail.subject.startsWith('Fwd: ') ? originalEmail.subject : `Fwd: ${originalEmail.subject}`;
                    defaultBody = `<br><br>------- Forwarded Message -------<br>From: ${originalEmail.sender_name || originalEmail.sender_email || originalEmail.sender}<br>Date: ${new Date(originalEmail.received_at || originalEmail.date).toLocaleString()}<br>To: ${originalEmail.recipients || ''}<br>Subject: ${originalEmail.subject}<br><br>${originalEmail.body_text || originalEmail.snippet || ''}`;
                }
            }
            
            const modalTitle = isReply ? 'Reply to Email' : isReplyAll ? 'Reply All' : isForward ? 'Forward Email' : 'Compose Email';
            
            const modalHtml = `
                <div id="compose-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4" onclick="if(event.target === this) closeComposeModal()">
                    <div class="bg-white rounded-xl shadow-2xl w-full max-w-4xl max-h-[90vh] flex flex-col" onclick="event.stopPropagation()" style="max-height: 90vh;">
                        <!-- Modal Header -->
                        <div class="flex items-center justify-between p-6 border-b" style="border-color: #e5e7eb;">
                            <h2 class="text-2xl font-bold" style="color: #111827;">${modalTitle}</h2>
                            <button onclick="closeComposeModal()" class="text-gray-400 hover:text-gray-600 transition-colors">
                                <i class="fas fa-times text-xl"></i>
                            </button>
                        </div>
                        
                        <!-- Modal Body -->
                        <div class="flex-1 overflow-y-auto p-6">
                            <form id="composeForm" class="space-y-4">
                                <!-- To Field -->
                                <div>
                                    <label class="block text-sm font-medium mb-2" style="color: #374151;">To:</label>
                                    <input type="email" id="composeTo" name="to" value="${defaultTo}" required 
                                           class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:outline-none"
                                           style="border-color: #d1d5db; --tw-ring-color: #7fc97f;"
                                           placeholder="Enter email addresses (separate with commas)">
                                </div>
                                
                                <!-- CC Field -->
                                <div>
                                    <label class="block text-sm font-medium mb-2" style="color: #374151;">CC:</label>
                                    <input type="email" id="composeCc" name="cc" value="${defaultCc}" multiple 
                                           class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:outline-none"
                                           style="border-color: #d1d5db; --tw-ring-color: #7fc97f;"
                                           placeholder="Add CC recipients (separate with commas)">
                                </div>
                                
                                <!-- BCC Field -->
                                <div>
                                    <label class="block text-sm font-medium mb-2" style="color: #374151;">BCC:</label>
                                    <input type="email" id="composeBcc" name="bcc" multiple 
                                           class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:outline-none"
                                           style="border-color: #d1d5db; --tw-ring-color: #7fc97f;"
                                           placeholder="Add BCC recipients (separate with commas)">
                                </div>
                                
                                <!-- Subject Field -->
                                <div>
                                    <label class="block text-sm font-medium mb-2" style="color: #374151;">Subject:</label>
                                    <input type="text" id="composeSubject" name="subject" value="${defaultSubject}" required 
                                           class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:outline-none"
                                           style="border-color: #d1d5db; --tw-ring-color: #7fc97f;"
                                           placeholder="Enter subject">
                                </div>
                                
                                <!-- Rich Text Editor -->
                                <div>
                                    <label class="block text-sm font-medium mb-2" style="color: #374151;">Message:</label>
                                    <!-- Toolbar -->
                                    <div class="border rounded-t-lg p-2 flex flex-wrap gap-1" style="border-color: #d1d5db; background-color: #f9fafb;">
                                        <!-- Text Formatting -->
                                        <div class="flex gap-1 pr-2 border-r" style="border-color: #d1d5db;">
                                            <button type="button" onclick="formatText('bold')" class="p-2 hover:bg-gray-200 rounded transition-colors" title="Bold">
                                                <i class="fas fa-bold"></i>
                                            </button>
                                            <button type="button" onclick="formatText('italic')" class="p-2 hover:bg-gray-200 rounded transition-colors" title="Italic">
                                                <i class="fas fa-italic"></i>
                                            </button>
                                            <button type="button" onclick="formatText('underline')" class="p-2 hover:bg-gray-200 rounded transition-colors" title="Underline">
                                                <i class="fas fa-underline"></i>
                                            </button>
                                            <button type="button" onclick="formatText('strikeThrough')" class="p-2 hover:bg-gray-200 rounded transition-colors" title="Strikethrough">
                                                <i class="fas fa-strikethrough"></i>
                                            </button>
                                        </div>
                                        
                                        <!-- Lists -->
                                        <div class="flex gap-1 pr-2 border-r" style="border-color: #d1d5db;">
                                            <button type="button" onclick="formatText('insertUnorderedList')" class="p-2 hover:bg-gray-200 rounded transition-colors" title="Bullet List">
                                                <i class="fas fa-list-ul"></i>
                                            </button>
                                            <button type="button" onclick="formatText('insertOrderedList')" class="p-2 hover:bg-gray-200 rounded transition-colors" title="Numbered List">
                                                <i class="fas fa-list-ol"></i>
                                            </button>
                                        </div>
                                        
                                        <!-- Alignment -->
                                        <div class="flex gap-1 pr-2 border-r" style="border-color: #d1d5db;">
                                            <button type="button" onclick="formatText('justifyLeft')" class="p-2 hover:bg-gray-200 rounded transition-colors" title="Align Left">
                                                <i class="fas fa-align-left"></i>
                                            </button>
                                            <button type="button" onclick="formatText('justifyCenter')" class="p-2 hover:bg-gray-200 rounded transition-colors" title="Align Center">
                                                <i class="fas fa-align-center"></i>
                                            </button>
                                            <button type="button" onclick="formatText('justifyRight')" class="p-2 hover:bg-gray-200 rounded transition-colors" title="Align Right">
                                                <i class="fas fa-align-right"></i>
                                            </button>
                                        </div>
                                        
                                        <!-- Links -->
                                        <div class="flex gap-1 pr-2 border-r" style="border-color: #d1d5db;">
                                            <button type="button" onclick="insertLink()" class="p-2 hover:bg-gray-200 rounded transition-colors" title="Insert Link">
                                                <i class="fas fa-link"></i>
                                            </button>
                                            <button type="button" onclick="formatText('unlink')" class="p-2 hover:bg-gray-200 rounded transition-colors" title="Remove Link">
                                                <i class="fas fa-unlink"></i>
                                            </button>
                                        </div>
                                        
                                        <!-- Undo/Redo -->
                                        <div class="flex gap-1">
                                            <button type="button" onclick="formatText('undo')" class="p-2 hover:bg-gray-200 rounded transition-colors" title="Undo">
                                                <i class="fas fa-undo"></i>
                                            </button>
                                            <button type="button" onclick="formatText('redo')" class="p-2 hover:bg-gray-200 rounded transition-colors" title="Redo">
                                                <i class="fas fa-redo"></i>
                                            </button>
                                        </div>
                                    </div>
                                    
                                    <!-- Editor Content Area -->
                                    <div id="composeBody" contenteditable="true" 
                                         class="w-full min-h-[300px] px-4 py-3 border border-t-0 rounded-b-lg focus:ring-2 focus:outline-none"
                                         style="border-color: #d1d5db; outline: none; --tw-ring-color: #7fc97f; min-height: 300px;">${defaultBody}</div>
                                </div>
                                
                                <!-- Attachments -->
                                <div>
                                    <label class="block text-sm font-medium mb-2" style="color: #374151;">Attachments:</label>
                                    <div class="border-2 border-dashed rounded-lg p-4" style="border-color: #d1d5db;">
                                        <input type="file" id="fileInput" multiple style="display: none;" onchange="handleFileSelect(event)">
                                        <button type="button" onclick="document.getElementById('fileInput').click()" 
                                                class="px-4 py-2 bg-gray-100 hover:bg-gray-200 rounded-lg transition-colors" style="color: #374151;">
                                            <i class="fas fa-paperclip mr-2"></i>
                                            Attach Files
                                        </button>
                                        <span class="ml-3 text-sm" style="color: #6b7280;">Maximum file size: 25MB</span>
                                        <div id="attachmentsList" class="mt-3 space-y-2"></div>
                                    </div>
                                </div>
                            </form>
                        </div>
                        
                        <!-- Modal Footer -->
                        <div class="flex items-center justify-between p-6 border-t" style="border-color: #e5e7eb; background-color: #f9fafb;">
                            <button onclick="closeComposeModal()" class="px-5 py-2.5 hover:text-gray-900 transition-colors" style="color: #374151;">
                                Cancel
                            </button>
                            <div class="flex gap-3">
                                <button onclick="saveDraft()" class="px-5 py-2.5 bg-gray-200 hover:bg-gray-300 rounded-lg transition-colors" style="color: #374151;">
                                    <i class="fas fa-save mr-2"></i>
                                    Save Draft
                                </button>
                                <button onclick="sendEmailEnhanced()" class="px-5 py-2.5 text-white rounded-lg transition-colors" style="background-color: #7fc97f;" onmouseover="this.style.backgroundColor='#6db56d'" onmouseout="this.style.backgroundColor='#7fc97f'">
                                    <i class="fas fa-paper-plane mr-2"></i>
                                    Send
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Remove any existing modal first
            const existingModal = document.getElementById('compose-modal');
            if (existingModal) {
                existingModal.remove();
            }
            
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            
            // Initialize the compose modal
            initializeComposeModal();
        }
        
        function closeComposeModal() {
            const modal = document.getElementById('compose-modal');
            if (modal) {
                modal.remove();
                window.currentAttachments = [];
                window.currentDraftId = null;
            }
        }
        
        function initializeComposeModal() {
            const editor = document.getElementById('composeBody');
            if (editor) {
                editor.focus();
                // Set up paste handling for rich text
                editor.addEventListener('paste', function(e) {
                    e.preventDefault();
                    const text = e.clipboardData.getData('text/html') || e.clipboardData.getData('text/plain');
                    document.execCommand('insertHTML', false, text);
                });
            }
        }
        
        // Rich Text Editor Functions
        function formatText(command, value = null) {
            document.execCommand(command, false, value);
            document.getElementById('composeBody').focus();
        }
        
        function insertLink() {
            const url = prompt('Enter the URL:');
            if (url) {
                formatText('createLink', url);
            }
        }
        
        // File Attachment Functions
        function handleFileSelect(event) {
            const files = Array.from(event.target.files);
            const attachmentsList = document.getElementById('attachmentsList');
            
            files.forEach(file => {
                if (file.size > 25 * 1024 * 1024) { // 25MB limit
                    showNotification(`File "${file.name}" is too large. Maximum size is 25MB.`, 'error');
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    const attachment = {
                        id: Date.now() + Math.random(),
                        name: file.name,
                        size: file.size,
                        type: file.type,
                        data: e.target.result.split(',')[1] // Base64 data
                    };
                    
                    window.currentAttachments.push(attachment);
                    
                    // Display attachment
                    const attachmentHtml = `
                        <div class="flex items-center justify-between p-2 bg-gray-50 rounded" data-attachment-id="${attachment.id}">
                            <div class="flex items-center">
                                <i class="fas fa-file mr-2" style="color: #6b7280;"></i>
                                <span class="text-sm" style="color: #374151;">${attachment.name}</span>
                                <span class="text-xs ml-2" style="color: #9ca3af;">(${formatFileSize(attachment.size)})</span>
                            </div>
                            <button type="button" onclick="removeAttachment(${attachment.id})" class="text-red-500 hover:text-red-700">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    `;
                    
                    attachmentsList.insertAdjacentHTML('beforeend', attachmentHtml);
                };
                reader.readAsDataURL(file);
            });
            
            // Reset file input
            event.target.value = '';
        }
        
        function removeAttachment(attachmentId) {
            window.currentAttachments = window.currentAttachments.filter(a => a.id !== attachmentId);
            const attachmentElement = document.querySelector(`[data-attachment-id="${attachmentId}"]`);
            if (attachmentElement) {
                attachmentElement.remove();
            }
        }
        
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
        }
        
        async function sendEmail(event) {
            // This function is kept for backward compatibility with the simple email compose
            if (event) event.preventDefault();
            
            const to = document.getElementById('compose-to')?.value || document.getElementById('composeTo')?.value;
            const subject = document.getElementById('compose-subject')?.value || document.getElementById('composeSubject')?.value;
            const body = document.getElementById('compose-body')?.value || document.getElementById('composeBody')?.innerHTML;
            
            if (!to || !subject || !body) {
                alert('Please fill in all required fields');
                return;
            }
            
            try {
                const response = await fetch('/api/emails/compose', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        to: [to],
                        subject: subject,
                        body: body
                    })
                });
                
                if (response.ok) {
                    closeComposeModal();
                    await loadEmails();
                    showNotification('Email sent successfully!', 'success');
                } else {
                    const error = await response.json();
                    showNotification(error.detail || 'Failed to send email', 'error');
                }
            } catch (error) {
                console.error('Error sending email:', error);
                showNotification('Failed to send email', 'error');
            }
        }
        
        async function sendEmailEnhanced() {
            const form = document.getElementById('composeForm');
            const formData = new FormData(form);
            
            // Get rich text content
            const richTextEditor = document.getElementById('composeBody');
            const htmlContent = richTextEditor.innerHTML;
            
            const emailData = {
                to: formData.get('to').split(',').map(e => e.trim()).filter(e => e),
                cc: formData.get('cc') ? formData.get('cc').split(',').map(e => e.trim()).filter(e => e) : [],
                bcc: formData.get('bcc') ? formData.get('bcc').split(',').map(e => e.trim()).filter(e => e) : [],
                subject: formData.get('subject'),
                body: htmlContent,
                attachments: window.currentAttachments || []
            };
            
            if (!emailData.to.length || !emailData.subject || !emailData.body) {
                showNotification('Please fill in all required fields', 'error');
                return;
            }
            
            try {
                const response = await fetch('/api/emails/compose', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(emailData)
                });
                
                if (response.ok) {
                    closeComposeModal();
                    await loadEmails();
                    showNotification('Email sent successfully!', 'success');
                } else {
                    const error = await response.json();
                    showNotification(error.detail || 'Failed to send email', 'error');
                }
            } catch (error) {
                console.error('Error sending email:', error);
                showNotification('Failed to send email', 'error');
            }
        }
        
        async function saveDraft() {
            const form = document.getElementById('composeForm');
            const formData = new FormData(form);
            
            // Get rich text content
            const richTextEditor = document.getElementById('composeBody');
            const htmlContent = richTextEditor.innerHTML;
            
            const draftData = {
                to: formData.get('to').split(',').map(e => e.trim()).filter(e => e),
                cc: formData.get('cc') ? formData.get('cc').split(',').map(e => e.trim()).filter(e => e) : [],
                bcc: formData.get('bcc') ? formData.get('bcc').split(',').map(e => e.trim()).filter(e => e) : [],
                subject: formData.get('subject'),
                body: htmlContent,
                attachments: window.currentAttachments || []
            };
            
            try {
                const response = await fetch('/api/emails/drafts', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(draftData)
                });
                
                if (response.ok) {
                    const result = await response.json();
                    window.currentDraftId = result.id;
                    showNotification('Draft saved successfully!', 'success');
                } else {
                    showNotification('Failed to save draft', 'error');
                }
            } catch (error) {
                console.error('Error saving draft:', error);
                showNotification('Failed to save draft', 'error');
            }
        }
        
        // AI Summary functionality
        let aiSummaryCache = {};
        
        async function toggleAISummary(emailId) {
            const contentEl = document.getElementById(`ai-summary-content-${emailId}`);
            const arrowEl = document.getElementById(`ai-summary-arrow-${emailId}`);
            
            if (!contentEl || !arrowEl) return;
            
            if (contentEl.classList.contains('hidden')) {
                // Show summary
                contentEl.classList.remove('hidden');
                arrowEl.classList.add('rotate-180');
                
                // Generate summary if not cached
                if (!aiSummaryCache[emailId]) {
                    await generateAISummary(emailId);
                }
            } else {
                // Hide summary
                contentEl.classList.add('hidden');
                arrowEl.classList.remove('rotate-180');
            }
        }
        
        async function generateAISummary(emailId) {
            const contentEl = document.getElementById(`ai-summary-content-${emailId}`);
            if (!contentEl) return;
            
            // Show loading state
            contentEl.innerHTML = `
                <div class="text-center text-gray-500">
                    <i class="fas fa-spinner fa-spin"></i>
                    <span class="ml-2">Generating AI summary...</span>
                </div>
            `;
            
            try {
                const response = await fetch(`/api/emails/${emailId}/summary`, {
                    method: 'POST',
                    headers: authToken !== 'session' ? {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    } : {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include'
                });
                
                if (response.ok) {
                    const data = await response.json();
                    aiSummaryCache[emailId] = data;
                    
                    // Display the summary
                    contentEl.innerHTML = data.content || '<p class="text-gray-500">No summary available</p>';
                    
                    // Add urgency indicator if high
                    if (data.summary && data.summary.urgency === 'High') {
                        contentEl.innerHTML = `
                            <div class="bg-red-50 border border-red-200 text-red-700 px-3 py-2 rounded-lg mb-3 text-sm">
                                <i class="fas fa-exclamation-triangle mr-2"></i>
                                <strong>High Priority Email</strong>
                            </div>
                            ${data.content}
                        `;
                    }
                } else {
                    throw new Error('Failed to generate summary');
                }
            } catch (error) {
                console.error('Error generating AI summary:', error);
                contentEl.innerHTML = `
                    <div class="text-red-500 text-center">
                        <i class="fas fa-exclamation-circle"></i>
                        <p class="text-sm mt-2">Failed to generate summary. Please try again.</p>
                    </div>
                `;
            }
        }
        
        // Email Reply Functions
        function replyToEmail(emailId) {
            const email = emails.find(e => e.id === emailId);
            if (!email) return;
            showComposeModal('reply', email);
        }
        
        function replyAllToEmail(emailId) {
            const email = emails.find(e => e.id === emailId);
            if (!email) return;
            showComposeModal('reply_all', email);
        }
        
        function forwardEmail(emailId) {
            const email = emails.find(e => e.id === emailId);
            if (!email) return;
            showComposeModal('forward', email);
        }
        
        function showReplyModal(emailId) {
            // Backward compatibility function
            replyToEmail(emailId);
        }
        
        // SAIG Reply Functions
        function replySaig(emailId) {
            // Show SAIG Reply modal
            showSAIGReplyModal(emailId);
        }
        
        function showSAIGReplyModal(emailId) {
            // Get the email data
            const email = emails.find(e => e.id === emailId);
            if (!email) {
                showNotification('Email not found', 'error');
                return;
            }
            
            // Create modal
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
            modal.id = 'saigReplyModal';
            
            modal.innerHTML = `
                <div class="bg-white rounded-xl shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-hidden">
                    <div class="gradient-bg p-6 text-white">
                        <div class="flex justify-between items-center">
                            <h2 class="text-2xl font-bold flex items-center">
                                <i class="fas fa-leaf mr-3"></i>
                                SAIG Smart Reply
                            </h2>
                            <button onclick="closeSAIGReplyModal()" class="text-white hover:text-gray-200 transition-colors">
                                <i class="fas fa-times text-xl"></i>
                            </button>
                        </div>
                    </div>
                    
                    <div class="p-6 overflow-y-auto" style="max-height: calc(90vh - 100px);">
                        <div class="mb-4 p-4 bg-gray-50 rounded-lg">
                            <p class="text-sm text-gray-600 mb-2">Original Email:</p>
                            <p class="font-semibold">${email.subject}</p>
                            <p class="text-sm text-gray-500 mt-1">From: ${email.sender}</p>
                        </div>
                        
                        
                        <!-- Loading state -->
                        <div id="saigLoadingState" class="mb-4 text-center py-8">
                            <i class="fas fa-spinner fa-spin text-4xl text-green-600 mb-4"></i>
                            <p class="text-gray-600">SAIG is analyzing the email and generating a smart reply...</p>
                        </div>
                        
                        <!-- Draft Preview (hidden initially) -->
                        <div id="saigReplyPreview" class="hidden mb-4">
                            <div class="bg-gradient-to-r from-green-50 to-blue-50 p-4 rounded-lg border border-green-200">
                                <h3 class="font-semibold text-gray-800 mb-4 flex items-center">
                                    <i class="fas fa-envelope-open-text mr-2 text-green-600"></i>
                                    SAIG's Draft Reply
                                </h3>
                                
                                <!-- Email Fields -->
                                <div class="space-y-3 mb-4">
                                    <div class="bg-white p-3 rounded border border-gray-200">
                                        <label class="text-xs font-semibold text-gray-600 uppercase tracking-wider">To:</label>
                                        <div id="saigReplyTo" class="mt-1 text-gray-800"></div>
                                    </div>
                                    
                                    <div class="bg-white p-3 rounded border border-gray-200">
                                        <label class="text-xs font-semibold text-gray-600 uppercase tracking-wider">Subject:</label>
                                        <div id="saigReplySubject" class="mt-1 text-gray-800"></div>
                                    </div>
                                    
                                    <div class="bg-white p-3 rounded border border-gray-200">
                                        <label class="text-xs font-semibold text-gray-600 uppercase tracking-wider">Message:</label>
                                        <div id="saigReplyBody" class="mt-2 text-gray-800 whitespace-pre-wrap" style="max-height: 300px; overflow-y: auto;"></div>
                                    </div>
                                </div>
                                
                                <!-- Action Buttons -->
                                <div class="flex justify-end space-x-3 pt-4 border-t border-green-200">
                                    <button 
                                        id="editSAIGReplyBtn"
                                        onclick="editSAIGReply('${emailId}')" 
                                        class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors flex items-center"
                                    >
                                        <i class="fas fa-edit mr-2"></i>Edit in Compose
                                    </button>
                                    <button 
                                        id="regenerateSAIGReplyBtn"
                                        onclick="generateSAIGReply('${emailId}')" 
                                        class="px-4 py-2 bg-gray-600 hover:bg-gray-700 text-white rounded-lg transition-colors flex items-center"
                                    >
                                        <i class="fas fa-redo mr-2"></i>Regenerate
                                    </button>
                                    <button 
                                        id="sendSAIGReplyBtn"
                                        onclick="sendSAIGReply('${emailId}')" 
                                        class="px-4 py-2 gradient-bg hover:opacity-90 text-white rounded-lg transition-all flex items-center"
                                    >
                                        <i class="fas fa-paper-plane mr-2"></i>Send Reply
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Auto-generate the reply after modal opens
            setTimeout(() => {
                generateSAIGReply(emailId);
            }, 100);
        }
        
        function closeSAIGReplyModal() {
            const modal = document.getElementById('saigReplyModal');
            if (modal) {
                modal.remove();
                // Clear stored reply data
                window.saigGeneratedReply = null;
                window.saigReplyTo = null;
                window.saigReplySubject = null;
            }
        }
        
        function editSAIGReply(emailId) {
            // Get the generated reply data
            if (!window.saigGeneratedReply || !window.saigReplyTo || !window.saigReplySubject) {
                showNotification('No reply generated yet', 'warning');
                return;
            }
            
            // Store the data before closing modal
            const saigTo = window.saigReplyTo;
            const saigSubject = window.saigReplySubject;
            const saigBody = window.saigGeneratedReply;
            
            // Close SAIG modal
            closeSAIGReplyModal();
            
            // Get the original email for context
            const email = emails.find(e => e.id === emailId);
            if (!email) return;
            
            // Open compose modal in reply mode
            showComposeModal('reply', email);
            
            // After modal opens, populate with SAIG's generated content
            // Need longer delay to ensure modal is fully rendered
            setTimeout(() => {
                // Set the fields with SAIG's generated content
                const toField = document.getElementById('composeTo');
                const subjectField = document.getElementById('composeSubject');
                const bodyField = document.getElementById('composeBody');
                
                console.log('Setting SAIG fields:', { saigTo, saigSubject, saigBody }); // Debug log
                
                if (toField) {
                    toField.value = saigTo;
                    console.log('Set To field:', saigTo);
                }
                if (subjectField) {
                    subjectField.value = saigSubject;
                    console.log('Set Subject field:', saigSubject);
                }
                if (bodyField) {
                    // Clear existing content first, then set new content
                    bodyField.innerHTML = '';
                    // Replace newlines with <br> and preserve the formatting
                    const formattedBody = saigBody.replace(/\n/g, '<br>');
                    bodyField.innerHTML = formattedBody;
                    console.log('Set Body field:', formattedBody);
                }
                
                // Show notification
                showNotification('SAIG reply loaded in compose window', 'success');
            }, 300);
        }
        
        async function generateSAIGReply(emailId) {
            const previewDiv = document.getElementById('saigReplyPreview');
            const loadingState = document.getElementById('saigLoadingState');
            
            // Hide preview and show loading state
            if (previewDiv) previewDiv.classList.add('hidden');
            if (loadingState) {
                loadingState.classList.remove('hidden');
                loadingState.innerHTML = `
                    <div class="text-center py-8">
                        <i class="fas fa-spinner fa-spin text-4xl text-green-600 mb-4"></i>
                        <p class="text-gray-600">SAIG is analyzing the email and generating a smart reply...</p>
                    </div>
                `;
            }
            
            try {
                // Get the email data
                const email = emails.find(e => e.id === emailId);
                if (!email) {
                    throw new Error('Email not found');
                }
                
                // Build the message for SAIG
                let message = `Please read this email and generate an appropriate, professional reply.
                
Email Details:
From: ${email.sender}
Subject: ${email.subject}
Content: ${email.body_text || email.snippet}

Generate a thoughtful and contextually appropriate response that:
1. Acknowledges the sender's message
2. Addresses any questions or requests
3. Maintains a professional tone
4. Includes a proper greeting and closing`;
                
                // Send message to SAIG for reply generation
                const response = await fetch('/api/saig/chat', {
                    method: 'POST',
                    headers: authToken !== 'session' ? {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    } : {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include',
                    body: JSON.stringify({
                        message: message,
                        context: { email_id: emailId }
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`Failed to generate reply: ${response.statusText}`);
                }
                
                const result = await response.json();
                
                // Parse the response to extract email components
                // (email variable already declared at the beginning of the function)
                // Extract just the email address from sender field (remove name if present)
                let replyTo = email.sender;
                if (replyTo.includes('<')) {
                    // Extract email from "Name <email@example.com>" format
                    const match = replyTo.match(/<([^>]+)>/);
                    if (match) {
                        replyTo = match[1];
                    }
                }
                let replySubject = email.subject.startsWith('Re:') ? email.subject : `Re: ${email.subject}`;
                let replyBody = result.response;
                
                // Extract clean text from HTML response if needed
                if (result.response.includes('<div')) {
                    // Extract just the reply text from the HTML
                    const tempDiv = document.createElement('div');
                    tempDiv.innerHTML = result.response;
                    const replyContent = tempDiv.querySelector('.whitespace-pre-wrap');
                    if (replyContent) {
                        replyBody = replyContent.textContent;
                    }
                }
                
                // Store the generated reply components
                window.saigGeneratedReply = replyBody;
                window.saigReplyTo = replyTo;
                window.saigReplySubject = replySubject;
                
                // Hide loading state
                document.getElementById('saigLoadingState').classList.add('hidden');
                
                // Show the preview
                previewDiv.classList.remove('hidden');
                
                // Populate the preview fields
                document.getElementById('saigReplyTo').textContent = replyTo;
                document.getElementById('saigReplySubject').textContent = replySubject;
                document.getElementById('saigReplyBody').textContent = replyBody;
                
                showNotification('SAIG has analyzed the email and generated a smart reply!', 'success');
                
            } catch (error) {
                console.error('Error generating SAIG reply:', error);
                showNotification(error.message || 'Failed to generate reply', 'error');
                
                // Hide loading state and show error
                const loadingState = document.getElementById('saigLoadingState');
                if (loadingState) {
                    loadingState.innerHTML = `
                        <div class="text-center py-8">
                            <i class="fas fa-exclamation-circle text-4xl text-red-500 mb-4"></i>
                            <p class="text-gray-600">Failed to generate reply. Please try again.</p>
                            <button onclick="generateSAIGReply('${emailId}')" class="mt-4 px-4 py-2 gradient-bg text-white rounded-lg hover:opacity-90">
                                <i class="fas fa-redo mr-2"></i>Try Again
                            </button>
                        </div>
                    `;
                }
            }
        }
        
        async function sendSAIGReply(emailId) {
            if (!window.saigGeneratedReply) {
                showNotification('Please generate a reply first', 'warning');
                return;
            }
            
            const email = emails.find(e => e.id === emailId);
            if (!email) {
                showNotification('Email not found', 'error');
                return;
            }
            
            const sendBtn = document.getElementById('sendSAIGReplyBtn');
            
            // Show loading state
            sendBtn.disabled = true;
            sendBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Sending...';
            
            try {
                // Send the reply using the reply endpoint to maintain thread context
                const response = await fetch('/api/emails/reply', {
                    method: 'POST',
                    headers: authToken !== 'session' ? {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    } : {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include',
                    body: JSON.stringify({
                        email_id: emailId,
                        body: window.saigGeneratedReply,
                        reply_all: false
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`Failed to send reply: ${response.statusText}`);
                }
                
                const result = await response.json();
                
                showNotification('Reply sent successfully!', 'success');
                closeSAIGReplyModal();
                
                // Refresh email list
                await loadEmails();
                
            } catch (error) {
                console.error('Error sending SAIG reply:', error);
                showNotification(error.message || 'Failed to send reply', 'error');
                sendBtn.innerHTML = '<i class="fas fa-paper-plane mr-2"></i>Send Reply';
                sendBtn.disabled = false;
            }
        }
        
        // SAIG Email Draft Functions
        function editDraft(recipient, subject, body) {
            // Show compose modal first
            showComposeModal();
            
            // Then fill with draft data after modal is shown
            setTimeout(() => {
                const toField = document.getElementById('composeTo');
                const subjectField = document.getElementById('composeSubject');
                const bodyField = document.getElementById('composeBody');
                
                if (toField) toField.value = recipient;
                if (subjectField) subjectField.value = subject;
                if (bodyField) {
                    // For contenteditable div, use innerHTML
                    bodyField.innerHTML = body.replace(/\n/g, '<br>');
                }
            }, 100);
        }
        
        async function sendDraftEmail(recipient, subject, body) {
            try {
                const response = await fetch('/api/emails/compose', {
                    method: 'POST',
                    headers: authToken !== 'session' ? {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    } : {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include',
                    body: JSON.stringify({
                        to: [recipient],
                        subject: subject,
                        body: body
                    })
                });
                
                if (response.ok) {
                    addChatMessage('✅ Email sent successfully!', 'assistant');
                    await loadEmails();
                    showNotification('Email sent successfully!', 'success');
                } else {
                    const error = await response.json();
                    addChatMessage(`❌ Failed to send email: ${error.detail || 'Unknown error'}`, 'assistant');
                    showNotification('Failed to send email', 'error');
                }
            } catch (error) {
                console.error('Error sending draft email:', error);
                addChatMessage('❌ Failed to send email due to connection error.', 'assistant');
                showNotification('Failed to send email', 'error');
            }
        }
        
        // Utility Functions
        function formatDate(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            const now = new Date();
            const diff = now - date;
            const days = Math.floor(diff / (1000 * 60 * 60 * 24));
            
            if (days === 0) {
                return date.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true });
            } else if (days === 1) {
                return 'Yesterday';
            } else if (days < 7) {
                return date.toLocaleDateString('en-US', { weekday: 'short' });
            } else {
                return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
            }
        }
        
        function updateUnreadCount() {
            const unreadCount = emails.filter(e => !e.is_read).length;
            const unreadElement = document.getElementById('unread-count');
            if (unreadElement) {
                unreadElement.textContent = unreadCount;
            }
        }
        
        function showLoader(id) {
            document.getElementById(id).classList.remove('hidden');
        }
        
        function hideLoader(id) {
            document.getElementById(id).classList.add('hidden');
        }
        
        function startAutoSync() {
            setInterval(() => {
                if (currentView === 'inbox') {
                    syncEmails();
                }
            }, 30000); // Sync every 30 seconds
        }
        
        async function logout() {
            try {
                // Call logout endpoint to clear session cookies
                await fetch('/api/auth/logout', {
                    method: 'POST',
                    credentials: 'include'
                });
            } catch (error) {
                console.error('Logout error:', error);
            }
            
            // Clear local storage
            localStorage.removeItem('authToken');
            
            // Redirect to login page
            window.location.href = '/login';
        }
        
        // Additional functions for complete functionality
        async function completeAction(actionId) {
            try {
                const response = await fetch(`/api/actions/${actionId}/complete`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                
                if (response.ok) {
                    loadActionItems();
                }
            } catch (error) {
                console.error('Error completing action:', error);
            }
        }
        
        async function deleteAction(actionId) {
            if (!confirm('Delete this action item?')) return;
            
            try {
                const response = await fetch(`/api/actions/${actionId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                
                if (response.ok) {
                    loadActionItems();
                }
            } catch (error) {
                console.error('Error deleting action:', error);
            }
        }
        
        async function restoreEmail(emailId) {
            try {
                const response = await fetch(`/api/trash/${emailId}/restore`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                
                if (response.ok) {
                    loadTrash();
                }
            } catch (error) {
                console.error('Error restoring email:', error);
            }
        }
        
        async function permanentlyDelete(emailId) {
            if (!confirm('Permanently delete this email? This cannot be undone.')) return;
            
            try {
                const response = await fetch(`/api/trash/${emailId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                
                if (response.ok) {
                    loadTrash();
                }
            } catch (error) {
                console.error('Error deleting email:', error);
            }
        }
        
        async function emptyTrash() {
            if (!confirm('Empty all trash? This cannot be undone.')) return;
            
            try {
                const response = await fetch('/api/trash/empty', {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                
                if (response.ok) {
                    loadTrash();
                }
            } catch (error) {
                console.error('Error emptying trash:', error);
            }
        }
        
        // Action Modal Functions
        let currentActionEmailId = null;
        
        function showCreateActionModal(emailId = null) {
            currentActionEmailId = emailId;
            const modal = document.getElementById('action-modal');
            
            // If linked to an email, show the link
            if (emailId) {
                const email = emails.find(e => e.id === emailId);
                if (email) {
                    document.getElementById('action-email-link').classList.remove('hidden');
                    document.getElementById('linked-email-subject').textContent = email.subject || '(No subject)';
                    document.getElementById('action-title').value = `Follow up: ${email.subject}`;
                }
            } else {
                document.getElementById('action-email-link').classList.add('hidden');
                document.getElementById('action-title').value = '';
            }
            
            // Reset other fields
            document.getElementById('action-description').value = '';
            document.getElementById('action-priority').value = '2';
            document.getElementById('action-due-date').value = '';
            
            modal.classList.remove('hidden');
            document.getElementById('action-title').focus();
        }
        
        function closeActionModal() {
            document.getElementById('action-modal').classList.add('hidden');
            currentActionEmailId = null;
        }
        
        async function saveActionItem() {
            const title = document.getElementById('action-title').value.trim();
            const description = document.getElementById('action-description').value.trim();
            const priority = parseInt(document.getElementById('action-priority').value);
            const dueDate = document.getElementById('action-due-date').value;
            
            if (!title) {
                showNotification('Please enter a title for the action item', 'error');
                return;
            }
            
            try {
                const body = {
                    title: title,
                    description: description,
                    priority: priority,
                    email_id: currentActionEmailId
                };
                
                if (dueDate) {
                    body.due_date = new Date(dueDate).toISOString();
                }
                
                const response = await fetch('/api/actions', {
                    method: 'POST',
                    headers: authToken !== 'session' ? {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    } : {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include',
                    body: JSON.stringify(body)
                });
                
                if (response.ok) {
                    closeActionModal();
                    if (currentView === 'actions') {
                        loadActionItems();
                    }
                    showNotification('Action item created successfully', 'success');
                }
            } catch (error) {
                console.error('Error creating action item:', error);
                showNotification('Failed to create action item', 'error');
            }
        }
        
        function createActionFromEmail(emailId) {
            showCreateActionModal(emailId);
        }
        
        // Backward compatibility
        async function createActionItem(title, emailId = null) {
            currentActionEmailId = emailId;
            document.getElementById('action-title').value = title;
            showCreateActionModal(emailId);
        }
        
        // Huddle Modal Functions
        let huddle_members = [];
        
        function showCreateHuddleModal() {
            huddle_members = [];
            document.getElementById('huddle-name').value = '';
            document.getElementById('huddle-description').value = '';
            document.getElementById('huddle-member-input').value = '';
            document.getElementById('huddle-members-list').innerHTML = '';
            document.getElementById('huddle-modal').classList.remove('hidden');
            document.getElementById('huddle-name').focus();
        }
        
        function closeHuddleModal() {
            document.getElementById('huddle-modal').classList.add('hidden');
            huddle_members = [];
        }
        
        function addHuddleMember() {
            const input = document.getElementById('huddle-member-input');
            const email = input.value.trim();
            
            if (email && email.includes('@')) {
                if (!huddle_members.includes(email)) {
                    huddle_members.push(email);
                    updateHuddleMembersList();
                    input.value = '';
                } else {
                    showNotification('Member already added', 'error');
                }
            } else {
                showNotification('Please enter a valid email address', 'error');
            }
        }
        
        function removeHuddleMember(email) {
            huddle_members = huddle_members.filter(m => m !== email);
            updateHuddleMembersList();
        }
        
        function updateHuddleMembersList() {
            const listEl = document.getElementById('huddle-members-list');
            if (huddle_members.length === 0) {
                listEl.innerHTML = '<p class="text-sm text-gray-500 italic">No members added yet</p>';
            } else {
                listEl.innerHTML = huddle_members.map(email => `
                    <div class="flex items-center justify-between bg-gray-50 px-2 py-1 rounded">
                        <span class="text-sm">${email}</span>
                        <button onclick="removeHuddleMember('${email}')" class="text-red-500 hover:text-red-700">
                            <i class="fas fa-times text-xs"></i>
                        </button>
                    </div>
                `).join('');
            }
        }
        
        async function saveHuddle() {
            const name = document.getElementById('huddle-name').value.trim();
            const description = document.getElementById('huddle-description').value.trim();
            
            if (!name) {
                showNotification('Please enter a huddle name', 'error');
                return;
            }
            
            try {
                const response = await fetch('/api/huddles', {
                    method: 'POST',
                    headers: authToken !== 'session' ? {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    } : {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include',
                    body: JSON.stringify({
                        name: name,
                        description: description,
                        member_emails: huddle_members
                    })
                });
                
                if (response.ok) {
                    closeHuddleModal();
                    showNotification('Huddle created successfully', 'success');
                    if (currentView === 'huddles') {
                        loadHuddles();
                    }
                } else {
                    const error = await response.json();
                    showNotification(error.detail || 'Failed to create huddle', 'error');
                }
            } catch (error) {
                console.error('Error creating huddle:', error);
                showNotification('Failed to create huddle', 'error');
            }
        }
        
        // Load huddles when switching to huddles view
        async function loadHuddles() {
            try {
                const response = await fetch('/api/huddles', {
                    headers: authToken !== 'session' ? {
                        'Authorization': `Bearer ${authToken}`
                    } : {},
                    credentials: 'include'
                });
                
                if (response.ok) {
                    const data = await response.json();
                    renderHuddles(data.huddles || []);
                }
            } catch (error) {
                console.error('Error loading huddles:', error);
            }
        }
        
        function renderHuddles(huddles) {
            const huddlesView = document.getElementById('huddles-view');
            const huddlesList = huddlesView.querySelector('.p-6');
            
            if (huddles.length === 0) {
                huddlesList.innerHTML = `
                    <div class="text-center py-12">
                        <i class="fas fa-users text-6xl text-gray-300 mb-4"></i>
                        <p class="text-gray-500">No huddles yet</p>
                        <button onclick="showCreateHuddleModal()" class="mt-4 gradient-bg text-white px-4 py-2 rounded-lg hover:opacity-90">
                            <i class="fas fa-plus mr-2"></i>Create Your First Huddle
                        </button>
                    </div>
                `;
            } else {
                huddlesList.innerHTML = huddles.map(huddle => `
                    <div class="bg-white rounded-lg shadow-sm hover:shadow-md transition-shadow cursor-pointer p-4 mb-3" onclick="openHuddle('${huddle.id}')">
                        <div class="flex items-center justify-between">
                            <div>
                                <h3 class="font-semibold text-gray-900">${huddle.name}</h3>
                                <p class="text-sm text-gray-600">${huddle.description || 'No description'}</p>
                                <p class="text-xs text-gray-500 mt-1">
                                    <i class="fas fa-users mr-1"></i>${huddle.member_count || 0} members • 
                                    Created ${new Date(huddle.created_at).toLocaleDateString()}
                                </p>
                            </div>
                            <i class="fas fa-chevron-right text-gray-400"></i>
                        </div>
                    </div>
                `).join('');
            }
        }
        
        function openHuddle(huddleId) {
            // Implementation for opening huddle detail view
            alert(`Opening huddle ${huddleId}`);
        }
        
        function showReplyModal(emailId) {
            const email = emails.find(e => e.id === emailId);
            if (email) {
                const reply = prompt('Your reply:');
                if (reply) {
                    replyToEmail(emailId, reply);
                }
            }
        }
        
        async function replyToEmail(emailId, body) {
            try {
                const response = await fetch('/api/emails/reply', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        email_id: emailId,
                        body: body,
                        reply_all: false
                    })
                });
                
                if (response.ok) {
                    alert('Reply sent!');
                }
            } catch (error) {
                console.error('Error sending reply:', error);
            }
        }
    </script>
</body>
</html>