<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SAIGBOX V3 - Email Management Platform</title>
    <link rel="icon" type="image/svg+xml" href="/static/saigbox-favicon.svg">
    <link rel="icon" type="image/x-icon" href="/static/favicon.ico">
    <!-- Tailwind CSS CDN - For development only -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        // Suppress Tailwind CDN warning in console
        tailwind.config = { 
            darkMode: 'class',
            silent: true 
        }
    </script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="/static/saig-colors.css">
    <style>
        .gradient-bg {
            background: linear-gradient(135deg, #7fc97f 0%, #6db56d 100%);
        }
        .chat-container {
            transition: all 0.3s ease;
        }
        .urgent-email {
            border-left: 3px solid #ef4444 !important;
            background-color: rgba(239, 68, 68, 0.05);
        }
        .urgent-email:hover {
            background-color: rgba(239, 68, 68, 0.1);
        }
        .urgent-indicator {
            color: #ef4444;
            margin-right: 8px;
        }
        .auto-action-badge {
            background-color: #10b981;
            color: white;
            font-size: 0.75rem;
            padding: 0.125rem 0.5rem;
            border-radius: 9999px;
            display: inline-block;
            margin-top: 0.25rem;
        }
        #resize-handle {
            transition: background-color 0.2s;
        }
        #resize-handle:hover {
            background-color: #cbd5e1 !important;
        }
        #resize-handle::after {
            content: '';
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            width: 2px;
            height: 30px;
            background-color: #94a3b8;
            border-radius: 2px;
            opacity: 0;
            transition: opacity 0.2s;
        }
        #resize-handle:hover::after {
            opacity: 1;
        }
        .loader {
            border: 3px solid #f3f4f6;
            border-top: 3px solid #7fc97f;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .fade-in {
            animation: fadeIn 0.3s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .email-item:hover {
            background-color: #f9fafb;
            transition: background-color 0.2s;
        }
        /* Prevent horizontal scrolling in email list */
        #email-list {
            overflow-x: hidden;
            width: 100%;
        }
        .email-item-card {
            overflow-x: hidden;
            word-wrap: break-word;
            width: 100%;
            box-sizing: border-box;
        }
        /* Ensure email content doesn't overflow */
        .email-item-card .truncate {
            max-width: 100%;
        }
        .rotate-180 {
            transform: rotate(180deg);
        }
        .transition-transform {
            transition: transform 0.2s ease;
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Main Container -->
    <div class="flex h-screen">
        <!-- Sidebar -->
        <div class="text-white" style="background-color: #7fc97f; width: 256px; min-width: 256px; max-width: 256px;">
            <div class="p-6">
                <div class="flex flex-col items-center">
                    <svg class="w-16 h-16 text-white mb-3" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512" fill="currentColor">
                        <path d="M546.2 9.7c-5.6-12.5-21.6-13-28.3-1.2C486.9 62.4 431.4 96 368 96h-80C182 96 96 182 96 288c0 7 .8 13.7 1.5 20.5C161.3 262.8 253.4 224 384 224c8.8 0 16 7.2 16 16s-7.2 16-16 16C132.6 256 26 410.1 2.4 468c-6.6 16.3 1.2 34.9 17.5 41.6 16.4 6.8 35-1.1 41.8-17.3 1.5-3.6 20.9-47.9 71.9-90.6 32.4 43.9 94 85.8 174.9 77.2C465.5 467.5 576 326.7 576 154.3c0-50.2-10.8-102.2-29.8-144.6z"/>
                    </svg>
                    <h1 class="text-2xl font-bold text-white">SAIGBOX</h1>
                </div>
            </div>
            
            <nav class="mt-6">
                <a href="#" onclick="switchView('saig')" class="nav-item flex items-center px-6 py-3 transition-colors" style="hover:background-color: #6db56d;" onmouseover="this.style.backgroundColor='#6db56d'" onmouseout="this.style.backgroundColor='transparent'">
                    <i class="fas fa-leaf w-5"></i>
                    <span class="ml-3">SAIG</span>
                    <span class="ml-auto text-xs rounded-full px-2 py-1 text-white" style="background-color: #7fc97f;">AI</span>
                </a>
                <a href="#" onclick="switchView('inbox')" class="nav-item flex items-center px-6 py-3 transition-colors" onmouseover="this.style.backgroundColor='#6db56d'" onmouseout="this.style.backgroundColor='transparent'">
                    <i class="fas fa-inbox w-5"></i>
                    <span class="ml-3">Inbox</span>
                </a>
                <a href="#" onclick="switchView('actions')" class="nav-item flex items-center px-6 py-3 transition-colors" onmouseover="this.style.backgroundColor='#6db56d'" onmouseout="this.style.backgroundColor='transparent'">
                    <i class="fas fa-tasks w-5"></i>
                    <span class="ml-3">Action Items</span>
                    <span id="action-count" class="ml-auto bg-blue-500 text-xs rounded-full px-2 py-1">0</span>
                </a>
                <a href="#" onclick="switchView('huddles')" class="nav-item flex items-center px-6 py-3 transition-colors" onmouseover="this.style.backgroundColor='#6db56d'" onmouseout="this.style.backgroundColor='transparent'">
                    <i class="fas fa-users w-5"></i>
                    <span class="ml-3">Huddles</span>
                </a>
                <a href="#" onclick="switchView('trash')" class="nav-item flex items-center px-6 py-3 transition-colors" onmouseover="this.style.backgroundColor='#6db56d'" onmouseout="this.style.backgroundColor='transparent'">
                    <i class="fas fa-trash w-5"></i>
                    <span class="ml-3">Trash</span>
                </a>
            </nav>
            
            <div class="absolute bottom-0 p-6" style="width: 256px;">
                <button onclick="logout()" class="w-full text-white py-2 px-4 rounded transition-colors" style="background-color: #6db56d;" onmouseover="this.style.backgroundColor='#5fa65f'" onmouseout="this.style.backgroundColor='#6db56d'">
                    <i class="fas fa-sign-out-alt mr-2"></i>Logout
                </button>
            </div>
        </div>
        
        <!-- Main Content Area -->
        <div class="flex-1 flex flex-col">
            <!-- Top Bar -->
            <div class="bg-white shadow-sm border-b">
                <div class="flex items-center justify-between px-6 py-4">
                    <div class="flex items-center space-x-4">
                        <h2 id="view-title" class="text-xl font-semibold text-gray-900">Inbox</h2>
                        <button onclick="syncEmails()" class="text-gray-500 hover:text-gray-700" title="Sync emails">
                            <i id="sync-icon" class="fas fa-sync-alt"></i>
                        </button>
                        <span id="sync-status" class="text-sm text-gray-500"></span>
                        <span id="email-count" class="text-sm text-gray-600 font-medium"></span>
                    </div>
                    
                    <div id="inbox-controls" class="flex items-center space-x-4">
                        <div class="relative flex items-center space-x-2">
                            <div class="relative flex-1">
                                <input type="text" id="search-input" placeholder="Search emails (AI-powered)..." 
                                       class="pl-10 pr-10 py-2 border rounded-lg focus:outline-none w-full" style="border-color: #e5e7eb;" onfocus="this.style.borderColor='#7fc97f'" onblur="this.style.borderColor='#e5e7eb'">
                                <i class="fas fa-search absolute left-3 top-3 text-gray-400"></i>
                                <button id="clear-search" onclick="clearSearch()" class="absolute right-3 top-3 text-gray-400 hover:text-gray-600 hidden">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                            <div class="flex items-center space-x-1 px-3 py-2 bg-gray-50 rounded-lg">
                                <label class="text-xs text-gray-600 cursor-pointer flex items-center space-x-1">
                                    <input type="checkbox" id="semantic-search-toggle" checked class="cursor-pointer" onchange="updateSearchPlaceholder()">
                                    <span>AI Search</span>
                                    <i class="fas fa-brain text-green-600" style="font-size: 0.75rem;"></i>
                                </label>
                            </div>
                        </div>
                        <button onclick="showComposeModal()" class="gradient-bg text-white px-4 py-2 rounded-lg hover:opacity-90 transition">
                            <i class="fas fa-pen mr-2"></i>Compose
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Content Views -->
            <div class="flex-1 overflow-hidden">
                <!-- Inbox View -->
                <div id="inbox-view" class="h-full flex">
                    <!-- Email List -->
                    <div id="email-list-container" class="border-r overflow-y-auto" style="width: 400px; min-width: 300px; position: relative;">
                        <!-- Resize Handle -->
                        <div id="resize-handle" class="absolute top-0 right-0 w-1 h-full cursor-col-resize hover:bg-blue-400" style="background-color: transparent; z-index: 10;"></div>
                        <!-- Filter Bar -->
                        <div class="bg-gray-50 border-b px-4 py-2 flex items-center space-x-2">
                            <button onclick="filterEmails('all')" id="filter-all" class="filter-btn px-3 py-1 rounded text-sm font-medium bg-blue-500 text-white">Inbox</button>
                            <button onclick="filterEmails('unread')" id="filter-unread" class="filter-btn px-3 py-1 rounded text-sm font-medium text-gray-700 hover:bg-gray-200">Unread</button>
                            <button onclick="filterEmails('urgent')" id="filter-urgent" class="filter-btn px-3 py-1 rounded text-sm font-medium text-gray-700 hover:bg-gray-200">
                                <i class="fas fa-exclamation-circle mr-1"></i>Urgent
                                <span id="urgent-badge" class="ml-1 bg-red-500 text-white text-xs px-1.5 py-0.5 rounded-full hidden">0</span>
                            </button>
                            <button onclick="filterEmails('starred')" id="filter-starred" class="filter-btn px-3 py-1 rounded text-sm font-medium text-gray-700 hover:bg-gray-200">Starred</button>
                            <button onclick="filterEmails('sent')" id="filter-sent" class="filter-btn px-3 py-1 rounded text-sm font-medium text-gray-700 hover:bg-gray-200">
                                <i class="fas fa-paper-plane mr-1"></i>Sent
                            </button>
                        </div>
                        <div id="email-list" class="divide-y overflow-x-hidden" style="width: 100%;">
                            <!-- Emails will be loaded here -->
                        </div>
                        <!-- Auto-syncing indicator -->
                        <div id="sync-indicator" class="p-2 text-center hidden">
                            <div class="flex items-center justify-center text-sm text-gray-600">
                                <i class="fas fa-spinner fa-spin mr-2"></i>
                                Syncing emails from Gmail...
                            </div>
                        </div>
                        <div id="email-loader" class="hidden p-4 text-center">
                            <div class="loader mx-auto"></div>
                            <p class="text-sm text-gray-500 mt-2">Loading more emails...</p>
                        </div>
                        <div id="no-more-emails" class="hidden p-4 text-center text-gray-500">
                            <p class="text-sm">No more emails to load</p>
                        </div>
                    </div>
                    
                    <!-- Email Detail -->
                    <div id="email-detail-container" class="flex-1 overflow-y-auto">
                        <div id="email-detail" class="p-6">
                            <div class="text-center text-gray-500 mt-20">
                                <i class="fas fa-envelope-open text-6xl mb-4 text-gray-300"></i>
                                <p>Select an email to view</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Action Items View -->
                <div id="actions-view" class="hidden h-full p-6 overflow-y-auto">
                    <div class="max-w-4xl mx-auto">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="text-lg font-semibold">Action Items</h3>
                            <button onclick="showCreateActionModal()" class="gradient-bg text-white px-4 py-2 rounded-lg hover:opacity-90">
                                <i class="fas fa-plus mr-2"></i>New Action
                            </button>
                        </div>
                        
                        <div id="action-list" class="space-y-4">
                            <!-- Action items will be loaded here -->
                        </div>
                    </div>
                </div>
                
                <!-- Huddles View -->
                <div id="huddles-view" class="hidden h-full p-6 overflow-y-auto">
                    <div class="max-w-4xl mx-auto">
                        <div class="flex justify-between items-center mb-6">
                            <div class="flex items-center space-x-4">
                                <h3 class="text-lg font-semibold">Huddles</h3>
                                <label class="flex items-center text-sm text-gray-600 cursor-pointer">
                                    <input type="checkbox" id="show-archived-huddles" onchange="toggleArchivedHuddles()" class="mr-2">
                                    <span>Show Archived</span>
                                </label>
                            </div>
                            <button onclick="showCreateHuddleModal()" class="gradient-bg text-white px-4 py-2 rounded-lg hover:opacity-90">
                                <i class="fas fa-plus mr-2"></i>New Huddle
                            </button>
                        </div>
                        
                        <div id="huddle-list" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <!-- Huddles will be loaded here -->
                        </div>
                    </div>
                </div>
                
                <!-- Trash View -->
                <div id="trash-view" class="hidden h-full p-6 overflow-y-auto">
                    <div class="max-w-4xl mx-auto">
                        <div class="flex justify-between items-center mb-4">
                            <div class="flex items-center space-x-4">
                                <h3 class="text-lg font-semibold">Trash <span id="trash-count" class="text-sm text-gray-500"></span></h3>
                                <label class="flex items-center cursor-pointer">
                                    <input type="checkbox" id="trash-select-all" onclick="selectAllTrashEmails()" class="mr-2">
                                    <span class="text-sm">Select All</span>
                                </label>
                            </div>
                            <button onclick="emptyTrash()" class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600">
                                <i class="fas fa-trash-alt mr-2"></i>Empty Trash
                            </button>
                        </div>
                        
                        <!-- Bulk action buttons -->
                        <div id="trash-bulk-actions" class="flex space-x-2 mb-4" style="display: none;">
                            <button onclick="bulkRestoreEmails()" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600">
                                <i class="fas fa-undo mr-2"></i>Restore Selected
                            </button>
                            <button onclick="bulkDeleteEmails()" class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600">
                                <i class="fas fa-trash mr-2"></i>Delete Selected
                            </button>
                            <span id="trash-selection-count" class="text-sm text-gray-600 self-center ml-4"></span>
                        </div>
                        
                        <div id="trash-list" class="space-y-2">
                            <!-- Trashed emails will be loaded here -->
                        </div>
                    </div>
                </div>
                
                <!-- SAIG Full View -->
                <div id="saig-view" class="hidden h-full overflow-y-auto">
                    <div class="h-full flex flex-col">
                        <!-- SAIG Header -->
                        <div class="gradient-bg text-white p-6">
                            <div class="flex items-center space-x-3">
                                <div class="w-12 h-12 bg-white bg-opacity-30 rounded-full flex items-center justify-center">
                                    <i class="fas fa-leaf text-2xl"></i>
                                </div>
                                <div>
                                    <h2 class="text-2xl font-bold">SAIG</h2>
                                    <p class="text-sm opacity-90">Your AI-powered email intelligence assistant</p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- SAIG Chat Area -->
                        <div class="flex-1 overflow-y-auto p-6 bg-gray-50" id="saig-main-messages">
                            <div class="max-w-3xl mx-auto space-y-4">
                                <div class="bg-white rounded-lg p-4 shadow">
                                    <p class="text-gray-700">Hello! I'm SAIG, your email assistant. I can help you with:</p>
                                    <ul class="mt-3 space-y-2 text-sm text-gray-600">
                                        <li class="flex items-start"><i class="fas fa-check-circle mt-0.5 mr-2" style="color: #7fc97f;"></i>Summarizing long email threads</li>
                                        <li class="flex items-start"><i class="fas fa-check-circle mt-0.5 mr-2" style="color: #7fc97f;"></i>Drafting professional responses</li>
                                        <li class="flex items-start"><i class="fas fa-check-circle mt-0.5 mr-2" style="color: #7fc97f;"></i>Finding important information in your inbox</li>
                                        <li class="flex items-start"><i class="fas fa-check-circle mt-0.5 mr-2" style="color: #7fc97f;"></i>Managing action items and priorities</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                        
                        <!-- SAIG Input Area -->
                        <div class="border-t p-6 bg-white">
                            <div class="max-w-3xl mx-auto">
                                <div class="flex space-x-3">
                                    <input type="text" id="saig-main-input" 
                                           placeholder="Ask me anything about your emails..." 
                                           class="flex-1 px-4 py-3 border rounded-lg focus:outline-none" style="border-color: #e5e7eb;" onfocus="this.style.borderColor='#7fc97f'" onblur="this.style.borderColor='#e5e7eb'"
                                           onkeypress="if(event.key==='Enter') sendSaigMessage()">
                                    <button onclick="sendSaigMessage()" class="gradient-bg text-white px-6 py-3 rounded-lg hover:opacity-90 transition">
                                        <i class="fas fa-paper-plane mr-2"></i>Send
                                    </button>
                                </div>
                                <div class="mt-3 flex space-x-2">
                                    <button onclick="askSaig('Summarize unread emails')" class="text-xs bg-gray-100 hover:bg-gray-200 px-3 py-1.5 rounded-full transition">Summarize unread</button>
                                    <button onclick="askSaig('What needs my attention?')" class="text-xs bg-gray-100 hover:bg-gray-200 px-3 py-1.5 rounded-full transition">What's urgent?</button>
                                    <button onclick="askSaig('Show action items')" class="text-xs bg-gray-100 hover:bg-gray-200 px-3 py-1.5 rounded-full transition">Action items</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- SAIG Chat -->
    <div id="saig-chat" class="fixed bottom-4 right-4 z-50">
        <!-- Chat Toggle Button -->
        <button id="chat-toggle" onclick="toggleChat()" 
                class="text-white rounded-full w-14 h-14 flex items-center justify-center shadow-lg hover:opacity-90 transition"
                style="background-color: #7fc97f;">
            <i class="fas fa-leaf text-xl" style="color: white;"></i>
        </button>
        
        <!-- Chat Container (Draggable and Resizable) -->
        <div id="chat-container" class="hidden fixed bg-white rounded-lg shadow-2xl chat-container" 
             style="width: 400px; height: 500px; bottom: 80px; right: 20px; resize: both; overflow: hidden; min-width: 300px; min-height: 400px;">
            <div class="text-white p-4 rounded-t-lg flex justify-between items-center cursor-move" 
                 id="chat-header"
                 style="background: linear-gradient(135deg, #7fc97f 0%, #6db56d 100%);">
                <div class="flex items-center space-x-2">
                    <div class="w-8 h-8 rounded-full flex items-center justify-center" style="background-color: rgba(255,255,255,0.3);">
                        <i class="fas fa-leaf text-sm"></i>
                    </div>
                    <div>
                        <h3 class="font-semibold">SAIG</h3>
                    </div>
                </div>
                <button onclick="toggleChat()" class="text-white hover:opacity-80">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div id="chat-messages" class="overflow-y-auto p-4 space-y-3" style="height: calc(100% - 120px);">
                <div class="bg-gray-100 rounded-lg p-3 max-w-[80%]">
                    <p class="text-sm">Hi! I'm SAIG, your email assistant. How can I help you today?</p>
                </div>
            </div>
            
            <div class="p-4 border-t">
                <div class="flex space-x-2">
                    <input type="text" id="chat-input" placeholder="Type your message..." 
                           class="flex-1 px-3 py-2 border rounded-lg focus:outline-none"
                           style="border-color: #e5e7eb;"
                           onfocus="this.style.borderColor='#7fc97f'"
                           onblur="this.style.borderColor='#e5e7eb'"
                           onkeypress="if(event.key==='Enter') sendMessage()">
                    <button onclick="sendMessage()" class="text-white px-4 py-2 rounded-lg hover:opacity-90" style="background-color: #7fc97f;">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modals -->
    <!-- Create Action Modal -->
    <div id="action-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md p-6">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold">Create Action Item</h3>
                <button onclick="closeActionModal()" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Title *</label>
                    <input type="text" id="action-title" required 
                           class="w-full px-3 py-2 border rounded-lg focus:outline-none" 
                           style="border-color: #e5e7eb;" 
                           onfocus="this.style.borderColor='#7fc97f'" 
                           onblur="this.style.borderColor='#e5e7eb'"
                           placeholder="Enter action item title">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Description</label>
                    <textarea id="action-description" rows="3" 
                              class="w-full px-3 py-2 border rounded-lg focus:outline-none" 
                              style="border-color: #e5e7eb;" 
                              onfocus="this.style.borderColor='#7fc97f'" 
                              onblur="this.style.borderColor='#e5e7eb'"
                              placeholder="Add a description..."></textarea>
                </div>
                
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Priority</label>
                        <select id="action-priority" 
                                class="w-full px-3 py-2 border rounded-lg focus:outline-none" 
                                style="border-color: #e5e7eb;" 
                                onfocus="this.style.borderColor='#7fc97f'" 
                                onblur="this.style.borderColor='#e5e7eb'">
                            <option value="1">High</option>
                            <option value="2" selected>Medium</option>
                            <option value="3">Low</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Due Date</label>
                        <input type="date" id="action-due-date" 
                               class="w-full px-3 py-2 border rounded-lg focus:outline-none" 
                               style="border-color: #e5e7eb;" 
                               onfocus="this.style.borderColor='#7fc97f'" 
                               onblur="this.style.borderColor='#e5e7eb'">
                    </div>
                </div>
                
                <div id="action-email-link" class="hidden bg-gray-50 p-3 rounded-lg">
                    <p class="text-sm text-gray-600">
                        <i class="fas fa-link mr-1"></i>
                        Linked to email: <span id="linked-email-subject" class="font-medium"></span>
                    </p>
                </div>
            </div>
            
            <div class="flex justify-end space-x-3 mt-6">
                <button onclick="closeActionModal()" class="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50">
                    Cancel
                </button>
                <button onclick="saveActionItem()" class="gradient-bg text-white px-4 py-2 rounded-lg hover:opacity-90">
                    <i class="fas fa-plus mr-2"></i>Create Action
                </button>
            </div>
        </div>
    </div>
    
    <!-- Huddle Detail Modal -->
    <div id="huddle-detail-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 overflow-y-auto">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-4xl m-4 max-h-[90vh] flex flex-col">
            <!-- Modal Header -->
            <div class="flex justify-between items-center p-6 border-b">
                <div>
                    <h2 id="huddle-detail-name" class="text-2xl font-bold text-gray-900"></h2>
                    <p id="huddle-detail-description" class="text-gray-600 mt-1"></p>
                </div>
                <div class="flex items-center space-x-3">
                    <!-- Archive Button -->
                    <button onclick="archiveHuddle()" class="text-yellow-600 hover:text-yellow-700" title="Archive Huddle">
                        <i class="fas fa-archive text-lg"></i>
                    </button>
                    <!-- Delete Button -->
                    <button onclick="deleteHuddle()" class="text-red-600 hover:text-red-700" title="Delete Huddle">
                        <i class="fas fa-trash text-lg"></i>
                    </button>
                    <!-- Close Button -->
                    <button onclick="closeHuddleDetail()" class="text-gray-500 hover:text-gray-700" title="Close">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
            </div>
            
            <!-- Modal Body -->
            <div class="flex-1 overflow-y-auto p-6">
                <div class="grid grid-cols-3 gap-6">
                    <!-- Members Section -->
                    <div class="col-span-1">
                        <h3 class="text-lg font-semibold mb-3 text-gray-800">
                            <i class="fas fa-users mr-2 text-green-600"></i>Members
                        </h3>
                        <div id="huddle-members-detail" class="space-y-2">
                            <!-- Members will be loaded here -->
                        </div>
                        <button onclick="addMemberToHuddle()" class="mt-4 w-full text-green-600 border border-green-600 px-3 py-2 rounded hover:bg-green-50 text-sm">
                            <i class="fas fa-user-plus mr-2"></i>Add Member
                        </button>
                    </div>
                    
                    <!-- Email Chain Section -->
                    <div class="col-span-2">
                        <h3 class="text-lg font-semibold mb-3 text-gray-800">
                            <i class="fas fa-envelope mr-2 text-blue-600"></i>Email Chain
                        </h3>
                        <div id="huddle-emails-list" class="space-y-3 max-h-96 overflow-y-auto border rounded-lg p-3 bg-gray-50">
                            <!-- Emails will be loaded here -->
                        </div>
                    </div>
                </div>
                
                <!-- Compose Button Section -->
                <div class="mt-6 border-t pt-6">
                    <div class="flex justify-center">
                        <button onclick="composeToHuddle()" class="gradient-bg text-white px-6 py-3 rounded-lg hover:opacity-90 flex items-center space-x-2">
                            <i class="fas fa-paper-plane"></i>
                            <span>Compose Message to Huddle</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Create Huddle Modal -->
    <div id="huddle-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md p-6">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold">Create New Huddle</h3>
                <button onclick="closeHuddleModal()" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Huddle Name *</label>
                    <input type="text" id="huddle-name" required 
                           class="w-full px-3 py-2 border rounded-lg focus:outline-none" 
                           style="border-color: #e5e7eb;" 
                           onfocus="this.style.borderColor='#7fc97f'" 
                           onblur="this.style.borderColor='#e5e7eb'"
                           placeholder="Enter huddle name">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Description</label>
                    <textarea id="huddle-description" rows="3" 
                              class="w-full px-3 py-2 border rounded-lg focus:outline-none" 
                              style="border-color: #e5e7eb;" 
                              onfocus="this.style.borderColor='#7fc97f'" 
                              onblur="this.style.borderColor='#e5e7eb'"
                              placeholder="What is this huddle about?"></textarea>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Add Members (email addresses)</label>
                    <div class="space-y-2">
                        <div class="flex space-x-2">
                            <input type="email" id="huddle-member-input" 
                                   class="flex-1 px-3 py-2 border rounded-lg focus:outline-none" 
                                   style="border-color: #e5e7eb;" 
                                   onfocus="this.style.borderColor='#7fc97f'" 
                                   onblur="this.style.borderColor='#e5e7eb'"
                                   placeholder="Enter email address"
                                   onkeypress="if(event.key==='Enter') { event.preventDefault(); addHuddleMember(); }">
                            <button onclick="addHuddleMember()" 
                                    class="px-3 py-2 rounded-lg" 
                                    style="background-color: #7fc97f; color: white;" 
                                    onmouseover="this.style.opacity='0.9'" 
                                    onmouseout="this.style.opacity='1'">
                                <i class="fas fa-plus"></i>
                            </button>
                        </div>
                        <div id="huddle-members-list" class="space-y-1 max-h-32 overflow-y-auto">
                            <!-- Members will be listed here -->
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="flex justify-end space-x-3 mt-6">
                <button onclick="closeHuddleModal()" class="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50">
                    Cancel
                </button>
                <button onclick="saveHuddle()" class="gradient-bg text-white px-4 py-2 rounded-lg hover:opacity-90">
                    <i class="fas fa-users mr-2"></i>Create Huddle
                </button>
            </div>
        </div>
    </div>
    
    <!-- Compose Email Modal will be dynamically created -->
    
    <script>
        // Global variables
        let authToken = '';
        let currentView = 'inbox';
        let selectedEmailId = null;
        let emails = [];
        let allLoadedEmails = []; // Store all loaded emails for the session
        let loadedPages = new Set(); // Track which pages have been loaded
        let currentPage = 0; // Start at 0, will be incremented before each load
        let isLoading = false;
        let hasMoreEmails = true;
        let totalEmailsLoaded = 0;
        let syncQueue = [];
        let userEmail = '';  // Store user's email address
        let isAutoLoading = false; // Track if we're in auto-loading mode
        
        // Store current search query globally
        let currentSearchQuery = '';
        let isSyncing = false;
        
        // Global navigation function
        function switchView(view) {
            currentView = view;
            
            // Stop auto-loading when leaving inbox
            if (view !== 'inbox') {
                isAutoLoading = false;
                console.log('Stopped auto-loading: switched to', view);
            }
            
            // Hide all views
            document.querySelectorAll('[id$="-view"]').forEach(el => el.classList.add('hidden'));
            
            // Show selected view
            const viewElement = document.getElementById(`${view}-view`);
            if (viewElement) {
                viewElement.classList.remove('hidden');
            }
            
            // Show/hide inbox controls (search and compose)
            const inboxControls = document.getElementById('inbox-controls');
            if (inboxControls) {
                if (view === 'inbox') {
                    inboxControls.style.display = 'flex';
                } else {
                    inboxControls.style.display = 'none';
                }
            }
            
            // Update nav links
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('bg-green-50', 'border-l-4', 'border-green-600', 'text-green-800', 'font-semibold');
                link.classList.add('text-gray-700', 'hover:bg-gray-100');
            });
            
            const activeLink = document.querySelector(`[onclick*="switchView('${view}')"]`);
            if (activeLink) {
                activeLink.classList.remove('text-gray-700', 'hover:bg-gray-100');
                activeLink.classList.add('bg-green-50', 'border-l-4', 'border-green-600', 'text-green-800', 'font-semibold');
            }
            
            // Load view-specific data
            if (view === 'actions' && typeof loadActionItems === 'function') {
                loadActionItems();
            } else if (view === 'huddles' && typeof loadHuddles === 'function') {
                loadHuddles();
            }
        }
        
        // Notification System
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            const bgColor = type === 'success' ? '#7fc97f' : type === 'error' ? '#ef4444' : '#3b82f6';
            
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background-color: ${bgColor};
                color: white;
                padding: 12px 24px;
                border-radius: 8px;
                box-shadow: 0 4px 6px rgba(0,0,0,0.1);
                z-index: 9999;
                animation: slideIn 0.3s ease-out;
            `;
            
            notification.innerHTML = `
                <div style="display: flex; align-items: center;">
                    <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'}" style="margin-right: 8px;"></i>
                    <span>${message}</span>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease-in';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }
        
        // Add animation styles
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideIn {
                from { transform: translateX(100%); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
            @keyframes slideOut {
                from { transform: translateX(0); opacity: 1; }
                to { transform: translateX(100%); opacity: 0; }
            }
        `;
        document.head.appendChild(style);
        
        // Push Notification Functions
        async function initializePushNotifications() {
            if ('Notification' in window) {
                if (Notification.permission === 'default') {
                    const permission = await Notification.requestPermission();
                    localStorage.setItem('notificationPermission', permission);
                    if (permission === 'granted') {
                        showNotification('Push notifications enabled for urgent emails!', 'success');
                    }
                } else if (Notification.permission === 'granted') {
                    console.log('Push notifications already enabled');
                }
            } else {
                console.log('Browser does not support notifications');
            }
        }
        
        function sendActionItemNotification(email, actionItems) {
            if (!('Notification' in window) || Notification.permission !== 'granted') {
                return;
            }
            
            const notification = new Notification('📋 SAIGBOX: New Action Items', {
                body: `Created ${actionItems.length} task(s) from: ${email.subject || 'Urgent Email'}`,
                icon: '/static/saigbox-logo.svg',
                badge: '/static/saigbox-logo.svg',
                tag: `actions-${email.id}`,
                requireInteraction: false,
                silent: false
            });
            
            notification.onclick = function() {
                window.focus();
                switchView('actions');
                notification.close();
            };
            
            // Auto-close after 5 seconds
            setTimeout(() => notification.close(), 5000);
        }
        
        function handleActionItemsCreated(data) {
            const { email, action_items } = data;
            
            // Update email in local state
            const emailIndex = emails.findIndex(e => e.id === email.id);
            if (emailIndex !== -1) {
                emails[emailIndex].auto_actions_created = true;
                emails[emailIndex].action_count = action_items.length;
            }
            
            // Send push notification
            sendActionItemNotification(email, action_items);
            
            // Update UI counts
            updateUrgentCount();
            loadActionItems(); // Refresh action items list
            
            // Show in-app toast as backup
            showNotification(
                `Created ${action_items.length} action item(s) from urgent email: ${email.subject}`, 
                'success'
            );
            
            // Re-render email list if in inbox view
            if (currentView === 'inbox') {
                if (currentFilter === 'urgent') {
                    filterEmails('urgent');
                } else {
                    renderEmailList(emails);
                }
            }
        }
        
        // Initialize
        document.addEventListener('DOMContentLoaded', async function() {
            // Initialize push notifications
            await initializePushNotifications();
            
            // First check if user is authenticated via session cookie
            try {
                const authCheckResponse = await fetch('/api/auth/check', {
                    credentials: 'include'
                });
                
                if (authCheckResponse.ok) {
                    const authData = await authCheckResponse.json();
                    if (authData.authenticated) {
                        // User is authenticated via session
                        authToken = localStorage.getItem('authToken') || 'session';
                        userEmail = authData.email || '';
                        init();
                        return;
                    }
                }
            } catch (error) {
                console.error('Auth check failed:', error);
            }
            
            // Check for token in URL (for backward compatibility)
            const urlParams = new URLSearchParams(window.location.search);
            const token = urlParams.get('token');
            
            if (token) {
                authToken = token;
                localStorage.setItem('authToken', token);
                window.history.replaceState({}, document.title, '/');
                init();
            } else {
                // Check localStorage token
                authToken = localStorage.getItem('authToken');
                if (authToken) {
                    // Verify token is still valid
                    try {
                        const response = await fetch('/api/user/me', {
                            headers: {
                                'Authorization': `Bearer ${authToken}`
                            }
                        });
                        if (response.ok) {
                            const userData = await response.json();
                            userEmail = userData.email || '';
                            init();
                        } else {
                            // Token is invalid, redirect to login
                            localStorage.removeItem('authToken');
                            window.location.href = '/login';
                        }
                    } catch (error) {
                        console.error('Token validation failed:', error);
                        window.location.href = '/login';
                    }
                } else {
                    // No authentication found, redirect to login
                    window.location.href = '/login';
                }
            }
        });
        
        function init() {
            loadEmails();
            setupEventListeners();
            setupInfiniteScroll();
            setupResizeHandler();
            startAutoSync();
            // Only use incremental sync - no full sync
            setTimeout(() => {
                console.log('Starting incremental sync from Gmail...');
                syncEmails(null, true); // Start continuous incremental sync
            }, 2000);
        }
        
        function setupEventListeners() {
            const searchInput = document.getElementById('search-input');
            const clearBtn = document.getElementById('clear-search');
            
            searchInput.addEventListener('input', function(e) {
                // Only show/hide clear button, don't trigger search or reload
                if (e.target.value.trim()) {
                    clearBtn.classList.remove('hidden');
                } else {
                    clearBtn.classList.add('hidden');
                    // Don't automatically reload emails here
                    // User must explicitly clear search or press Enter
                }
            });
            
            // Only search when Enter is pressed
            searchInput.addEventListener('keypress', function(event) {
                if (event.key === 'Enter') {
                    event.preventDefault();
                    searchEmails();
                }
            });
        }
        
        function clearSearch() {
            const searchInput = document.getElementById('search-input');
            const clearBtn = document.getElementById('clear-search');
            
            searchInput.value = '';
            clearBtn.classList.add('hidden');
            currentSearchQuery = '';
            
            // Restore all loaded emails without reloading from server
            emails = [...allLoadedEmails];
            applyCurrentFilter();
        }
        
        function setupResizeHandler() {
            const resizeHandle = document.getElementById('resize-handle');
            const emailListContainer = document.getElementById('email-list-container');
            const emailDetailContainer = document.getElementById('email-detail-container');
            
            if (!resizeHandle || !emailListContainer) return;
            
            let isResizing = false;
            let startX = 0;
            let startWidth = 0;
            
            resizeHandle.addEventListener('mousedown', (e) => {
                isResizing = true;
                startX = e.clientX;
                startWidth = emailListContainer.offsetWidth;
                
                // Add styling during resize
                document.body.style.cursor = 'col-resize';
                document.body.style.userSelect = 'none';
                resizeHandle.style.backgroundColor = '#60a5fa'; // Blue color when dragging
                
                e.preventDefault();
            });
            
            document.addEventListener('mousemove', (e) => {
                if (!isResizing) return;
                
                const diff = e.clientX - startX;
                const newWidth = Math.max(300, Math.min(800, startWidth + diff)); // Min 300px, Max 800px
                
                emailListContainer.style.width = newWidth + 'px';
                
                // Optional: Store the width preference in localStorage
                localStorage.setItem('emailListWidth', newWidth);
            });
            
            document.addEventListener('mouseup', () => {
                if (isResizing) {
                    isResizing = false;
                    document.body.style.cursor = '';
                    document.body.style.userSelect = '';
                    resizeHandle.style.backgroundColor = 'transparent';
                }
            });
            
            // Restore saved width if exists
            const savedWidth = localStorage.getItem('emailListWidth');
            if (savedWidth) {
                emailListContainer.style.width = savedWidth + 'px';
            }
        }
        
        function setupInfiniteScroll() {
            const emailList = document.getElementById('email-list');
            if (!emailList) {
                console.log('Email list element not found');
                return;
            }
            
            // The scrollable container is the parent div with overflow-y-auto
            const container = emailList.parentElement;
            console.log('Setting up infinite scroll on container:', container);
            
            // Scroll detection - acts as FALLBACK when auto-loading isn't active
            const checkScroll = () => {
                // Only trigger if auto-loading is not active
                if (isAutoLoading) {
                    return; // Auto-loading is handling it, don't interfere
                }
                
                const scrollTop = container.scrollTop;
                const scrollHeight = container.scrollHeight;
                const clientHeight = container.clientHeight;
                const distanceFromBottom = scrollHeight - scrollTop - clientHeight;
                
                // Only log when close to bottom to reduce console noise
                if (distanceFromBottom < 500) {
                    console.log('Scroll check (fallback):', { 
                        distanceFromBottom,
                        isLoading, 
                        hasMoreEmails,
                        isAutoLoading 
                    });
                }
                
                // Check if we're near the bottom (within 200px) - FALLBACK loading
                if (distanceFromBottom < 200) {
                    if (!isLoading && hasMoreEmails && !isAutoLoading) {
                        console.log('Fallback: Near bottom, loading more emails...', { currentPage, hasMoreEmails });
                        loadEmails(null, true); // Let loadEmails determine next page
                    }
                    // No button shown - sync happens automatically
                }
                
                // Also check if container is not full (for initial load) - FALLBACK
                if (scrollHeight <= clientHeight + 100 && !isLoading && hasMoreEmails && !isAutoLoading) {
                    console.log('Fallback: Container not full, loading more...', { scrollHeight, clientHeight });
                    setTimeout(() => {
                        if (!isLoading && hasMoreEmails && !isAutoLoading) {
                            loadEmails(null, true); // Let loadEmails determine next page
                        }
                    }, 500);
                }
            };
            
            // Remove any existing listeners first
            container.removeEventListener('scroll', checkScroll);
            
            // Add scroll listener
            container.addEventListener('scroll', checkScroll);
            
            // Also check periodically in case scroll doesn't trigger
            setInterval(() => {
                if (currentView === 'inbox' && hasMoreEmails && !isLoading) {
                    checkScroll();
                }
            }, 2000);
            
            // Initial check after a short delay
            setTimeout(checkScroll, 1000);
        }
        
        async function checkAndLoadMoreEmails() {
            // Simplified - just load more from DB
            if (!isLoading && hasMoreEmails) {
                loadEmails(currentPage + 1, true);
            }
        }
        
        function queueEmailSync(count) {
            syncQueue.push(count);
            processSyncQueue();
        }
        
        async function processSyncQueue() {
            if (isSyncing || syncQueue.length === 0) return;
            
            isSyncing = true;
            const batchSize = syncQueue.shift();
            
            try {
                const response = await fetch(`/api/emails/sync?max_results=${batchSize}`, {
                    method: 'POST',
                    headers: authToken !== 'session' ? {
                        'Authorization': `Bearer ${authToken}`
                    } : {},
                    credentials: 'include'
                });
                
                if (response.ok) {
                    const result = await response.json();
                    totalEmailsLoaded += result.emails_synced;
                    
                    // Load the newly synced emails
                    await loadEmails(currentPage + 1, true);
                }
            } catch (error) {
                console.error('Sync error:', error);
            } finally {
                isSyncing = false;
                // Process next item in queue if any
                if (syncQueue.length > 0) {
                    setTimeout(() => processeSyncQueue(), 1000);
                }
            }
        }
        
        
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }
        
        async function loadEmails(page = null, append = false) {
            if (isLoading) return; // Prevent multiple concurrent loads
            
            // Determine which page to load
            if (page === null) {
                if (append) {
                    page = currentPage + 1;
                } else {
                    // For initial load, check if we already have emails
                    if (allLoadedEmails.length > 0) {
                        // Just re-render existing emails, don't reload
                        emails = [...allLoadedEmails];
                        applyCurrentFilter();
                        return;
                    }
                    page = 1;
                }
            }
            
            // Check if this page was already loaded (unless we're refreshing for sync)
            if (loadedPages.has(page) && append) {
                console.log(`Page ${page} already loaded, skipping`);
                return;
            }
            
            try {
                isLoading = true; // Set loading flag
                console.log(`Loading page ${page}, append: ${append}`);
                
                // Show loader only if not auto-loading (to reduce visual noise)
                // For auto-loading, we could show a subtle indicator instead
                if (!isAutoLoading || !append) {
                    showLoader('email-loader');
                }
                
                // Load both inbox and sent emails
                const [inboxResponse, sentResponse] = await Promise.all([
                    fetch(`/api/emails/?page=${page}&limit=50`, {
                        headers: authToken !== 'session' ? {
                            'Authorization': `Bearer ${authToken}`
                        } : {},
                        credentials: 'include'
                    }),
                    fetch(`/api/emails/sent/?page=${page}&limit=50`, {
                        headers: authToken !== 'session' ? {
                            'Authorization': `Bearer ${authToken}`
                        } : {},
                        credentials: 'include'
                    })
                ]);
                
                if (!inboxResponse.ok) throw new Error('Failed to load emails');
                
                const inboxData = await inboxResponse.json();
                let newEmails = inboxData.emails || [];
                
                // Add sent emails if the endpoint exists and returns data
                if (sentResponse.ok) {
                    const sentData = await sentResponse.json();
                    const sentEmails = sentData.emails || [];
                    // Merge and deduplicate based on email ID
                    const emailIds = new Set(newEmails.map(e => e.id));
                    sentEmails.forEach(email => {
                        if (!emailIds.has(email.id)) {
                            newEmails.push(email);
                        }
                    });
                }
                
                // Deduplicate against all loaded emails
                const existingIds = new Set(allLoadedEmails.map(e => e.id));
                const uniqueNewEmails = newEmails.filter(e => !existingIds.has(e.id));
                
                if (uniqueNewEmails.length > 0) {
                    // Add to our master list
                    allLoadedEmails = [...allLoadedEmails, ...uniqueNewEmails];
                    
                    // Mark this page as loaded
                    loadedPages.add(page);
                    
                    // Update current page
                    currentPage = page;
                    
                    console.log(`Added ${uniqueNewEmails.length} new emails from page ${page}`);
                }
                
                // Update emails array with all loaded emails
                emails = [...allLoadedEmails];
                
                // Apply current filter and render
                applyCurrentFilter(append && uniqueNewEmails.length > 0 ? uniqueNewEmails : null);
                
                totalEmailsLoaded = allLoadedEmails.length;
                hasMoreEmails = inboxData.has_next;
                
                // Update no more emails indicator
                const noMoreEmails = document.getElementById('no-more-emails');
                if (noMoreEmails) {
                    if (!hasMoreEmails && append) {
                        // Show "no more emails" message only after an append operation
                        noMoreEmails.classList.remove('hidden');
                    } else {
                        noMoreEmails.classList.add('hidden');
                    }
                }
                
                updateUnreadCount();
                updateUrgentCount();
                hideLoader('email-loader');
                
                // AUTO-LOADING: After successful load, automatically load the next page
                if (hasMoreEmails && currentView === 'inbox' && !currentSearchQuery) {
                    // Small delay to prevent overwhelming the server
                    setTimeout(() => {
                        if (currentView === 'inbox' && hasMoreEmails && !isLoading) {
                            console.log(`Auto-loading next page: ${currentPage + 1}`);
                            isAutoLoading = true;
                            loadEmails(null, true);
                        }
                    }, 500); // 500ms delay between auto-loads
                } else {
                    isAutoLoading = false;
                    if (!hasMoreEmails) {
                        console.log('All emails loaded');
                    }
                }
            } catch (error) {
                console.error('Error loading emails:', error);
                hideLoader('email-loader');
                isAutoLoading = false;
            } finally {
                isLoading = false; // Always reset loading flag
            }
        }
        
        let currentFilter = 'all';
        let filteredEmails = [];
        
        function applyCurrentFilter(newEmailsToAppend = null) {
            // Filter emails based on current filter
            let emailsToShow;
            switch(currentFilter) {
                case 'sent':
                    emailsToShow = emails.filter(e => e.sender && e.sender.toLowerCase() === userEmail.toLowerCase());
                    break;
                case 'urgent':
                    emailsToShow = emails.filter(e => e.is_urgent && (!e.sender || e.sender.toLowerCase() !== userEmail.toLowerCase()));
                    break;
                case 'unread':
                    emailsToShow = emails.filter(e => !e.is_read && (!e.sender || e.sender.toLowerCase() !== userEmail.toLowerCase()));
                    break;
                case 'starred':
                    emailsToShow = emails.filter(e => e.is_starred && (!e.sender || e.sender.toLowerCase() !== userEmail.toLowerCase()));
                    break;
                default:
                    // Default to inbox (excluding sent)
                    emailsToShow = emails.filter(e => !e.sender || e.sender.toLowerCase() !== userEmail.toLowerCase());
            }
            
            filteredEmails = emailsToShow;
            
            if (newEmailsToAppend) {
                // Filter new emails and append only
                let filteredNew;
                switch(currentFilter) {
                    case 'sent':
                        filteredNew = newEmailsToAppend.filter(e => e.sender && e.sender.toLowerCase() === userEmail.toLowerCase());
                        break;
                    case 'urgent':
                        filteredNew = newEmailsToAppend.filter(e => e.is_urgent && (!e.sender || e.sender.toLowerCase() !== userEmail.toLowerCase()));
                        break;
                    case 'unread':
                        filteredNew = newEmailsToAppend.filter(e => !e.is_read && (!e.sender || e.sender.toLowerCase() !== userEmail.toLowerCase()));
                        break;
                    case 'starred':
                        filteredNew = newEmailsToAppend.filter(e => e.is_starred && (!e.sender || e.sender.toLowerCase() !== userEmail.toLowerCase()));
                        break;
                    default:
                        filteredNew = newEmailsToAppend.filter(e => !e.sender || e.sender.toLowerCase() !== userEmail.toLowerCase());
                }
                appendEmailsToList(filteredNew);
            } else {
                // Full render
                renderEmailList(emailsToShow);
            }
        }
        
        function filterEmails(filterType) {
            currentFilter = filterType;
            
            // Don't stop auto-loading when filtering - it should continue in background
            // Auto-loading will respect the current filter
            
            // First ensure we're in inbox view
            switchView('inbox');
            
            // Use all loaded emails for filtering
            emails = [...allLoadedEmails];
            
            // Apply filter
            switch(filterType) {
                case 'sent':
                    // Show only emails sent by the user
                    filteredEmails = emails.filter(e => e.sender && e.sender.toLowerCase() === userEmail.toLowerCase());
                    updateInboxHeader('Sent Mail', `${filteredEmails.length} sent email(s)`);
                    break;
                case 'urgent':
                    // Exclude sent emails from urgent filter
                    filteredEmails = emails.filter(e => e.is_urgent && (!e.sender || e.sender.toLowerCase() !== userEmail.toLowerCase()));
                    updateInboxHeader('Urgent Emails', `${filteredEmails.length} urgent email(s)`);
                    break;
                case 'unread':
                    // Exclude sent emails from unread filter
                    filteredEmails = emails.filter(e => !e.is_read && (!e.sender || e.sender.toLowerCase() !== userEmail.toLowerCase()));
                    updateInboxHeader('Unread Emails', `${filteredEmails.length} unread email(s)`);
                    break;
                case 'starred':
                    // Exclude sent emails from starred filter
                    filteredEmails = emails.filter(e => e.is_starred && (!e.sender || e.sender.toLowerCase() !== userEmail.toLowerCase()));
                    updateInboxHeader('Starred Emails', `${filteredEmails.length} starred email(s)`);
                    break;
                case 'all':
                default:
                    filterType = 'all';
                    // Exclude sent emails from inbox (all) filter
                    filteredEmails = emails.filter(e => !e.sender || e.sender.toLowerCase() !== userEmail.toLowerCase());
                    updateInboxHeader('Inbox', `${filteredEmails.length} email(s)`);
            }
            
            renderEmailList(filteredEmails);
            
            // Re-setup infinite scroll after filtering
            setTimeout(() => setupInfiniteScroll(), 100);
            
            // Update filter button styling
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('bg-blue-500', 'text-white');
                btn.classList.add('text-gray-700', 'hover:bg-gray-200');
            });
            
            const activeBtn = document.getElementById(`filter-${filterType}`);
            if (activeBtn) {
                activeBtn.classList.remove('text-gray-700', 'hover:bg-gray-200');
                activeBtn.classList.add('bg-blue-500', 'text-white');
            }
            
            // Update navigation highlighting
            document.querySelectorAll('.nav-item').forEach(item => {
                item.style.backgroundColor = 'transparent';
            });
        }
        
        function updateInboxHeader(title, subtitle) {
            const headerEl = document.querySelector('#inbox-view h2');
            if (headerEl) {
                headerEl.innerHTML = `
                    ${title}
                    ${subtitle ? `<span class="text-sm text-gray-600 ml-2">${subtitle}</span>` : ''}
                `;
            }
        }
        
        function updateUrgentCount() {
            const urgentUnread = emails.filter(e => e.is_urgent && !e.is_read).length;
            const urgentBadge = document.getElementById('urgent-badge');
            
            if (urgentBadge) {
                if (urgentUnread > 0) {
                    urgentBadge.textContent = urgentUnread;
                    urgentBadge.classList.remove('hidden');
                } else {
                    urgentBadge.classList.add('hidden');
                }
            }
        }
        
        function appendEmailsToList(newEmails) {
            const listEl = document.getElementById('email-list');
            
            // Escape HTML helper
            const escapeHtml = (str) => {
                if (!str) return '';
                const div = document.createElement('div');
                div.textContent = str;
                return div.innerHTML;
            };
            
            newEmails.forEach(email => {
                const emailEl = document.createElement('div');
                emailEl.dataset.emailId = email.id;
                emailEl.className = `email-item-card p-4 cursor-pointer ${!email.is_read ? 'bg-blue-50' : ''} ${email.is_urgent ? 'urgent-email' : ''}`;
                emailEl.style.overflowX = 'hidden';
                emailEl.style.width = '100%';
                emailEl.style.boxSizing = 'border-box';
                emailEl.innerHTML = `
                    <div class="flex items-start">
                        ${email.is_urgent ? '<i class="fas fa-exclamation-circle urgent-indicator mt-1"></i>' : ''}
                        <div class="flex-1 min-w-0">
                            <div class="flex justify-between items-start mb-1 gap-2">
                                <span class="font-medium text-sm ${!email.is_read ? 'font-semibold' : ''} truncate flex-1">${escapeHtml(email.sender_name || email.sender)}</span>
                                <span class="text-xs text-gray-500 whitespace-nowrap">${formatDate(email.received_at)}</span>
                            </div>
                            <div class="text-sm font-medium mb-1 truncate">${escapeHtml(email.subject || '(No subject)')}</div>
                            <div class="text-xs text-gray-600 truncate">${escapeHtml(email.snippet || '')}</div>
                            <div class="flex items-center mt-2 space-x-2">
                                ${email.is_starred ? '<i class="fas fa-star text-yellow-500 text-xs"></i>' : ''}
                                ${email.has_attachments ? '<i class="fas fa-paperclip text-gray-400 text-xs"></i>' : ''}
                                ${email.auto_actions_created ? `<span class="auto-action-badge"><i class="fas fa-tasks text-xs mr-1"></i>${email.action_count || 0} action(s) created</span>` : ''}
                            </div>
                        </div>
                    </div>
                `;
                listEl.appendChild(emailEl);
            });
        }
        
        function renderEmailList(emailList) {
            const listEl = document.getElementById('email-list');
            
            if (emailList.length === 0) {
                listEl.innerHTML = '<div class="p-4 text-center text-gray-500">No emails found</div>';
                return;
            }
            
            listEl.innerHTML = emailList.map(email => {
                // Escape HTML in email content to prevent XSS
                const escapeHtml = (str) => {
                    if (!str) return '';
                    const div = document.createElement('div');
                    div.textContent = str;
                    return div.innerHTML;
                };
                
                return `
                <div data-email-id="${escapeHtml(email.id)}" class="email-item-card p-4 cursor-pointer ${!email.is_read ? 'bg-blue-50' : ''} ${email.is_urgent ? 'urgent-email' : ''}" style="overflow-x: hidden; width: 100%; box-sizing: border-box;">
                    <div class="flex items-start">
                        ${email.is_urgent ? '<i class="fas fa-exclamation-circle urgent-indicator mt-1"></i>' : ''}
                        <div class="flex-1 min-w-0">
                            <div class="flex justify-between items-start mb-1 gap-2">
                                <span class="font-medium text-sm ${!email.is_read ? 'font-semibold' : ''} truncate flex-1">${escapeHtml(email.sender_name || email.sender)}</span>
                                <span class="text-xs text-gray-500 whitespace-nowrap">${formatDate(email.received_at)}</span>
                            </div>
                            <div class="text-sm font-medium mb-1 truncate">${escapeHtml(email.subject || '(No subject)')}</div>
                            <div class="text-xs text-gray-600 truncate">${escapeHtml(email.snippet || '')}</div>
                            <div class="flex items-center mt-2 space-x-2">
                                ${email.is_starred ? '<i class="fas fa-star text-yellow-500 text-xs"></i>' : ''}
                                ${email.has_attachments ? '<i class="fas fa-paperclip text-gray-400 text-xs"></i>' : ''}
                                ${email.auto_actions_created ? `<span class="auto-action-badge"><i class="fas fa-tasks text-xs mr-1"></i>${email.action_count || 0} action(s) created</span>` : ''}
                            </div>
                        </div>
                    </div>
                </div>
                `;
            }).join('');
            
            // Remove any existing event listener before adding new one
            listEl.removeEventListener('click', handleEmailClick);
            // Add event delegation for email clicks
            listEl.addEventListener('click', handleEmailClick);
        }
        
        function handleEmailClick(event) {
            const emailCard = event.target.closest('.email-item-card');
            if (emailCard) {
                const emailId = emailCard.dataset.emailId;
                if (emailId) {
                    selectEmail(emailId);
                }
            }
        }
        
        async function selectEmail(emailId) {
            selectedEmailId = emailId;
            // Find email from all loaded emails
            const email = allLoadedEmails.find(e => e.id === emailId);
            
            if (!email) return;
            
            // Mark as read if unread
            if (!email.is_read) {
                await markAsRead(emailId);
                email.is_read = true;
                // Update in all loaded emails
                const allEmailsIndex = allLoadedEmails.findIndex(e => e.id === emailId);
                if (allEmailsIndex !== -1) {
                    allLoadedEmails[allEmailsIndex].is_read = true;
                }
                emails = [...allLoadedEmails];
                applyCurrentFilter();
                updateUnreadCount();
            }
            
            // Display email detail
            const detailEl = document.getElementById('email-detail');
            
            // Create safe HTML for email details (without the body)
            detailEl.innerHTML = `
                <div class="fade-in">
                    <div class="mb-6">
                        <div class="flex justify-between items-start mb-4">
                            <h2 class="text-xl font-semibold">${email.subject || '(No subject)'}</h2>
                            <div class="flex space-x-2">
                                <button onclick="toggleUrgency('${emailId}')" class="text-gray-500 hover:text-red-500" title="${email.is_urgent ? 'Mark as not urgent' : 'Mark as urgent'}">
                                    <i class="fas fa-exclamation-circle ${email.is_urgent ? 'text-red-500' : ''}"></i>
                                </button>
                                <button onclick="toggleStar('${emailId}')" class="text-gray-500 hover:text-yellow-500">
                                    <i class="fas fa-star ${email.is_starred ? 'text-yellow-500' : ''}"></i>
                                </button>
                                <button onclick="deleteEmail('${emailId}')" class="text-gray-500 hover:text-red-500">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                        <div class="text-sm text-gray-600 mb-4">
                            <div class="mb-1"><strong>From:</strong> ${email.sender}</div>
                            <div class="mb-1"><strong>Date:</strong> ${formatDate(email.received_at)}</div>
                            ${email.recipients ? `<div><strong>To:</strong> ${email.recipients.join(', ')}</div>` : ''}
                        </div>
                        
                        <!-- AI Summary Section -->
                        <div id="ai-summary-section-${emailId}" class="mb-4 border border-gray-200 rounded-lg overflow-hidden">
                            <button onclick="toggleAISummary('${emailId}')" class="w-full bg-gradient-to-r from-green-50 to-blue-50 hover:from-green-100 hover:to-blue-100 p-3 flex items-center justify-between transition-colors">
                                <div class="flex items-center">
                                    <i class="fas fa-brain text-green-600 mr-2"></i>
                                    <span class="font-semibold text-gray-700">AI Summary</span>
                                </div>
                                <i id="ai-summary-arrow-${emailId}" class="fas fa-chevron-down text-gray-500 transition-transform"></i>
                            </button>
                            <div id="ai-summary-content-${emailId}" class="hidden bg-white p-4 max-h-96 overflow-y-auto">
                                <div class="text-center text-gray-500">
                                    <span class="text-sm">Click above to generate AI summary</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="prose max-w-none" id="email-body-content">
                        <!-- Email body will be safely inserted here -->
                    </div>
                    <div class="mt-6 flex flex-wrap gap-3">
                        <button onclick="replyToEmail('${emailId}')" class="gradient-bg text-white px-4 py-2 rounded-lg hover:opacity-90">
                            <i class="fas fa-reply mr-2"></i>Reply
                        </button>
                        <button onclick="replyAllToEmail('${emailId}')" class="px-4 py-2 rounded-lg hover:opacity-90" style="background-color: #6db56d; color: white;">
                            <i class="fas fa-reply-all mr-2"></i>Reply All
                        </button>
                        <button onclick="forwardEmail('${emailId}')" class="px-4 py-2 rounded-lg hover:opacity-90" style="background-color: #5fa55f; color: white;">
                            <i class="fas fa-share mr-2"></i>Forward
                        </button>
                        <button onclick="replySaig('${emailId}')" class="px-4 py-2 rounded-lg hover:opacity-90" style="background-color: #7fc97f; color: white;">
                            <i class="fas fa-leaf mr-2"></i>Reply with SAIG
                        </button>
                        <button onclick="createActionFromEmail('${emailId}')" class="px-4 py-2 rounded-lg hover:opacity-90" style="border: 1px solid #7fc97f; color: #7fc97f; background-color: rgba(127, 201, 127, 0.1);">
                            <i class="fas fa-tasks mr-2"></i>Create Action
                        </button>
                    </div>
                </div>
            `;
            
            // Now safely insert the email body content
            const bodyContainer = document.getElementById('email-body-content');
            if (bodyContainer) {
                if (email.body_html) {
                    // Create a temporary container to sanitize HTML
                    const tempDiv = document.createElement('div');
                    tempDiv.innerHTML = email.body_html;
                    
                    // Remove any script tags and event handlers
                    const scripts = tempDiv.getElementsByTagName('script');
                    for (let i = scripts.length - 1; i >= 0; i--) {
                        scripts[i].remove();
                    }
                    
                    // Remove on* event attributes
                    const allElements = tempDiv.getElementsByTagName('*');
                    for (let el of allElements) {
                        for (let attr of el.attributes) {
                            if (attr.name.startsWith('on')) {
                                el.removeAttribute(attr.name);
                            }
                        }
                    }
                    
                    bodyContainer.innerHTML = tempDiv.innerHTML;
                } else if (email.body_text) {
                    // Convert plain text to HTML with proper escaping
                    const escapedText = email.body_text
                        .replace(/&/g, '&amp;')
                        .replace(/</g, '&lt;')
                        .replace(/>/g, '&gt;')
                        .replace(/"/g, '&quot;')
                        .replace(/'/g, '&#039;')
                        .replace(/\n/g, '<br>');
                    bodyContainer.innerHTML = `<p>${escapedText}</p>`;
                } else if (email.snippet) {
                    // Use snippet as fallback
                    const escapedSnippet = email.snippet
                        .replace(/&/g, '&amp;')
                        .replace(/</g, '&lt;')
                        .replace(/>/g, '&gt;')
                        .replace(/"/g, '&quot;')
                        .replace(/'/g, '&#039;');
                    bodyContainer.innerHTML = `<p>${escapedSnippet}</p>`;
                }
            }
        }
        
        async function markAsRead(emailId) {
            try {
                await fetch(`/api/emails/${emailId}/read`, {
                    method: 'PUT',
                    headers: authToken !== 'session' ? {
                        'Authorization': `Bearer ${authToken}`
                    } : {},
                    credentials: 'include'
                });
            } catch (error) {
                console.error('Error marking as read:', error);
            }
        }
        
        async function toggleStar(emailId) {
            try {
                const response = await fetch(`/api/emails/${emailId}/star`, {
                    method: 'PUT',
                    headers: authToken !== 'session' ? {
                        'Authorization': `Bearer ${authToken}`
                    } : {},
                    credentials: 'include'
                });
                
                if (response.ok) {
                    const result = await response.json();
                    // Update in all loaded emails
                    const allEmailsIndex = allLoadedEmails.findIndex(e => e.id === emailId);
                    if (allEmailsIndex !== -1) {
                        allLoadedEmails[allEmailsIndex].is_starred = result.is_starred;
                    }
                    emails = [...allLoadedEmails];
                    applyCurrentFilter();
                    if (selectedEmailId === emailId) {
                        selectEmail(emailId);
                    }
                }
            } catch (error) {
                console.error('Error toggling star:', error);
            }
        }
        
        async function deleteEmail(emailId) {
            if (!confirm('Move this email to trash?')) return;
            
            try {
                const response = await fetch(`/api/emails/${emailId}`, {
                    method: 'DELETE',
                    headers: authToken !== 'session' ? {
                        'Authorization': `Bearer ${authToken}`
                    } : {},
                    credentials: 'include'
                });
                
                if (response.ok) {
                    // Show success notification
                    showNotification('Email moved to trash successfully', 'success');
                    
                    // Remove from all loaded emails
                    allLoadedEmails = allLoadedEmails.filter(e => e.id !== emailId);
                    emails = [...allLoadedEmails];
                    applyCurrentFilter();
                    document.getElementById('email-detail').innerHTML = `
                        <div class="text-center text-gray-500 mt-20">
                            <i class="fas fa-envelope-open text-6xl mb-4 text-gray-300"></i>
                            <p>Select an email to view</p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error deleting email:', error);
            }
        }
        
        async function toggleUrgency(emailId) {
            const email = emails.find(e => e.id === emailId);
            if (!email) return;
            
            const newStatus = !email.is_urgent;
            
            try {
                const response = await fetch(`/api/emails/${emailId}/urgency`, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json',
                        ...(authToken !== 'session' ? { 'Authorization': `Bearer ${authToken}` } : {})
                    },
                    credentials: 'include',
                    body: JSON.stringify({ is_urgent: newStatus })
                });
                
                if (response.ok) {
                    // Update local state
                    email.is_urgent = newStatus;
                    // Update in all loaded emails
                    const allEmailsIndex = allLoadedEmails.findIndex(e => e.id === emailId);
                    if (allEmailsIndex !== -1) {
                        allLoadedEmails[allEmailsIndex].is_urgent = newStatus;
                    }
                    
                    // Learn from correction
                    await fetch('/api/emails/urgency/learn', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            ...(authToken !== 'session' ? { 'Authorization': `Bearer ${authToken}` } : {})
                        },
                        credentials: 'include',
                        body: JSON.stringify({
                            email_id: emailId,
                            corrected_to: newStatus
                        })
                    });
                    
                    // Update UI
                    emails = [...allLoadedEmails];
                    applyCurrentFilter();
                    updateUrgentCount();
                    selectEmail(emailId); // Refresh detail view
                    
                    showNotification(
                        newStatus ? 'Email marked as urgent' : 'Email marked as not urgent',
                        'success'
                    );
                }
            } catch (error) {
                console.error('Error toggling urgency:', error);
                showNotification('Failed to update urgency status', 'error');
            }
        }
        
        async function syncEmails(pageToken = null, continuous = false) {
            try {
                const syncBtn = document.querySelector('.fa-sync-alt');
                const syncStatus = document.getElementById('sync-status');
                
                if (!continuous) {
                    syncBtn.classList.add('fa-spin');
                    if (syncStatus) syncStatus.textContent = 'Syncing...';
                }
                
                // Build request body
                const requestBody = {
                    max_results: 50
                };
                if (pageToken) {
                    requestBody.page_token = pageToken;
                }
                
                const response = await fetch('/api/emails/sync', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        ...(authToken !== 'session' ? {'Authorization': `Bearer ${authToken}`} : {})
                    },
                    body: JSON.stringify(requestBody),
                    credentials: 'include'
                });
                
                if (response.ok) {
                    const result = await response.json();
                    console.log('Sync response:', result);
                    
                    // Check if using fallback or cached data
                    if (result.fallback || result.cached) {
                        console.log('Sync using fallback/cached mode:', result.message);
                        if (!continuous) {
                            showNotification(result.message || 'Using cached emails', 'info');
                        }
                    } else {
                        // Normal sync succeeded
                        console.log(`Sync successful: ${result.emails_synced} emails, has_more: ${result.has_more}`);
                        if (!continuous) {
                            if (syncStatus) syncStatus.textContent = `Last sync: ${new Date().toLocaleTimeString()}`;
                        }
                        
                        // If new emails were synced, fetch and display them
                        if (result.emails_synced > 0) {
                            // Reload the current page to show new emails
                            await loadEmails(1, false);
                        }
                        
                        // Continue fetching if there are more emails
                        if (result.has_more) {
                            console.log('More emails available, continuing sync...');
                            // Continue syncing in background
                            setTimeout(() => {
                                syncEmails(null, true); // Let backend manage the token
                            }, 1000);
                        } else if (!continuous) {
                            // Show sync results only for manual sync
                            let message = `Synced ${result.emails_synced || 0} new email(s)`;
                            if (result.failed > 0) {
                                message += ` (${result.failed} failed)`;
                            }
                            showNotification(message, 'success');
                        }
                    }
                    
                    // Update counts
                    updateUrgentCount();
                } else {
                    if (!continuous) {
                        showNotification('Failed to sync emails', 'error');
                    }
                }
                
                if (!continuous) {
                    syncBtn.classList.remove('fa-spin');
                }
            } catch (error) {
                console.error('Error syncing emails:', error);
                if (!continuous) {
                    document.querySelector('.fa-sync-alt').classList.remove('fa-spin');
                    showNotification('Sync error: ' + error.message, 'error');
                }
            }
        }
        
        
        
        async function searchEmails() {
            const query = document.getElementById('search-input').value.trim();
            const searchInput = document.getElementById('search-input');
            const useSemanticSearch = document.getElementById('semantic-search-toggle')?.checked ?? true;
            
            // Stop auto-loading when searching
            isAutoLoading = false;
            console.log('Stopped auto-loading: search initiated');
            
            if (!query) {
                // Don't reload automatically when search is empty
                // User must explicitly clear the search
                return;
            }
            
            // Store the current search query
            currentSearchQuery = query;
            
            // Show loading state
            searchInput.disabled = true;
            searchInput.classList.add('opacity-75');
            
            // Show semantic search indicator if enabled
            if (useSemanticSearch) {
                searchInput.placeholder = 'AI searching...';
            }
            
            try {
                // Use the GET endpoint with search parameter and semantic flag
                const url = `/api/emails/?search=${encodeURIComponent(query)}&semantic=${useSemanticSearch}&limit=50`;
                const response = await fetch(url, {
                    method: 'GET',
                    headers: authToken !== 'session' ? {
                        'Authorization': `Bearer ${authToken}`
                    } : {},
                    credentials: 'include'
                });
                
                if (response.ok) {
                    const data = await response.json();
                    const searchResults = data.emails || [];
                    
                    // Update the global emails array with search results
                    emails = searchResults;
                    
                    // Render the search results
                    renderEmailList(searchResults);
                    
                    // Update count display
                    updateUnreadCount();
                    
                    // Show info about search results
                    const searchType = useSemanticSearch ? 'AI search' : 'keyword search';
                    if (searchResults.length === 0) {
                        showNotification(`No emails found for "${query}" using ${searchType}`, 'info');
                    } else {
                        showNotification(`Found ${searchResults.length} email${searchResults.length !== 1 ? 's' : ''} using ${searchType}`, 'success');
                    }
                } else {
                    console.error('Search failed:', response.status, response.statusText);
                    showNotification('Search failed. Please try again.', 'error');
                }
            } catch (error) {
                console.error('Error searching emails:', error);
                showNotification('Error searching emails', 'error');
            } finally {
                // Reset loading state
                searchInput.disabled = false;
                searchInput.classList.remove('opacity-75');
                updateSearchPlaceholder();
            }
        }
        
        function updateSearchPlaceholder() {
            const searchInput = document.getElementById('search-input');
            const useSemanticSearch = document.getElementById('semantic-search-toggle')?.checked ?? true;
            searchInput.placeholder = useSemanticSearch ? 'Search emails (AI-powered)...' : 'Search emails (keyword)...';
        }
        
        function switchView(view) {
            currentView = view;
            
            // Hide all views
            document.querySelectorAll('[id$="-view"]').forEach(el => el.classList.add('hidden'));
            
            // Show selected view
            document.getElementById(`${view}-view`).classList.remove('hidden');
            
            // Show/hide inbox controls (search and compose)
            const inboxControls = document.getElementById('inbox-controls');
            if (view === 'inbox') {
                inboxControls.style.display = 'flex';
            } else {
                inboxControls.style.display = 'none';
            }
            
            // Update title
            const titles = {
                'inbox': 'Inbox',
                'actions': 'Action Items',
                'huddles': 'Huddles',
                'trash': 'Trash',
                'saig': 'SAIG'
            };
            document.getElementById('view-title').textContent = titles[view];
            
            // Load view data
            if (view === 'actions') loadActionItems();
            else if (view === 'huddles') loadHuddles();
            else if (view === 'trash') loadTrash();
            else if (view === 'saig') {
                // Focus on SAIG input when switching to view
                setTimeout(() => {
                    const input = document.getElementById('saig-main-input');
                    if (input) input.focus();
                }, 100);
            }
        }
        
        async function loadActionItems() {
            try {
                const response = await fetch('/api/actions', {
                    headers: authToken !== 'session' ? {
                        'Authorization': `Bearer ${authToken}`
                    } : {},
                    credentials: 'include'
                });
                
                if (response.ok) {
                    const data = await response.json();
                    renderActionItems(data.actions || data || []);
                } else {
                    console.warn(`Action items endpoint returned ${response.status}`);
                    // Show empty state instead of error for graceful degradation
                    renderActionItems([]);
                }
            } catch (error) {
                console.error('Error loading action items:', error);
                // Show empty state on error
                renderActionItems([]);
            }
        }
        
        function renderActionItems(actions) {
            const listEl = document.getElementById('action-list');
            
            if (!actions || actions.length === 0) {
                listEl.innerHTML = `
                    <div class="text-center py-12">
                        <i class="fas fa-tasks text-6xl text-gray-300 mb-4"></i>
                        <p class="text-gray-500 mb-4">No action items yet</p>
                        <button onclick="showCreateActionModal()" class="gradient-bg text-white px-4 py-2 rounded-lg hover:opacity-90">
                            <i class="fas fa-plus mr-2"></i>Create Your First Action
                        </button>
                    </div>
                `;
                return;
            }
            
            listEl.innerHTML = actions.map(action => `
                <div class="bg-white p-4 rounded-lg shadow">
                    <div class="flex justify-between items-start">
                        <div class="flex-1">
                            <h4 class="font-medium ${action.status === 'completed' ? 'line-through text-gray-500' : ''}">${action.title}</h4>
                            ${action.description ? `<p class="text-sm text-gray-600 mt-1">${action.description}</p>` : ''}
                            <div class="flex items-center space-x-4 mt-2 text-xs text-gray-500">
                                <span class="priority-${action.priority}">
                                    <i class="fas fa-flag mr-1"></i>${action.priority}
                                </span>
                                ${action.due_date ? `<span><i class="fas fa-clock mr-1"></i>${formatDate(action.due_date)}</span>` : ''}
                            </div>
                        </div>
                        <div class="flex space-x-2">
                            ${action.status !== 'completed' ? `
                                <button onclick="completeAction('${action.id}')" style="color: #7fc97f;" onmouseover="this.style.color='#6db56d'" onmouseout="this.style.color='#7fc97f'">
                                    <i class="fas fa-check"></i>
                                </button>
                            ` : ''}
                            <button onclick="deleteAction('${action.id}')" class="text-red-500 hover:text-red-600">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
            
            // Update count
            document.getElementById('action-count').textContent = actions.filter(a => a.status === 'pending').length;
        }
        
        function renderHuddles(huddles) {
            const listEl = document.getElementById('huddle-list');
            
            if (huddles.length === 0) {
                listEl.innerHTML = '<div class="col-span-2 text-center text-gray-500">No huddles yet</div>';
                return;
            }
            
            listEl.innerHTML = huddles.map(huddle => `
                <div class="bg-white p-4 rounded-lg shadow hover:shadow-md transition cursor-pointer" onclick="openHuddle('${huddle.id}')">
                    <h4 class="font-medium mb-2">${huddle.name}</h4>
                    ${huddle.description ? `<p class="text-sm text-gray-600 mb-3">${huddle.description}</p>` : ''}
                    <div class="flex items-center justify-between text-xs text-gray-500">
                        <span><i class="fas fa-users mr-1"></i>${huddle.members.length} members</span>
                        <span>${huddle.status}</span>
                    </div>
                </div>
            `).join('');
        }
        
        async function loadTrash() {
            try {
                const response = await fetch('/api/trash', {
                    headers: authToken !== 'session' ? {
                        'Authorization': `Bearer ${authToken}`
                    } : {},
                    credentials: 'include'
                });
                
                if (response.ok) {
                    const data = await response.json();
                    renderTrash(data.emails || data || []);
                }
            } catch (error) {
                console.error('Error loading trash:', error);
            }
        }
        
        function renderTrash(trashedEmails) {
            const listEl = document.getElementById('trash-list');
            const countEl = document.getElementById('trash-count');
            
            // Update count in header
            if (countEl) {
                countEl.textContent = `(${trashedEmails.length})`;
            }
            
            if (trashedEmails.length === 0) {
                listEl.innerHTML = '<div class="text-center text-gray-500 p-8">Trash is empty</div>';
                // Hide bulk action buttons when trash is empty
                const bulkActions = document.getElementById('trash-bulk-actions');
                if (bulkActions) bulkActions.style.display = 'none';
                return;
            }
            
            // Show bulk action buttons when there are items
            const bulkActions = document.getElementById('trash-bulk-actions');
            if (bulkActions) bulkActions.style.display = 'flex';
            
            // Helper function to escape HTML
            const escapeHtml = (str) => {
                if (!str) return '';
                const div = document.createElement('div');
                div.textContent = str;
                return div.innerHTML;
            };
            
            listEl.innerHTML = trashedEmails.map(email => `
                <div data-email-id="${escapeHtml(email.id)}" class="trash-email-card bg-white p-4 rounded-lg shadow mb-3 hover:shadow-md transition-shadow">
                    <div class="flex items-start">
                        <div class="mr-3 pt-1">
                            <input type="checkbox" 
                                   class="trash-email-checkbox" 
                                   data-email-id="${escapeHtml(email.id)}"
                                   onclick="event.stopPropagation(); updateTrashSelection()">
                        </div>
                        <div class="flex-1 min-w-0 mr-4 cursor-pointer" onclick="viewTrashedEmail('${escapeHtml(email.id)}')">
                            <div class="flex justify-between items-start mb-1 gap-2">
                                <span class="font-medium text-sm truncate flex-1">${escapeHtml(email.sender_name || email.sender)}</span>
                                <span class="text-xs text-gray-500 whitespace-nowrap">${formatDate(email.received_at)}</span>
                            </div>
                            <div class="text-sm font-medium mb-1 truncate">${escapeHtml(email.subject || '(No subject)')}</div>
                            <div class="text-xs text-gray-600 truncate">${escapeHtml(email.snippet || '')}</div>
                            <div class="flex items-center mt-2 space-x-2 text-xs text-gray-400">
                                <span><i class="fas fa-trash-alt mr-1"></i>Deleted ${formatDate(email.deleted_at)}</span>
                                ${email.has_attachments ? '<i class="fas fa-paperclip text-gray-400"></i>' : ''}
                            </div>
                        </div>
                        <div class="flex flex-col space-y-2">
                            <button onclick="event.stopPropagation(); restoreEmail('${escapeHtml(email.id)}')" class="text-blue-500 hover:text-blue-600 text-sm">
                                <i class="fas fa-undo"></i> Restore
                            </button>
                            <button onclick="event.stopPropagation(); permanentlyDelete('${escapeHtml(email.id)}')" class="text-red-500 hover:text-red-600 text-sm">
                                <i class="fas fa-times"></i> Delete
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
            
            // Reset select all checkbox
            const selectAllCheckbox = document.getElementById('trash-select-all');
            if (selectAllCheckbox) selectAllCheckbox.checked = false;
        }
        
        // SAIG Chat Functions
        function toggleChat() {
            const container = document.getElementById('chat-container');
            container.classList.toggle('hidden');
            if (!container.classList.contains('hidden')) {
                initializeDraggable();
            }
        }
        
        // Make SAIG chat draggable
        function initializeDraggable() {
            const chatContainer = document.getElementById('chat-container');
            const chatHeader = document.getElementById('chat-header');
            
            let isDragging = false;
            let currentX;
            let currentY;
            let initialX;
            let initialY;
            let xOffset = 0;
            let yOffset = 0;
            
            // Get current position if already set
            const rect = chatContainer.getBoundingClientRect();
            xOffset = rect.left;
            yOffset = rect.top;
            
            chatHeader.addEventListener('mousedown', dragStart);
            document.addEventListener('mousemove', drag);
            document.addEventListener('mouseup', dragEnd);
            
            function dragStart(e) {
                if (e.target.closest('button')) return; // Don't drag when clicking close button
                
                initialX = e.clientX - xOffset;
                initialY = e.clientY - yOffset;
                
                if (e.target === chatHeader || chatHeader.contains(e.target)) {
                    isDragging = true;
                    chatContainer.style.transition = 'none';
                }
            }
            
            function drag(e) {
                if (isDragging) {
                    e.preventDefault();
                    currentX = e.clientX - initialX;
                    currentY = e.clientY - initialY;
                    
                    xOffset = currentX;
                    yOffset = currentY;
                    
                    // Ensure the chat doesn't go off screen
                    const maxX = window.innerWidth - chatContainer.offsetWidth;
                    const maxY = window.innerHeight - chatContainer.offsetHeight;
                    
                    currentX = Math.min(Math.max(0, currentX), maxX);
                    currentY = Math.min(Math.max(0, currentY), maxY);
                    
                    chatContainer.style.transform = 'none';
                    chatContainer.style.left = currentX + 'px';
                    chatContainer.style.top = currentY + 'px';
                    chatContainer.style.bottom = 'auto';
                    chatContainer.style.right = 'auto';
                }
            }
            
            function dragEnd(e) {
                initialX = currentX;
                initialY = currentY;
                isDragging = false;
                chatContainer.style.transition = '';
            }
        }
        
        // Store SAIG context for maintaining state across messages
        // Use closure to maintain context without global pollution
        let saigContext = {};
        
        // Single function to handle all SAIG interactions
        const sendMessage = async function(directMessage = null) {
            console.log('=== sendMessage called ===');
            console.log('Direct message:', directMessage);
            console.log('saigContext at start:', saigContext);
            
            const input = document.getElementById('chat-input');
            const message = directMessage || input.value.trim();
            
            console.log('Message to send:', message);
            console.log('Current saigContext:', saigContext);
            
            if (!message) {
                console.log('No message, returning');
                return;
            }
            
            // Add user message
            addChatMessage(message, 'user');
            if (!directMessage) {
                input.value = '';
            }
            
            // Build context including any pending operations and selected email
            const selectedEmail = selectedEmailId ? emails.find(e => e.id === selectedEmailId) : null;
            const fullContext = {
                ...saigContext,
                ...(selectedEmail ? { 
                    selected_email: {
                        id: selectedEmail.id,
                        subject: selectedEmail.subject,
                        sender: selectedEmail.sender_name || selectedEmail.sender,
                        date: selectedEmail.received_at
                    }
                } : {})
            };
            
            console.log('Full context being sent:', JSON.stringify(fullContext, null, 2));
            console.log('Message being sent:', message);
            
            // Send to SAIG
            try {
                const response = await fetch('/api/saig/chat', {
                    method: 'POST',
                    headers: authToken !== 'session' ? {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    } : {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include',
                    body: JSON.stringify({
                        message: message,
                        context: fullContext
                    })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    console.log('=== Response received ===');
                    console.log('Full response:', result);
                    console.log('Response text length:', result.response?.length);
                    console.log('Actions taken:', result.actions_taken);
                    console.log('Context in response:', result.context);
                    
                    // Update SAIG context if provided
                    if (result.context) {
                        console.log('Updating saigContext with:', result.context);
                        saigContext = result.context;
                        console.log('saigContext after update:', saigContext);
                    } else {
                        console.log('No context in response');
                    }
                    
                    addChatMessage(result.response, 'assistant');
                    
                    // Check if the response indicates trash action was completed
                    if (result.actions_taken && result.actions_taken.includes('emails_moved_to_trash')) {
                        // Clear pending delete from context
                        delete saigContext.pending_delete;
                        // Close the email detail view if open
                        const detailContainer = document.getElementById('email-detail-container');
                        if (detailContainer) {
                            detailContainer.innerHTML = '<div class="flex items-center justify-center h-full text-gray-500">Select an email to view</div>';
                        }
                        selectedEmailId = null;
                        
                        // Reload the email list
                        await loadEmails();
                        
                        // Show notification
                        showNotification('Emails moved to trash successfully', 'success');
                    }
                }
            } catch (error) {
                console.error('Error sending message:', error);
                addChatMessage('Sorry, I encountered an error. Please try again.', 'assistant');
                // Clear context on error
                saigContext = {};
            }
        }
        
        // Make sendMessage available globally for the main chat input button
        window.sendMessage = sendMessage;
        
        // Comprehensive trash operation handler with error recovery
        const handleTrashOperation = (messageText) => {
            console.log('=== Trash Operation Handler ===');
            console.log('Message:', messageText);
            console.log('Current context:', saigContext);
            
            // Validate context for trash operations
            if (messageText === 'Yes, move all to trash' || messageText === 'Yes, move to trash') {
                if (!saigContext.pending_delete) {
                    console.error('No pending_delete in context!');
                    addChatMessage('Error: Lost track of which emails to delete. Please try again.', 'assistant');
                    return;
                }
                
                const emailCount = saigContext.pending_delete.emails ? saigContext.pending_delete.emails.length : 0;
                console.log(`Processing ${emailCount} emails for trash`);
                
                if (emailCount === 0) {
                    console.error('No emails in pending_delete!');
                    addChatMessage('Error: No emails selected for deletion. Please try again.', 'assistant');
                    return;
                }
            }
            
            // Execute the trash operation
            sendMessage(messageText).catch(error => {
                console.error('Trash operation failed:', error);
                addChatMessage('Failed to move emails to trash. Please try again.', 'assistant');
                // Don't clear context on error - allow retry
            });
        };
        
        // SAIG Full View Functions
        async function sendSaigMessage() {
            const input = document.getElementById('saig-main-input');
            const message = input.value.trim();
            
            if (!message) return;
            
            // Add user message to chat
            const messagesEl = document.getElementById('saig-main-messages');
            const messageContainer = messagesEl.querySelector('.max-w-3xl');
            
            const userMsgEl = document.createElement('div');
            userMsgEl.className = 'text-white rounded-lg p-4 ml-auto max-w-lg mb-4';
            userMsgEl.style.backgroundColor = '#7fc97f';
            userMsgEl.textContent = message;
            messageContainer.appendChild(userMsgEl);
            
            input.value = '';
            
            // Show typing indicator
            const typingEl = document.createElement('div');
            typingEl.className = 'bg-gray-100 rounded-lg p-4 max-w-lg mb-4';
            typingEl.innerHTML = '<div class="flex space-x-2"><div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce"></div><div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 0.1s"></div><div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 0.2s"></div></div>';
            messageContainer.appendChild(typingEl);
            
            // Scroll to bottom
            messagesEl.scrollTop = messagesEl.scrollHeight;
            
            // Send to SAIG API
            try {
                const response = await fetch('/api/saig/chat', {
                    method: 'POST',
                    headers: authToken !== 'session' ? {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    } : {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include',
                    body: JSON.stringify({ message })
                });
                
                // Remove typing indicator
                typingEl.remove();
                
                if (response.ok) {
                    const data = await response.json();
                    const aiMsgEl = document.createElement('div');
                    aiMsgEl.className = 'bg-white rounded-lg p-4 shadow max-w-lg mb-4';
                    aiMsgEl.innerHTML = `<p class="text-gray-700">${data.response}</p>`;
                    messageContainer.appendChild(aiMsgEl);
                    
                    // Check if the response indicates trash action was completed
                    if (data.actions_taken && data.actions_taken.includes('emails_moved_to_trash')) {
                        // Close the email detail view if open
                        const detailContainer = document.getElementById('email-detail-container');
                        if (detailContainer) {
                            detailContainer.innerHTML = '<div class="flex items-center justify-center h-full text-gray-500">Select an email to view</div>';
                        }
                        selectedEmailId = null;
                        
                        // Reload the email list
                        await loadEmails();
                        
                        // Show notification
                        showNotification('Emails moved to trash successfully', 'success');
                    }
                    
                    // Scroll to bottom
                    messagesEl.scrollTop = messagesEl.scrollHeight;
                }
            } catch (error) {
                console.error('Error sending message to SAIG:', error);
                typingEl.remove();
                const errorEl = document.createElement('div');
                errorEl.className = 'bg-red-50 border border-red-200 text-red-700 rounded-lg p-4 max-w-lg mb-4';
                errorEl.textContent = 'Sorry, I encountered an error. Please try again.';
                messageContainer.appendChild(errorEl);
            }
        }
        
        function askSaig(question) {
            document.getElementById('saig-main-input').value = question;
            sendSaigMessage();
        }
        
        function addChatMessage(message, role) {
            const messagesEl = document.getElementById('chat-messages');
            const messageEl = document.createElement('div');
            
            if (role === 'user') {
                messageEl.className = 'text-white rounded-lg p-3 max-w-[80%] ml-auto';
                messageEl.style.backgroundColor = '#7fc97f';
                messageEl.innerHTML = `<p class="text-sm">${message}</p>`;
            } else {
                messageEl.className = 'bg-gray-100 rounded-lg p-3 max-w-[80%]';
                // For assistant messages, allow HTML to support draft buttons and formatting
                const content = message.includes('<div') || message.includes('<button') ? message : `<p class="text-sm">${message}</p>`;
                messageEl.innerHTML = content;
                
                // Replace onclick attributes with data attributes and attach event listeners
                const buttons = messageEl.querySelectorAll('button[onclick]');
                buttons.forEach(button => {
                    const onclickAttr = button.getAttribute('onclick');
                    if (onclickAttr) {
                        // Parse different types of onclick handlers
                        if (onclickAttr.includes('sendMessage')) {
                            const match = onclickAttr.match(/sendMessage\(['"]([^'"]*)['"]\)/);
                            if (match) {
                                button.setAttribute('data-action', 'send-message');
                                button.setAttribute('data-message', match[1]);
                            }
                        }
                        // Remove the onclick attribute
                        button.removeAttribute('onclick');
                        
                        // Attach event listener using arrow function for scope preservation
                        button.addEventListener('click', (e) => {
                            e.preventDefault();
                            const action = button.getAttribute('data-action');
                            const messageText = button.getAttribute('data-message');
                            
                            if (action === 'send-message') {
                                console.log('Lambda button click:', messageText);
                                console.log('Context at click time:', saigContext);
                                
                                // Use specialized handler for trash operations
                                if (messageText.toLowerCase().includes('trash') || messageText.toLowerCase() === 'cancel') {
                                    handleTrashOperation(messageText);
                                } else {
                                    sendMessage(messageText);
                                }
                            }
                        });
                    }
                });
            }
            
            messagesEl.appendChild(messageEl);
            messagesEl.scrollTop = messagesEl.scrollHeight;
        }
        
        // Enhanced Compose Modal Functions
        window.currentAttachments = [];
        window.currentDraftId = null;
        
        // Store huddle context globally for compose modal
        let currentComposeHuddleId = null;
        
        function showComposeModal(mode = 'compose', originalEmail = null) {
            // Handle both mode parameter and huddle data object
            let huddleData = null;
            if (typeof mode === 'object') {
                huddleData = mode;
                currentComposeHuddleId = huddleData.huddle_id || null;
                mode = 'compose';
            } else {
                currentComposeHuddleId = null;
            }
            
            const isReply = mode === 'reply';
            const isReplyAll = mode === 'reply_all';
            const isForward = mode === 'forward';
            
            // Prepare subject and content based on mode
            let defaultSubject = '';
            let defaultTo = '';
            let defaultCc = '';
            let defaultBody = '';
            
            if (huddleData) {
                // Pre-fill for huddle compose
                defaultTo = Array.isArray(huddleData.to) ? huddleData.to.join(', ') : huddleData.to;
                defaultSubject = huddleData.subject || '';
                defaultBody = huddleData.body || '';
            } else if (originalEmail) {
                if (isReply || isReplyAll) {
                    defaultSubject = originalEmail.subject.startsWith('Re: ') ? originalEmail.subject : `Re: ${originalEmail.subject}`;
                    defaultTo = originalEmail.sender_email || originalEmail.sender;
                    
                    if (isReplyAll && originalEmail.recipients) {
                        const recipients = originalEmail.recipients.split(',').map(r => r.trim());
                        defaultCc = recipients.filter(r => r && !r.includes('me')).join(', ');
                    }
                    
                    defaultBody = `<br><br>------- Original Message -------<br>From: ${originalEmail.sender_name || originalEmail.sender_email || originalEmail.sender}<br>Date: ${new Date(originalEmail.received_at || originalEmail.date).toLocaleString()}<br>Subject: ${originalEmail.subject}<br><br>${originalEmail.body_text || originalEmail.snippet || ''}`;
                } else if (isForward) {
                    defaultSubject = originalEmail.subject.startsWith('Fwd: ') ? originalEmail.subject : `Fwd: ${originalEmail.subject}`;
                    defaultBody = `<br><br>------- Forwarded Message -------<br>From: ${originalEmail.sender_name || originalEmail.sender_email || originalEmail.sender}<br>Date: ${new Date(originalEmail.received_at || originalEmail.date).toLocaleString()}<br>To: ${originalEmail.recipients || ''}<br>Subject: ${originalEmail.subject}<br><br>${originalEmail.body_text || originalEmail.snippet || ''}`;
                }
            }
            
            const modalTitle = huddleData ? `Compose to ${huddleData.huddle_name || 'Huddle'}` :
                              isReply ? 'Reply to Email' : isReplyAll ? 'Reply All' : 
                              isForward ? 'Forward Email' : 'Compose Email';
            
            const modalHtml = `
                <div id="compose-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4" onclick="if(event.target === this) closeComposeModal()">
                    <div class="bg-white rounded-xl shadow-2xl w-full max-w-4xl max-h-[90vh] flex flex-col" onclick="event.stopPropagation()" style="max-height: 90vh;">
                        <!-- Modal Header -->
                        <div class="flex items-center justify-between p-6 border-b" style="border-color: #e5e7eb;">
                            <h2 class="text-2xl font-bold" style="color: #111827;">${modalTitle}</h2>
                            <button onclick="closeComposeModal()" class="text-gray-400 hover:text-gray-600 transition-colors">
                                <i class="fas fa-times text-xl"></i>
                            </button>
                        </div>
                        
                        <!-- Modal Body -->
                        <div class="flex-1 overflow-y-auto p-6">
                            <form id="composeForm" class="space-y-4">
                                <!-- To Field -->
                                <div>
                                    <label class="block text-sm font-medium mb-2" style="color: #374151;">To:</label>
                                    <input type="email" id="composeTo" name="to" value="${defaultTo}" required 
                                           class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:outline-none"
                                           style="border-color: #d1d5db; --tw-ring-color: #7fc97f;"
                                           placeholder="Enter email addresses (separate with commas)">
                                </div>
                                
                                <!-- CC Field -->
                                <div>
                                    <label class="block text-sm font-medium mb-2" style="color: #374151;">CC:</label>
                                    <input type="email" id="composeCc" name="cc" value="${defaultCc}" multiple 
                                           class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:outline-none"
                                           style="border-color: #d1d5db; --tw-ring-color: #7fc97f;"
                                           placeholder="Add CC recipients (separate with commas)">
                                </div>
                                
                                <!-- BCC Field -->
                                <div>
                                    <label class="block text-sm font-medium mb-2" style="color: #374151;">BCC:</label>
                                    <input type="email" id="composeBcc" name="bcc" multiple 
                                           class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:outline-none"
                                           style="border-color: #d1d5db; --tw-ring-color: #7fc97f;"
                                           placeholder="Add BCC recipients (separate with commas)">
                                </div>
                                
                                <!-- Subject Field -->
                                <div>
                                    <label class="block text-sm font-medium mb-2" style="color: #374151;">Subject:</label>
                                    <input type="text" id="composeSubject" name="subject" value="${defaultSubject}" required 
                                           class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:outline-none"
                                           style="border-color: #d1d5db; --tw-ring-color: #7fc97f;"
                                           placeholder="Enter subject">
                                </div>
                                
                                <!-- Rich Text Editor -->
                                <div>
                                    <label class="block text-sm font-medium mb-2" style="color: #374151;">Message:</label>
                                    <!-- Toolbar -->
                                    <div class="border rounded-t-lg p-2 flex flex-wrap gap-1" style="border-color: #d1d5db; background-color: #f9fafb;">
                                        <!-- Text Formatting -->
                                        <div class="flex gap-1 pr-2 border-r" style="border-color: #d1d5db;">
                                            <button type="button" onclick="formatText('bold')" class="p-2 hover:bg-gray-200 rounded transition-colors" title="Bold">
                                                <i class="fas fa-bold"></i>
                                            </button>
                                            <button type="button" onclick="formatText('italic')" class="p-2 hover:bg-gray-200 rounded transition-colors" title="Italic">
                                                <i class="fas fa-italic"></i>
                                            </button>
                                            <button type="button" onclick="formatText('underline')" class="p-2 hover:bg-gray-200 rounded transition-colors" title="Underline">
                                                <i class="fas fa-underline"></i>
                                            </button>
                                            <button type="button" onclick="formatText('strikeThrough')" class="p-2 hover:bg-gray-200 rounded transition-colors" title="Strikethrough">
                                                <i class="fas fa-strikethrough"></i>
                                            </button>
                                        </div>
                                        
                                        <!-- Lists -->
                                        <div class="flex gap-1 pr-2 border-r" style="border-color: #d1d5db;">
                                            <button type="button" onclick="formatText('insertUnorderedList')" class="p-2 hover:bg-gray-200 rounded transition-colors" title="Bullet List">
                                                <i class="fas fa-list-ul"></i>
                                            </button>
                                            <button type="button" onclick="formatText('insertOrderedList')" class="p-2 hover:bg-gray-200 rounded transition-colors" title="Numbered List">
                                                <i class="fas fa-list-ol"></i>
                                            </button>
                                        </div>
                                        
                                        <!-- Alignment -->
                                        <div class="flex gap-1 pr-2 border-r" style="border-color: #d1d5db;">
                                            <button type="button" onclick="formatText('justifyLeft')" class="p-2 hover:bg-gray-200 rounded transition-colors" title="Align Left">
                                                <i class="fas fa-align-left"></i>
                                            </button>
                                            <button type="button" onclick="formatText('justifyCenter')" class="p-2 hover:bg-gray-200 rounded transition-colors" title="Align Center">
                                                <i class="fas fa-align-center"></i>
                                            </button>
                                            <button type="button" onclick="formatText('justifyRight')" class="p-2 hover:bg-gray-200 rounded transition-colors" title="Align Right">
                                                <i class="fas fa-align-right"></i>
                                            </button>
                                        </div>
                                        
                                        <!-- Links -->
                                        <div class="flex gap-1 pr-2 border-r" style="border-color: #d1d5db;">
                                            <button type="button" onclick="insertLink()" class="p-2 hover:bg-gray-200 rounded transition-colors" title="Insert Link">
                                                <i class="fas fa-link"></i>
                                            </button>
                                            <button type="button" onclick="formatText('unlink')" class="p-2 hover:bg-gray-200 rounded transition-colors" title="Remove Link">
                                                <i class="fas fa-unlink"></i>
                                            </button>
                                        </div>
                                        
                                        <!-- Undo/Redo -->
                                        <div class="flex gap-1">
                                            <button type="button" onclick="formatText('undo')" class="p-2 hover:bg-gray-200 rounded transition-colors" title="Undo">
                                                <i class="fas fa-undo"></i>
                                            </button>
                                            <button type="button" onclick="formatText('redo')" class="p-2 hover:bg-gray-200 rounded transition-colors" title="Redo">
                                                <i class="fas fa-redo"></i>
                                            </button>
                                        </div>
                                    </div>
                                    
                                    <!-- Editor Content Area -->
                                    <div id="composeBody" contenteditable="true" 
                                         class="w-full min-h-[300px] px-4 py-3 border border-t-0 rounded-b-lg focus:ring-2 focus:outline-none"
                                         style="border-color: #d1d5db; outline: none; --tw-ring-color: #7fc97f; min-height: 300px;">${defaultBody}</div>
                                </div>
                                
                                <!-- Attachments -->
                                <div>
                                    <label class="block text-sm font-medium mb-2" style="color: #374151;">Attachments:</label>
                                    <div class="border-2 border-dashed rounded-lg p-4" style="border-color: #d1d5db;">
                                        <input type="file" id="fileInput" multiple style="display: none;" onchange="handleFileSelect(event)">
                                        <button type="button" onclick="document.getElementById('fileInput').click()" 
                                                class="px-4 py-2 bg-gray-100 hover:bg-gray-200 rounded-lg transition-colors" style="color: #374151;">
                                            <i class="fas fa-paperclip mr-2"></i>
                                            Attach Files
                                        </button>
                                        <span class="ml-3 text-sm" style="color: #6b7280;">Maximum file size: 25MB</span>
                                        <div id="attachmentsList" class="mt-3 space-y-2"></div>
                                    </div>
                                </div>
                            </form>
                        </div>
                        
                        <!-- Modal Footer -->
                        <div class="flex items-center justify-between p-6 border-t" style="border-color: #e5e7eb; background-color: #f9fafb;">
                            <button onclick="closeComposeModal()" class="px-5 py-2.5 hover:text-gray-900 transition-colors" style="color: #374151;">
                                Cancel
                            </button>
                            <div class="flex gap-3">
                                <button onclick="saveDraft()" class="px-5 py-2.5 bg-gray-200 hover:bg-gray-300 rounded-lg transition-colors" style="color: #374151;">
                                    <i class="fas fa-save mr-2"></i>
                                    Save Draft
                                </button>
                                <button onclick="sendEmailEnhanced()" class="px-5 py-2.5 text-white rounded-lg transition-colors" style="background-color: #7fc97f;" onmouseover="this.style.backgroundColor='#6db56d'" onmouseout="this.style.backgroundColor='#7fc97f'">
                                    <i class="fas fa-paper-plane mr-2"></i>
                                    Send
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Remove any existing modal first
            const existingModal = document.getElementById('compose-modal');
            if (existingModal) {
                existingModal.remove();
            }
            
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            
            // Initialize the compose modal
            initializeComposeModal();
        }
        
        function closeComposeModal() {
            const modal = document.getElementById('compose-modal');
            if (modal) {
                modal.remove();
                window.currentAttachments = [];
                window.currentDraftId = null;
                currentComposeHuddleId = null; // Reset huddle context
            }
        }
        
        function initializeComposeModal() {
            const editor = document.getElementById('composeBody');
            if (editor) {
                editor.focus();
                // Set up paste handling for rich text
                editor.addEventListener('paste', function(e) {
                    e.preventDefault();
                    const text = e.clipboardData.getData('text/html') || e.clipboardData.getData('text/plain');
                    document.execCommand('insertHTML', false, text);
                });
            }
        }
        
        // Rich Text Editor Functions
        function formatText(command, value = null) {
            document.execCommand(command, false, value);
            document.getElementById('composeBody').focus();
        }
        
        function insertLink() {
            const url = prompt('Enter the URL:');
            if (url) {
                formatText('createLink', url);
            }
        }
        
        // File Attachment Functions
        function handleFileSelect(event) {
            const files = Array.from(event.target.files);
            const attachmentsList = document.getElementById('attachmentsList');
            
            files.forEach(file => {
                if (file.size > 25 * 1024 * 1024) { // 25MB limit
                    showNotification(`File "${file.name}" is too large. Maximum size is 25MB.`, 'error');
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    const attachment = {
                        id: Date.now() + Math.random(),
                        name: file.name,
                        size: file.size,
                        type: file.type,
                        data: e.target.result.split(',')[1] // Base64 data
                    };
                    
                    window.currentAttachments.push(attachment);
                    
                    // Display attachment
                    const attachmentHtml = `
                        <div class="flex items-center justify-between p-2 bg-gray-50 rounded" data-attachment-id="${attachment.id}">
                            <div class="flex items-center">
                                <i class="fas fa-file mr-2" style="color: #6b7280;"></i>
                                <span class="text-sm" style="color: #374151;">${attachment.name}</span>
                                <span class="text-xs ml-2" style="color: #9ca3af;">(${formatFileSize(attachment.size)})</span>
                            </div>
                            <button type="button" onclick="removeAttachment(${attachment.id})" class="text-red-500 hover:text-red-700">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    `;
                    
                    attachmentsList.insertAdjacentHTML('beforeend', attachmentHtml);
                };
                reader.readAsDataURL(file);
            });
            
            // Reset file input
            event.target.value = '';
        }
        
        function removeAttachment(attachmentId) {
            window.currentAttachments = window.currentAttachments.filter(a => a.id !== attachmentId);
            const attachmentElement = document.querySelector(`[data-attachment-id="${attachmentId}"]`);
            if (attachmentElement) {
                attachmentElement.remove();
            }
        }
        
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
        }
        
        async function sendEmail(event) {
            // This function is kept for backward compatibility with the simple email compose
            if (event) event.preventDefault();
            
            const to = document.getElementById('compose-to')?.value || document.getElementById('composeTo')?.value;
            const subject = document.getElementById('compose-subject')?.value || document.getElementById('composeSubject')?.value;
            const body = document.getElementById('compose-body')?.value || document.getElementById('composeBody')?.innerHTML;
            
            if (!to || !subject || !body) {
                alert('Please fill in all required fields');
                return;
            }
            
            try {
                const response = await fetch('/api/emails/compose', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        to: [to],
                        subject: subject,
                        body: body
                    })
                });
                
                if (response.ok) {
                    closeComposeModal();
                    await loadEmails();
                    showNotification('Email sent successfully!', 'success');
                } else {
                    const error = await response.json();
                    showNotification(error.detail || 'Failed to send email', 'error');
                }
            } catch (error) {
                console.error('Error sending email:', error);
                showNotification('Failed to send email', 'error');
            }
        }
        
        async function sendEmailEnhanced() {
            const form = document.getElementById('composeForm');
            const formData = new FormData(form);
            
            // Get rich text content
            const richTextEditor = document.getElementById('composeBody');
            const htmlContent = richTextEditor.innerHTML;
            
            const emailData = {
                to: formData.get('to').split(',').map(e => e.trim()).filter(e => e),
                cc: formData.get('cc') ? formData.get('cc').split(',').map(e => e.trim()).filter(e => e) : [],
                bcc: formData.get('bcc') ? formData.get('bcc').split(',').map(e => e.trim()).filter(e => e) : [],
                subject: formData.get('subject'),
                body: htmlContent,
                attachments: window.currentAttachments || []
            };
            
            // Add huddle_id if composing to a huddle
            if (currentComposeHuddleId) {
                emailData.huddle_id = currentComposeHuddleId;
            }
            
            if (!emailData.to.length || !emailData.subject || !emailData.body) {
                showNotification('Please fill in all required fields', 'error');
                return;
            }
            
            try {
                const response = await fetch('/api/emails/compose', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(emailData)
                });
                
                if (response.ok) {
                    closeComposeModal();
                    await loadEmails();
                    showNotification('Email sent successfully!', 'success');
                } else {
                    const error = await response.json();
                    showNotification(error.detail || 'Failed to send email', 'error');
                }
            } catch (error) {
                console.error('Error sending email:', error);
                showNotification('Failed to send email', 'error');
            }
        }
        
        async function saveDraft() {
            const form = document.getElementById('composeForm');
            const formData = new FormData(form);
            
            // Get rich text content
            const richTextEditor = document.getElementById('composeBody');
            const htmlContent = richTextEditor.innerHTML;
            
            const draftData = {
                to: formData.get('to').split(',').map(e => e.trim()).filter(e => e),
                cc: formData.get('cc') ? formData.get('cc').split(',').map(e => e.trim()).filter(e => e) : [],
                bcc: formData.get('bcc') ? formData.get('bcc').split(',').map(e => e.trim()).filter(e => e) : [],
                subject: formData.get('subject'),
                body: htmlContent,
                attachments: window.currentAttachments || []
            };
            
            try {
                const response = await fetch('/api/emails/drafts', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(draftData)
                });
                
                if (response.ok) {
                    const result = await response.json();
                    window.currentDraftId = result.id;
                    showNotification('Draft saved successfully!', 'success');
                } else {
                    showNotification('Failed to save draft', 'error');
                }
            } catch (error) {
                console.error('Error saving draft:', error);
                showNotification('Failed to save draft', 'error');
            }
        }
        
        // AI Summary functionality
        let aiSummaryCache = {};
        
        async function toggleAISummary(emailId) {
            const contentEl = document.getElementById(`ai-summary-content-${emailId}`);
            const arrowEl = document.getElementById(`ai-summary-arrow-${emailId}`);
            
            if (!contentEl || !arrowEl) return;
            
            if (contentEl.classList.contains('hidden')) {
                // Show summary
                contentEl.classList.remove('hidden');
                arrowEl.classList.add('rotate-180');
                
                // Generate summary if not cached
                if (!aiSummaryCache[emailId]) {
                    await generateAISummary(emailId);
                }
            } else {
                // Hide summary
                contentEl.classList.add('hidden');
                arrowEl.classList.remove('rotate-180');
            }
        }
        
        async function generateAISummary(emailId) {
            const contentEl = document.getElementById(`ai-summary-content-${emailId}`);
            if (!contentEl) return;
            
            // Show loading state
            contentEl.innerHTML = `
                <div class="text-center text-gray-500">
                    <i class="fas fa-spinner fa-spin"></i>
                    <span class="ml-2">Generating AI summary...</span>
                </div>
            `;
            
            try {
                const response = await fetch(`/api/emails/${emailId}/summary`, {
                    method: 'POST',
                    headers: authToken !== 'session' ? {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    } : {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include'
                });
                
                if (response.ok) {
                    const data = await response.json();
                    aiSummaryCache[emailId] = data;
                    
                    // Display the summary
                    contentEl.innerHTML = data.content || '<p class="text-gray-500">No summary available</p>';
                    
                    // Add urgency indicator if high
                    if (data.summary && data.summary.urgency === 'High') {
                        contentEl.innerHTML = `
                            <div class="bg-red-50 border border-red-200 text-red-700 px-3 py-2 rounded-lg mb-3 text-sm">
                                <i class="fas fa-exclamation-triangle mr-2"></i>
                                <strong>High Priority Email</strong>
                            </div>
                            ${data.content}
                        `;
                    }
                } else {
                    throw new Error('Failed to generate summary');
                }
            } catch (error) {
                console.error('Error generating AI summary:', error);
                contentEl.innerHTML = `
                    <div class="text-red-500 text-center">
                        <i class="fas fa-exclamation-circle"></i>
                        <p class="text-sm mt-2">Failed to generate summary. Please try again.</p>
                    </div>
                `;
            }
        }
        
        // Email Reply Functions
        function replyToEmail(emailId) {
            const email = emails.find(e => e.id === emailId);
            if (!email) return;
            showComposeModal('reply', email);
        }
        
        function replyAllToEmail(emailId) {
            const email = emails.find(e => e.id === emailId);
            if (!email) return;
            showComposeModal('reply_all', email);
        }
        
        function forwardEmail(emailId) {
            const email = emails.find(e => e.id === emailId);
            if (!email) return;
            showComposeModal('forward', email);
        }
        
        function showReplyModal(emailId) {
            // Backward compatibility function
            replyToEmail(emailId);
        }
        
        // SAIG Reply Functions
        function replySaig(emailId) {
            // Show SAIG Reply modal
            showSAIGReplyModal(emailId);
        }
        
        function showSAIGReplyModal(emailId) {
            // Get the email data
            const email = emails.find(e => e.id === emailId);
            if (!email) {
                showNotification('Email not found', 'error');
                return;
            }
            
            // Create modal
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
            modal.id = 'saigReplyModal';
            
            modal.innerHTML = `
                <div class="bg-white rounded-xl shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-hidden">
                    <div class="gradient-bg p-6 text-white">
                        <div class="flex justify-between items-center">
                            <h2 class="text-2xl font-bold flex items-center">
                                <i class="fas fa-leaf mr-3"></i>
                                SAIG Smart Reply
                            </h2>
                            <button onclick="closeSAIGReplyModal()" class="text-white hover:text-gray-200 transition-colors">
                                <i class="fas fa-times text-xl"></i>
                            </button>
                        </div>
                    </div>
                    
                    <div class="p-6 overflow-y-auto" style="max-height: calc(90vh - 100px);">
                        <div class="mb-4 p-4 bg-gray-50 rounded-lg">
                            <p class="text-sm text-gray-600 mb-2">Original Email:</p>
                            <p class="font-semibold">${email.subject}</p>
                            <p class="text-sm text-gray-500 mt-1">From: ${email.sender}</p>
                        </div>
                        
                        
                        <!-- Loading state -->
                        <div id="saigLoadingState" class="mb-4 text-center py-8">
                            <i class="fas fa-spinner fa-spin text-4xl text-green-600 mb-4"></i>
                            <p class="text-gray-600">SAIG is analyzing the email and generating a smart reply...</p>
                        </div>
                        
                        <!-- Draft Preview (hidden initially) -->
                        <div id="saigReplyPreview" class="hidden mb-4">
                            <div class="bg-gradient-to-r from-green-50 to-blue-50 p-4 rounded-lg border border-green-200">
                                <h3 class="font-semibold text-gray-800 mb-4 flex items-center">
                                    <i class="fas fa-envelope-open-text mr-2 text-green-600"></i>
                                    SAIG's Draft Reply
                                </h3>
                                
                                <!-- Email Fields -->
                                <div class="space-y-3 mb-4">
                                    <div class="bg-white p-3 rounded border border-gray-200">
                                        <label class="text-xs font-semibold text-gray-600 uppercase tracking-wider">To:</label>
                                        <div id="saigReplyTo" class="mt-1 text-gray-800"></div>
                                    </div>
                                    
                                    <div class="bg-white p-3 rounded border border-gray-200">
                                        <label class="text-xs font-semibold text-gray-600 uppercase tracking-wider">Subject:</label>
                                        <div id="saigReplySubject" class="mt-1 text-gray-800"></div>
                                    </div>
                                    
                                    <div class="bg-white p-3 rounded border border-gray-200">
                                        <label class="text-xs font-semibold text-gray-600 uppercase tracking-wider">Message:</label>
                                        <div id="saigReplyBody" class="mt-2 text-gray-800 whitespace-pre-wrap" style="max-height: 300px; overflow-y: auto;"></div>
                                    </div>
                                </div>
                                
                                <!-- Action Buttons -->
                                <div class="flex justify-end space-x-3 pt-4 border-t border-green-200">
                                    <button 
                                        id="editSAIGReplyBtn"
                                        onclick="editSAIGReply('${emailId}')" 
                                        class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors flex items-center"
                                    >
                                        <i class="fas fa-edit mr-2"></i>Edit in Compose
                                    </button>
                                    <button 
                                        id="regenerateSAIGReplyBtn"
                                        onclick="generateSAIGReply('${emailId}')" 
                                        class="px-4 py-2 bg-gray-600 hover:bg-gray-700 text-white rounded-lg transition-colors flex items-center"
                                    >
                                        <i class="fas fa-redo mr-2"></i>Regenerate
                                    </button>
                                    <button 
                                        id="sendSAIGReplyBtn"
                                        onclick="sendSAIGReply('${emailId}')" 
                                        class="px-4 py-2 gradient-bg hover:opacity-90 text-white rounded-lg transition-all flex items-center"
                                    >
                                        <i class="fas fa-paper-plane mr-2"></i>Send Reply
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Auto-generate the reply after modal opens
            setTimeout(() => {
                generateSAIGReply(emailId);
            }, 100);
        }
        
        function closeSAIGReplyModal() {
            const modal = document.getElementById('saigReplyModal');
            if (modal) {
                modal.remove();
                // Clear stored reply data
                window.saigGeneratedReply = null;
                window.saigReplyTo = null;
                window.saigReplySubject = null;
            }
        }
        
        function editSAIGReply(emailId) {
            // Get the generated reply data
            if (!window.saigGeneratedReply || !window.saigReplyTo || !window.saigReplySubject) {
                showNotification('No reply generated yet', 'warning');
                return;
            }
            
            // Store the data before closing modal
            const saigTo = window.saigReplyTo;
            const saigSubject = window.saigReplySubject;
            const saigBody = window.saigGeneratedReply;
            
            // Close SAIG modal
            closeSAIGReplyModal();
            
            // Get the original email for context
            const email = emails.find(e => e.id === emailId);
            if (!email) return;
            
            // Open compose modal in reply mode
            showComposeModal('reply', email);
            
            // After modal opens, populate with SAIG's generated content
            // Need longer delay to ensure modal is fully rendered
            setTimeout(() => {
                // Set the fields with SAIG's generated content
                const toField = document.getElementById('composeTo');
                const subjectField = document.getElementById('composeSubject');
                const bodyField = document.getElementById('composeBody');
                
                console.log('Setting SAIG fields:', { saigTo, saigSubject, saigBody }); // Debug log
                
                if (toField) {
                    toField.value = saigTo;
                    console.log('Set To field:', saigTo);
                }
                if (subjectField) {
                    subjectField.value = saigSubject;
                    console.log('Set Subject field:', saigSubject);
                }
                if (bodyField) {
                    // Clear existing content first, then set new content
                    bodyField.innerHTML = '';
                    // Replace newlines with <br> and preserve the formatting
                    const formattedBody = saigBody.replace(/\n/g, '<br>');
                    bodyField.innerHTML = formattedBody;
                    console.log('Set Body field:', formattedBody);
                }
                
                // Show notification
                showNotification('SAIG reply loaded in compose window', 'success');
            }, 300);
        }
        
        async function generateSAIGReply(emailId) {
            const previewDiv = document.getElementById('saigReplyPreview');
            const loadingState = document.getElementById('saigLoadingState');
            
            // Hide preview and show loading state
            if (previewDiv) previewDiv.classList.add('hidden');
            if (loadingState) {
                loadingState.classList.remove('hidden');
                loadingState.innerHTML = `
                    <div class="text-center py-8">
                        <i class="fas fa-spinner fa-spin text-4xl text-green-600 mb-4"></i>
                        <p class="text-gray-600">SAIG is analyzing the email and generating a smart reply...</p>
                    </div>
                `;
            }
            
            try {
                // Get the email data
                const email = emails.find(e => e.id === emailId);
                if (!email) {
                    throw new Error('Email not found');
                }
                
                // Build the message for SAIG
                let message = `Please read this email and generate an appropriate, professional reply.
                
Email Details:
From: ${email.sender}
Subject: ${email.subject}
Content: ${email.body_text || email.snippet}

Generate a thoughtful and contextually appropriate response that:
1. Acknowledges the sender's message
2. Addresses any questions or requests
3. Maintains a professional tone
4. Includes a proper greeting and closing`;
                
                // Send message to SAIG for reply generation
                const response = await fetch('/api/saig/chat', {
                    method: 'POST',
                    headers: authToken !== 'session' ? {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    } : {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include',
                    body: JSON.stringify({
                        message: message,
                        context: { 
                            email_id: emailId,
                            selected_email: {
                                id: email.id,
                                gmail_id: email.gmail_id,
                                thread_id: email.thread_id,
                                subject: email.subject,
                                sender: email.sender,
                                sender_name: email.sender_name,
                                body: email.body_text || email.body_html || email.snippet,
                                received_at: email.received_at
                            }
                        }
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`Failed to generate reply: ${response.statusText}`);
                }
                
                const result = await response.json();
                
                // Parse the response to extract email components
                // (email variable already declared at the beginning of the function)
                // Extract just the email address from sender field (remove name if present)
                let replyTo = email.sender;
                if (replyTo.includes('<')) {
                    // Extract email from "Name <email@example.com>" format
                    const match = replyTo.match(/<([^>]+)>/);
                    if (match) {
                        replyTo = match[1];
                    }
                }
                let replySubject = email.subject.startsWith('Re:') ? email.subject : `Re: ${email.subject}`;
                let replyBody = result.response;
                
                // Extract clean text from HTML response if needed
                if (result.response.includes('<div')) {
                    // Extract just the reply text from the HTML
                    const tempDiv = document.createElement('div');
                    tempDiv.innerHTML = result.response;
                    const replyContent = tempDiv.querySelector('.whitespace-pre-wrap');
                    if (replyContent) {
                        replyBody = replyContent.textContent;
                    }
                }
                
                // Store the generated reply components
                window.saigGeneratedReply = replyBody;
                window.saigReplyTo = replyTo;
                window.saigReplySubject = replySubject;
                
                // Hide loading state
                document.getElementById('saigLoadingState').classList.add('hidden');
                
                // Show the preview
                previewDiv.classList.remove('hidden');
                
                // Populate the preview fields
                document.getElementById('saigReplyTo').textContent = replyTo;
                document.getElementById('saigReplySubject').textContent = replySubject;
                document.getElementById('saigReplyBody').textContent = replyBody;
                
                showNotification('SAIG has analyzed the email and generated a smart reply!', 'success');
                
            } catch (error) {
                console.error('Error generating SAIG reply:', error);
                showNotification(error.message || 'Failed to generate reply', 'error');
                
                // Hide loading state and show error
                const loadingState = document.getElementById('saigLoadingState');
                if (loadingState) {
                    loadingState.innerHTML = `
                        <div class="text-center py-8">
                            <i class="fas fa-exclamation-circle text-4xl text-red-500 mb-4"></i>
                            <p class="text-gray-600">Failed to generate reply. Please try again.</p>
                            <button onclick="generateSAIGReply('${emailId}')" class="mt-4 px-4 py-2 gradient-bg text-white rounded-lg hover:opacity-90">
                                <i class="fas fa-redo mr-2"></i>Try Again
                            </button>
                        </div>
                    `;
                }
            }
        }
        
        async function sendSAIGReply(emailId) {
            if (!window.saigGeneratedReply) {
                showNotification('Please generate a reply first', 'warning');
                return;
            }
            
            const email = emails.find(e => e.id === emailId);
            if (!email) {
                showNotification('Email not found', 'error');
                return;
            }
            
            const sendBtn = document.getElementById('sendSAIGReplyBtn');
            
            // Show loading state
            sendBtn.disabled = true;
            sendBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Sending...';
            
            try {
                // Send the reply using the reply endpoint to maintain thread context
                const response = await fetch('/api/emails/reply', {
                    method: 'POST',
                    headers: authToken !== 'session' ? {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    } : {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include',
                    body: JSON.stringify({
                        email_id: emailId,
                        body: window.saigGeneratedReply,
                        reply_all: false
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`Failed to send reply: ${response.statusText}`);
                }
                
                const result = await response.json();
                
                showNotification('Reply sent successfully!', 'success');
                closeSAIGReplyModal();
                
                // Refresh email list
                await loadEmails();
                
            } catch (error) {
                console.error('Error sending SAIG reply:', error);
                showNotification(error.message || 'Failed to send reply', 'error');
                sendBtn.innerHTML = '<i class="fas fa-paper-plane mr-2"></i>Send Reply';
                sendBtn.disabled = false;
            }
        }
        
        // SAIG Email Draft Functions
        function editDraft(recipient, subject, body) {
            // Show compose modal first
            showComposeModal();
            
            // Then fill with draft data after modal is shown
            setTimeout(() => {
                const toField = document.getElementById('composeTo');
                const subjectField = document.getElementById('composeSubject');
                const bodyField = document.getElementById('composeBody');
                
                if (toField) toField.value = recipient;
                if (subjectField) subjectField.value = subject;
                if (bodyField) {
                    // For contenteditable div, use innerHTML
                    bodyField.innerHTML = body.replace(/\n/g, '<br>');
                }
            }, 100);
        }
        
        async function sendDraftEmail(recipient, subject, body) {
            try {
                // Close any open compose modal first
                const composeModal = document.getElementById('composeModal');
                if (composeModal) {
                    composeModal.classList.add('hidden');
                }
                
                // Show sending status in SAIG chat
                addChatMessage('📤 Sending email...', 'assistant');
                
                const response = await fetch('/api/emails/compose', {
                    method: 'POST',
                    headers: authToken !== 'session' ? {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    } : {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include',
                    body: JSON.stringify({
                        to: [recipient],
                        subject: subject,
                        body: body
                    })
                });
                
                if (response.ok) {
                    // Success confirmation in SAIG chat
                    addChatMessage(`✅ Email sent successfully to ${recipient}!\n\n📧 Subject: "${subject}"\n\nThe email has been delivered and will appear in your sent folder.`, 'assistant');
                    
                    // Clear the email draft from chat if it exists
                    const draftElements = document.querySelectorAll('.bg-gray-50.border-l-4.border-blue-400');
                    draftElements.forEach(el => {
                        if (el.textContent.includes(subject)) {
                            el.parentElement.remove();
                        }
                    });
                    
                    await loadEmails();
                    showNotification('Email sent successfully!', 'success');
                } else {
                    const error = await response.json();
                    addChatMessage(`❌ Failed to send email: ${error.detail || 'Unknown error'}\n\nPlease try again or edit the draft.`, 'assistant');
                    showNotification('Failed to send email', 'error');
                }
            } catch (error) {
                console.error('Error sending draft email:', error);
                addChatMessage('❌ Failed to send email due to connection error. Please check your connection and try again.', 'assistant');
                showNotification('Failed to send email', 'error');
            }
        }
        
        // Utility Functions
        function formatDate(dateString) {
            if (!dateString) return '';
            
            // Parse the date string - if it doesn't end with 'Z' or timezone offset, assume it's UTC
            let date;
            if (typeof dateString === 'string') {
                if (!dateString.endsWith('Z') && !dateString.match(/[+-]\d{2}:\d{2}$/)) {
                    // Add 'Z' to indicate UTC if no timezone specified
                    date = new Date(dateString + 'Z');
                } else {
                    date = new Date(dateString);
                }
            } else {
                date = new Date(dateString);
            }
            
            // Check if date is valid
            if (isNaN(date.getTime())) {
                console.warn('Invalid date:', dateString);
                return dateString; // Return original string if parsing failed
            }
            
            const now = new Date();
            const diff = now - date;
            const days = Math.floor(diff / (1000 * 60 * 60 * 24));
            
            // Use local timezone for display - let browser handle timezone conversion
            const timeStr = date.toLocaleTimeString('en-US', { 
                hour: 'numeric', 
                minute: '2-digit', 
                hour12: true
                // Don't specify timezone - let it use local automatically
            });
            
            if (days === 0) {
                // For today, just show the time
                return timeStr;
            } else if (days === 1) {
                return `Yesterday`;
            } else if (days < 7) {
                const dayStr = date.toLocaleDateString('en-US', { 
                    weekday: 'short'
                    // Let browser use local timezone automatically
                });
                return `${dayStr}, ${timeStr}`;
            } else if (date.getFullYear() === now.getFullYear()) {
                // Same year - show month, day, and time
                const dateStr = date.toLocaleDateString('en-US', { 
                    month: 'short', 
                    day: 'numeric'
                    // Let browser use local timezone automatically
                });
                return `${dateStr}, ${timeStr}`;
            } else {
                // Different year - show full date with time
                const dateStr = date.toLocaleDateString('en-US', { 
                    month: 'short', 
                    day: 'numeric', 
                    year: 'numeric'
                    // Let browser use local timezone automatically
                });
                return `${dateStr}, ${timeStr}`;
            }
        }
        
        function updateUnreadCount() {
            const unreadCount = emails.filter(e => !e.is_read).length;
            const unreadElement = document.getElementById('unread-count');
            if (unreadElement) {
                unreadElement.textContent = unreadCount;
            }
        }
        
        function showLoader(id) {
            document.getElementById(id).classList.remove('hidden');
        }
        
        function hideLoader(id) {
            document.getElementById(id).classList.add('hidden');
        }
        
        function startAutoSync() {
            // Auto-sync every 60 seconds when in inbox view
            setInterval(async () => {
                if (currentView === 'inbox' && !document.hidden) {
                    console.log('Auto-syncing emails...');
                    try {
                        const response = await fetch('/api/emails/sync', {
                            method: 'POST',
                            headers: authToken !== 'session' ? {
                                'Authorization': `Bearer ${authToken}`
                            } : {},
                            credentials: 'include'
                        });
                        
                        if (response.ok) {
                            const result = await response.json();
                            if (result.emails_synced > 0) {
                                console.log(`Auto-sync: ${result.emails_synced} new emails`);
                                const syncStatus = document.getElementById('sync-status');
                                if (syncStatus) {
                                    syncStatus.textContent = `Auto-synced: ${new Date().toLocaleTimeString()}`;
                                }
                                // Reload emails to show new ones
                                await loadEmails();
                                showNotification(`${result.emails_synced} new emails synced`, 'info');
                            }
                        }
                    } catch (error) {
                        console.error('Auto-sync error:', error);
                    }
                }
            }, 60000); // Sync every 60 seconds
        }
        
        async function logout() {
            try {
                // Call logout endpoint to clear session cookies
                await fetch('/api/auth/logout', {
                    method: 'POST',
                    credentials: 'include'
                });
            } catch (error) {
                console.error('Logout error:', error);
            }
            
            // Clear local storage
            localStorage.removeItem('authToken');
            
            // Redirect to login page
            window.location.href = '/login';
        }
        
        // Additional functions for complete functionality
        async function completeAction(actionId) {
            try {
                const response = await fetch(`/api/actions/${actionId}/complete`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                
                if (response.ok) {
                    loadActionItems();
                }
            } catch (error) {
                console.error('Error completing action:', error);
            }
        }
        
        async function deleteAction(actionId) {
            if (!confirm('Delete this action item?')) return;
            
            try {
                const response = await fetch(`/api/actions/${actionId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                
                if (response.ok) {
                    loadActionItems();
                }
            } catch (error) {
                console.error('Error deleting action:', error);
            }
        }
        
        async function viewTrashedEmail(emailId) {
            try {
                // Find the email in the trashedEmails array
                const email = trashedEmails.find(e => e.id === emailId);
                if (!email) {
                    console.error('Email not found in trash');
                    return;
                }
                
                // Use the existing viewEmail function to display the email
                // Create a modal to display the email content
                const modal = document.createElement('div');
                modal.className = 'modal fade show';
                modal.style.display = 'block';
                modal.style.backgroundColor = 'rgba(0,0,0,0.5)';
                
                modal.innerHTML = `
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">${email.subject || 'No Subject'}</h5>
                                <button type="button" class="btn-close" onclick="this.closest('.modal').remove()"></button>
                            </div>
                            <div class="modal-body">
                                <div class="mb-3">
                                    <strong>From:</strong> ${email.sender || 'Unknown Sender'}<br>
                                    <strong>Date:</strong> ${new Date(email.received_at).toLocaleString()}<br>
                                    ${email.recipients && email.recipients.length > 0 ? `<strong>To:</strong> ${email.recipients.join(', ')}<br>` : ''}
                                </div>
                                <hr>
                                <div style="white-space: pre-wrap; word-wrap: break-word;">
                                    ${email.body_text || email.snippet || 'No content available'}
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-success" onclick="restoreEmail('${emailId}'); this.closest('.modal').remove()">
                                    <i class="fas fa-undo"></i> Restore
                                </button>
                                <button type="button" class="btn btn-danger" onclick="permanentlyDelete('${emailId}'); this.closest('.modal').remove()">
                                    <i class="fas fa-trash"></i> Delete Permanently
                                </button>
                                <button type="button" class="btn btn-secondary" onclick="this.closest('.modal').remove()">Close</button>
                            </div>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
                
                // Close modal when clicking outside
                modal.addEventListener('click', function(e) {
                    if (e.target === modal) {
                        modal.remove();
                    }
                });
                
            } catch (error) {
                console.error('Error viewing trashed email:', error);
                showNotification('Error viewing email', 'error');
            }
        }
        
        async function restoreEmail(emailId) {
            try {
                const response = await fetch(`/api/trash/${emailId}/restore`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                
                if (response.ok) {
                    loadTrash();
                }
            } catch (error) {
                console.error('Error restoring email:', error);
            }
        }
        
        async function permanentlyDelete(emailId) {
            if (!confirm('Permanently delete this email? This cannot be undone.')) return;
            
            try {
                const response = await fetch(`/api/trash/${emailId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                
                if (response.ok) {
                    loadTrash();
                }
            } catch (error) {
                console.error('Error deleting email:', error);
            }
        }
        
        // Bulk trash operations
        function selectAllTrashEmails() {
            const selectAll = document.getElementById('trash-select-all');
            const checkboxes = document.querySelectorAll('.trash-email-checkbox');
            
            checkboxes.forEach(checkbox => {
                checkbox.checked = selectAll.checked;
            });
            
            updateTrashSelection();
        }
        
        function updateTrashSelection() {
            const checkboxes = document.querySelectorAll('.trash-email-checkbox');
            const checkedBoxes = document.querySelectorAll('.trash-email-checkbox:checked');
            const selectAll = document.getElementById('trash-select-all');
            const selectionCount = document.getElementById('trash-selection-count');
            const bulkActions = document.getElementById('trash-bulk-actions');
            
            // Update select all checkbox state
            if (selectAll) {
                selectAll.checked = checkboxes.length > 0 && checkboxes.length === checkedBoxes.length;
                selectAll.indeterminate = checkedBoxes.length > 0 && checkedBoxes.length < checkboxes.length;
            }
            
            // Show/hide bulk actions
            if (bulkActions) {
                bulkActions.style.display = checkedBoxes.length > 0 ? 'flex' : 'none';
            }
            
            // Update selection count
            if (selectionCount) {
                selectionCount.textContent = checkedBoxes.length > 0 ? `${checkedBoxes.length} selected` : '';
            }
        }
        
        async function bulkRestoreEmails() {
            const checkedBoxes = document.querySelectorAll('.trash-email-checkbox:checked');
            const emailIds = Array.from(checkedBoxes).map(cb => cb.dataset.emailId);
            
            if (emailIds.length === 0) {
                showNotification('No emails selected', 'warning');
                return;
            }
            
            if (!confirm(`Restore ${emailIds.length} email(s)?`)) return;
            
            let successCount = 0;
            let failCount = 0;
            
            for (const emailId of emailIds) {
                try {
                    const response = await fetch(`/api/trash/${emailId}/restore`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${authToken}`
                        }
                    });
                    
                    if (response.ok) {
                        successCount++;
                    } else {
                        failCount++;
                    }
                } catch (error) {
                    console.error('Error restoring email:', error);
                    failCount++;
                }
            }
            
            if (successCount > 0) {
                showNotification(`Restored ${successCount} email(s)${failCount > 0 ? `, ${failCount} failed` : ''}`, 'success');
                loadTrash();
            } else {
                showNotification('Failed to restore emails', 'error');
            }
        }
        
        async function bulkDeleteEmails() {
            const checkedBoxes = document.querySelectorAll('.trash-email-checkbox:checked');
            const emailIds = Array.from(checkedBoxes).map(cb => cb.dataset.emailId);
            
            if (emailIds.length === 0) {
                showNotification('No emails selected', 'warning');
                return;
            }
            
            if (!confirm(`Permanently delete ${emailIds.length} email(s)? This cannot be undone.`)) return;
            
            let successCount = 0;
            let failCount = 0;
            
            for (const emailId of emailIds) {
                try {
                    const response = await fetch(`/api/trash/${emailId}`, {
                        method: 'DELETE',
                        headers: {
                            'Authorization': `Bearer ${authToken}`
                        }
                    });
                    
                    if (response.ok) {
                        successCount++;
                    } else {
                        failCount++;
                    }
                } catch (error) {
                    console.error('Error deleting email:', error);
                    failCount++;
                }
            }
            
            if (successCount > 0) {
                showNotification(`Deleted ${successCount} email(s)${failCount > 0 ? `, ${failCount} failed` : ''}`, 'success');
                loadTrash();
            } else {
                showNotification('Failed to delete emails', 'error');
            }
        }
        
        async function emptyTrash() {
            if (!confirm('Empty all trash? This cannot be undone.')) return;
            
            try {
                const response = await fetch('/api/trash/empty', {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                
                if (response.ok) {
                    loadTrash();
                }
            } catch (error) {
                console.error('Error emptying trash:', error);
            }
        }
        
        // Action Modal Functions
        let currentActionEmailId = null;
        
        function showCreateActionModal(emailId = null) {
            currentActionEmailId = emailId;
            const modal = document.getElementById('action-modal');
            
            // If linked to an email, show the link
            if (emailId) {
                const email = emails.find(e => e.id === emailId);
                if (email) {
                    document.getElementById('action-email-link').classList.remove('hidden');
                    document.getElementById('linked-email-subject').textContent = email.subject || '(No subject)';
                    document.getElementById('action-title').value = `Follow up: ${email.subject}`;
                }
            } else {
                document.getElementById('action-email-link').classList.add('hidden');
                document.getElementById('action-title').value = '';
            }
            
            // Reset other fields
            document.getElementById('action-description').value = '';
            document.getElementById('action-priority').value = '2';
            document.getElementById('action-due-date').value = '';
            
            modal.classList.remove('hidden');
            document.getElementById('action-title').focus();
        }
        
        function closeActionModal() {
            document.getElementById('action-modal').classList.add('hidden');
            currentActionEmailId = null;
        }
        
        async function saveActionItem() {
            const title = document.getElementById('action-title').value.trim();
            const description = document.getElementById('action-description').value.trim();
            const priority = parseInt(document.getElementById('action-priority').value);
            const dueDate = document.getElementById('action-due-date').value;
            
            if (!title) {
                showNotification('Please enter a title for the action item', 'error');
                return;
            }
            
            try {
                const body = {
                    title: title,
                    description: description,
                    priority: priority,
                    email_id: currentActionEmailId
                };
                
                if (dueDate) {
                    body.due_date = new Date(dueDate).toISOString();
                }
                
                const response = await fetch('/api/actions', {
                    method: 'POST',
                    headers: authToken !== 'session' ? {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    } : {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include',
                    body: JSON.stringify(body)
                });
                
                if (response.ok) {
                    closeActionModal();
                    if (currentView === 'actions') {
                        loadActionItems();
                    }
                    showNotification('Action item created successfully', 'success');
                }
            } catch (error) {
                console.error('Error creating action item:', error);
                showNotification('Failed to create action item', 'error');
            }
        }
        
        function createActionFromEmail(emailId) {
            showCreateActionModal(emailId);
        }
        
        // Backward compatibility
        async function createActionItem(title, emailId = null) {
            currentActionEmailId = emailId;
            document.getElementById('action-title').value = title;
            showCreateActionModal(emailId);
        }
        
        // Huddle Modal Functions
        let huddle_members = [];
        
        function showCreateHuddleModal() {
            huddle_members = [];
            document.getElementById('huddle-name').value = '';
            document.getElementById('huddle-description').value = '';
            document.getElementById('huddle-member-input').value = '';
            document.getElementById('huddle-members-list').innerHTML = '';
            document.getElementById('huddle-modal').classList.remove('hidden');
            document.getElementById('huddle-name').focus();
        }
        
        function closeHuddleModal() {
            document.getElementById('huddle-modal').classList.add('hidden');
            huddle_members = [];
        }
        
        function addHuddleMember() {
            const input = document.getElementById('huddle-member-input');
            const email = input.value.trim();
            
            if (email && email.includes('@')) {
                if (!huddle_members.includes(email)) {
                    huddle_members.push(email);
                    updateHuddleMembersList();
                    input.value = '';
                } else {
                    showNotification('Member already added', 'error');
                }
            } else {
                showNotification('Please enter a valid email address', 'error');
            }
        }
        
        function removeHuddleMember(email) {
            huddle_members = huddle_members.filter(m => m !== email);
            updateHuddleMembersList();
        }
        
        function updateHuddleMembersList() {
            const listEl = document.getElementById('huddle-members-list');
            if (huddle_members.length === 0) {
                listEl.innerHTML = '<p class="text-sm text-gray-500 italic">No members added yet</p>';
            } else {
                listEl.innerHTML = huddle_members.map(email => `
                    <div class="flex items-center justify-between bg-gray-50 px-2 py-1 rounded">
                        <span class="text-sm">${email}</span>
                        <button onclick="removeHuddleMember('${email}')" class="text-red-500 hover:text-red-700">
                            <i class="fas fa-times text-xs"></i>
                        </button>
                    </div>
                `).join('');
            }
        }
        
        async function saveHuddle() {
            const name = document.getElementById('huddle-name').value.trim();
            const description = document.getElementById('huddle-description').value.trim();
            
            if (!name) {
                showNotification('Please enter a huddle name', 'error');
                return;
            }
            
            try {
                const response = await fetch('/api/huddles', {
                    method: 'POST',
                    headers: authToken !== 'session' ? {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    } : {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include',
                    body: JSON.stringify({
                        name: name,
                        description: description,
                        member_emails: huddle_members
                    })
                });
                
                if (response.ok) {
                    const newHuddle = await response.json();
                    closeHuddleModal();
                    showNotification('Huddle created successfully', 'success');
                    // Always load huddles after creation to ensure UI is updated
                    await loadHuddles();
                } else {
                    const error = await response.json();
                    showNotification(error.detail || 'Failed to create huddle', 'error');
                }
            } catch (error) {
                console.error('Error creating huddle:', error);
                showNotification('Failed to create huddle', 'error');
            }
        }
        
        // Load huddles when switching to huddles view
        async function loadHuddles(includeArchived = false) {
            try {
                const url = includeArchived ? '/api/huddles?include_archived=true' : '/api/huddles';
                const response = await fetch(url, {
                    headers: authToken !== 'session' ? {
                        'Authorization': `Bearer ${authToken}`
                    } : {},
                    credentials: 'include'
                });
                
                if (response.ok) {
                    const huddles = await response.json();
                    console.log('Loaded huddles:', huddles); // Debug log
                    renderHuddles(huddles);
                }
            } catch (error) {
                console.error('Error loading huddles:', error);
            }
        }
        
        function toggleArchivedHuddles() {
            const showArchived = document.getElementById('show-archived-huddles').checked;
            loadHuddles(showArchived);
        }
        
        function renderHuddles(huddles) {
            const huddlesView = document.getElementById('huddles-view');
            if (!huddlesView) {
                console.error('Huddles view not found');
                return;
            }
            
            // Find the huddle list container within the huddles view
            const huddleListContainer = document.getElementById('huddle-list');
            if (!huddleListContainer) {
                console.error('Huddle list container not found');
                return;
            }
            
            if (huddles.length === 0) {
                huddleListContainer.innerHTML = `
                    <div class="text-center py-12 col-span-2">
                        <i class="fas fa-users text-6xl text-gray-300 mb-4"></i>
                        <p class="text-gray-500">No huddles yet</p>
                        <button onclick="showCreateHuddleModal()" class="mt-4 gradient-bg text-white px-4 py-2 rounded-lg hover:opacity-90">
                            <i class="fas fa-plus mr-2"></i>Create Your First Huddle
                        </button>
                    </div>
                `;
            } else {
                huddleListContainer.innerHTML = huddles.map(huddle => `
                    <div class="bg-white rounded-lg shadow-sm hover:shadow-md transition-shadow cursor-pointer p-4 mb-3 ${huddle.is_archived ? 'opacity-75' : ''}" onclick="openHuddle('${huddle.id}')">
                        <div class="flex items-center justify-between">
                            <div>
                                <div class="flex items-center space-x-2">
                                    <h3 class="font-semibold text-gray-900">${huddle.name}</h3>
                                    ${huddle.is_archived ? '<span class="text-xs bg-yellow-100 text-yellow-800 px-2 py-1 rounded">Archived</span>' : ''}
                                </div>
                                <p class="text-sm text-gray-600">${huddle.description || 'No description'}</p>
                                <p class="text-xs text-gray-500 mt-1">
                                    <i class="fas fa-users mr-1"></i>${huddle.members ? huddle.members.length : 0} members • 
                                    Created ${new Date(huddle.created_at).toLocaleDateString()}
                                </p>
                            </div>
                            <div class="flex items-center space-x-2">
                                ${huddle.is_archived ? 
                                    `<button onclick="event.stopPropagation(); restoreHuddle('${huddle.id}')" class="text-green-600 hover:text-green-700 text-sm" title="Restore">
                                        <i class="fas fa-undo"></i>
                                    </button>` : ''}
                                <i class="fas fa-chevron-right text-gray-400"></i>
                            </div>
                        </div>
                    </div>
                `).join('');
            }
        }
        
        let currentHuddleId = null;
        let currentHuddle = null;
        
        async function openHuddle(huddleId) {
            currentHuddleId = huddleId;
            
            try {
                // Fetch huddle details
                const response = await fetch(`/api/huddles/${huddleId}`, {
                    headers: authToken !== 'session' ? {
                        'Authorization': `Bearer ${authToken}`
                    } : {},
                    credentials: 'include'
                });
                
                if (response.ok) {
                    currentHuddle = await response.json();
                    
                    // Update modal header
                    document.getElementById('huddle-detail-name').textContent = currentHuddle.name;
                    document.getElementById('huddle-detail-description').textContent = currentHuddle.description || 'No description';
                    
                    // Display members
                    displayHuddleMembers(currentHuddle.members || []);
                    
                    // Load email chain
                    loadHuddleEmails(huddleId);
                    
                    // Show modal
                    document.getElementById('huddle-detail-modal').classList.remove('hidden');
                } else {
                    showNotification('Failed to load huddle details', 'error');
                }
            } catch (error) {
                console.error('Error opening huddle:', error);
                showNotification('Error loading huddle', 'error');
            }
        }
        
        function displayHuddleMembers(members) {
            const membersContainer = document.getElementById('huddle-members-detail');
            
            if (!members || members.length === 0) {
                membersContainer.innerHTML = '<p class="text-gray-500 text-sm">No members yet</p>';
            } else {
                membersContainer.innerHTML = members.map(member => {
                    // Handle both string emails and member objects
                    const memberEmail = typeof member === 'string' ? member : (member.email || member);
                    const memberName = typeof member === 'object' ? (member.name || member.email) : member;
                    const firstChar = memberEmail && memberEmail.length > 0 ? memberEmail.charAt(0).toUpperCase() : '?';
                    
                    return `
                    <div class="flex items-center justify-between p-2 bg-gray-50 rounded hover:bg-gray-100">
                        <div class="flex items-center">
                            <div class="w-8 h-8 bg-green-500 rounded-full flex items-center justify-center text-white text-sm font-bold mr-2">
                                ${firstChar}
                            </div>
                            <span class="text-sm text-gray-700">${memberName}</span>
                        </div>
                        <button onclick="removeMemberFromHuddle('${memberEmail}')" class="text-red-500 hover:text-red-700 text-sm">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    `;
                }).join('');
            }
        }
        
        async function loadHuddleEmails(huddleId) {
            const emailsContainer = document.getElementById('huddle-emails-list');
            emailsContainer.innerHTML = '<div class="text-center py-4"><i class="fas fa-spinner fa-spin text-gray-400"></i> Loading emails...</div>';
            
            try {
                // For now, search for emails that might be related to this huddle
                // by looking for the huddle name in the subject
                if (currentHuddle && currentHuddle.name) {
                    // Search emails with huddle name in subject
                    const searchQuery = `[${currentHuddle.name}]`;
                    const response = await fetch(`/api/emails/?search=${encodeURIComponent(searchQuery)}&limit=20`, {
                        headers: authToken !== 'session' ? {
                            'Authorization': `Bearer ${authToken}`
                        } : {},
                        credentials: 'include'
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        const emails = data.emails || [];
                        
                        if (emails.length === 0) {
                            emailsContainer.innerHTML = '<p class="text-gray-500 text-center py-8">No emails in this huddle yet</p>';
                        } else {
                            emailsContainer.innerHTML = emails.map(email => {
                                // Escape HTML to prevent XSS
                                const escapeHtml = (str) => {
                                    if (!str) return '';
                                    const div = document.createElement('div');
                                    div.textContent = str;
                                    return div.innerHTML;
                                };
                                
                                return `
                                <div class="bg-white p-3 rounded border hover:shadow-sm cursor-pointer" onclick="selectEmail('${escapeHtml(email.id)}')">
                                    <div class="flex justify-between items-start mb-1">
                                        <span class="font-medium text-sm">${escapeHtml(email.sender_name || email.sender)}</span>
                                        <span class="text-xs text-gray-500">${formatDate(email.received_at)}</span>
                                    </div>
                                    <div class="text-sm font-medium text-gray-800">${escapeHtml(email.subject || '(No subject)')}</div>
                                    <div class="text-xs text-gray-600 mt-1 truncate">${escapeHtml(email.snippet || '')}</div>
                                </div>
                                `;
                            }).join('');
                        }
                    } else {
                        emailsContainer.innerHTML = '<p class="text-gray-500 text-center py-8">No emails in this huddle yet</p>';
                    }
                } else {
                    emailsContainer.innerHTML = '<p class="text-gray-500 text-center py-8">No emails in this huddle yet</p>';
                }
            } catch (error) {
                console.error('Error loading huddle emails:', error);
                // Show graceful error message instead of error state
                emailsContainer.innerHTML = '<p class="text-gray-500 text-center py-8">No emails in this huddle yet</p>';
            }
        }
        
        function closeHuddleDetail() {
            document.getElementById('huddle-detail-modal').classList.add('hidden');
            currentHuddleId = null;
            currentHuddle = null;
        }
        
        function composeToHuddle() {
            if (!currentHuddle) return;
            
            // Close huddle detail modal
            closeHuddleDetail();
            
            // Open compose modal with huddle information pre-filled
            showComposeModal({
                to: currentHuddle.members || [],
                subject: `[${currentHuddle.name}] `,
                huddle_id: currentHuddleId,
                huddle_name: currentHuddle.name
            });
        }
        
        async function addMemberToHuddle() {
            if (!currentHuddleId) return;
            
            const email = prompt('Enter member email address:');
            if (!email || !email.includes('@')) return;
            
            try {
                const response = await fetch(`/api/huddles/${currentHuddleId}/members`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        ...(authToken !== 'session' ? { 'Authorization': `Bearer ${authToken}` } : {})
                    },
                    credentials: 'include',
                    body: JSON.stringify({ email: email })
                });
                
                if (response.ok) {
                    // Reload huddle to get updated members
                    openHuddle(currentHuddleId);
                    showNotification('Member added successfully', 'success');
                } else {
                    showNotification('Failed to add member', 'error');
                }
            } catch (error) {
                console.error('Error adding member:', error);
                showNotification('Error adding member', 'error');
            }
        }
        
        async function removeMemberFromHuddle(memberEmail) {
            if (!currentHuddleId || !confirm(`Remove ${memberEmail} from huddle?`)) return;
            
            try {
                const response = await fetch(`/api/huddles/${currentHuddleId}/members/${encodeURIComponent(memberEmail)}`, {
                    method: 'DELETE',
                    headers: authToken !== 'session' ? {
                        'Authorization': `Bearer ${authToken}`
                    } : {},
                    credentials: 'include'
                });
                
                if (response.ok) {
                    // Reload huddle to get updated members
                    openHuddle(currentHuddleId);
                    showNotification('Member removed', 'success');
                } else {
                    showNotification('Failed to remove member', 'error');
                }
            } catch (error) {
                console.error('Error removing member:', error);
                showNotification('Error removing member', 'error');
            }
        }
        
        async function deleteHuddle() {
            if (!currentHuddleId) return;
            
            const huddleName = currentHuddle ? currentHuddle.name : 'this huddle';
            if (!confirm(`Are you sure you want to permanently delete "${huddleName}"? This action cannot be undone.`)) {
                return;
            }
            
            try {
                const response = await fetch(`/api/huddles/${currentHuddleId}`, {
                    method: 'DELETE',
                    headers: authToken !== 'session' ? {
                        'Authorization': `Bearer ${authToken}`
                    } : {},
                    credentials: 'include'
                });
                
                if (response.ok) {
                    showNotification('Huddle deleted successfully', 'success');
                    closeHuddleDetail();
                    // Reload huddles list
                    if (currentView === 'huddles') {
                        loadHuddles();
                    }
                } else {
                    const error = await response.json();
                    showNotification(error.detail || 'Failed to delete huddle', 'error');
                }
            } catch (error) {
                console.error('Error deleting huddle:', error);
                showNotification('Error deleting huddle', 'error');
            }
        }
        
        async function archiveHuddle() {
            if (!currentHuddleId) return;
            
            const huddleName = currentHuddle ? currentHuddle.name : 'this huddle';
            if (!confirm(`Archive "${huddleName}"? You can restore it later from archived huddles.`)) {
                return;
            }
            
            try {
                const response = await fetch(`/api/huddles/${currentHuddleId}/archive`, {
                    method: 'POST',
                    headers: authToken !== 'session' ? {
                        'Authorization': `Bearer ${authToken}`
                    } : {},
                    credentials: 'include'
                });
                
                if (response.ok) {
                    showNotification('Huddle archived successfully', 'success');
                    closeHuddleDetail();
                    // Reload huddles list
                    if (currentView === 'huddles') {
                        loadHuddles();
                    }
                } else {
                    const error = await response.json();
                    showNotification(error.detail || 'Failed to archive huddle', 'error');
                }
            } catch (error) {
                console.error('Error archiving huddle:', error);
                showNotification('Error archiving huddle', 'error');
            }
        }
        
        async function restoreHuddle(huddleId) {
            try {
                const response = await fetch(`/api/huddles/${huddleId}/restore`, {
                    method: 'POST',
                    headers: authToken !== 'session' ? {
                        'Authorization': `Bearer ${authToken}`
                    } : {},
                    credentials: 'include'
                });
                
                if (response.ok) {
                    showNotification('Huddle restored successfully', 'success');
                    loadHuddles();
                } else {
                    showNotification('Failed to restore huddle', 'error');
                }
            } catch (error) {
                console.error('Error restoring huddle:', error);
                showNotification('Error restoring huddle', 'error');
            }
        }
        
        function showReplyModal(emailId) {
            const email = emails.find(e => e.id === emailId);
            if (email) {
                const reply = prompt('Your reply:');
                if (reply) {
                    replyToEmail(emailId, reply);
                }
            }
        }
        
        async function replyToEmail(emailId, body) {
            try {
                const response = await fetch('/api/emails/reply', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        email_id: emailId,
                        body: body,
                        reply_all: false
                    })
                });
                
                if (response.ok) {
                    alert('Reply sent!');
                }
            } catch (error) {
                console.error('Error sending reply:', error);
            }
        }
    </script>
</body>
</html>